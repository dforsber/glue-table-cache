"use strict";var bt=Object.create;var te=Object.defineProperty;var Ct=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames;var _t=Object.getPrototypeOf,Tt=Object.prototype.hasOwnProperty;var P=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),At=(r,e)=>{for(var t in e)te(r,t,{get:e[t],enumerable:!0})},$e=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of wt(e))!Tt.call(r,s)&&s!==t&&te(r,s,{get:()=>e[s],enumerable:!(i=Ct(e,s))||i.enumerable});return r};var Z=(r,e,t)=>(t=r!=null?bt(_t(r)):{},$e(e||!r||!r.__esModule?te(t,"default",{value:r,enumerable:!0}):t,r)),xt=r=>$e(te({},"__esModule",{value:!0}),r);var qe=P((Or,je)=>{var W=1e3,H=W*60,Q=H*60,q=Q*24,St=q*7,vt=q*365.25;je.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Rt(r);if(t==="number"&&isFinite(r))return e.long?It(r):Ft(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Rt(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),i=(e[2]||"ms").toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return t*vt;case"weeks":case"week":case"w":return t*St;case"days":case"day":case"d":return t*q;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Q;case"minutes":case"minute":case"mins":case"min":case"m":return t*H;case"seconds":case"second":case"secs":case"sec":case"s":return t*W;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Ft(r){var e=Math.abs(r);return e>=q?Math.round(r/q)+"d":e>=Q?Math.round(r/Q)+"h":e>=H?Math.round(r/H)+"m":e>=W?Math.round(r/W)+"s":r+"ms"}function It(r){var e=Math.abs(r);return e>=q?ie(r,e,q,"day"):e>=Q?ie(r,e,Q,"hour"):e>=H?ie(r,e,H,"minute"):e>=W?ie(r,e,W,"second"):r+" ms"}function ie(r,e,t,i){var s=e>=t*1.5;return Math.round(r/t)+" "+i+(s?"s":"")}});var me=P((Sr,Be)=>{function Pt(r){t.debug=t,t.default=t,t.coerce=l,t.disable=o,t.enable=s,t.enabled=a,t.humanize=qe(),t.destroy=u,Object.keys(r).forEach(c=>{t[c]=r[c]}),t.names=[],t.skips=[],t.formatters={};function e(c){let h=0;for(let d=0;d<c.length;d++)h=(h<<5)-h+c.charCodeAt(d),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(c){let h,d=null,f,m;function p(...b){if(!p.enabled)return;let g=p,y=Number(new Date),I=y-(h||y);g.diff=I,g.prev=h,g.curr=y,h=y,b[0]=t.coerce(b[0]),typeof b[0]!="string"&&b.unshift("%O");let w=0;b[0]=b[0].replace(/%([a-zA-Z%])/g,(D,L)=>{if(D==="%%")return"%";w++;let j=t.formatters[L];if(typeof j=="function"){let Y=b[w];D=j.call(g,Y),b.splice(w,1),w--}return D}),t.formatArgs.call(g,b),(g.log||t.log).apply(g,b)}return p.namespace=c,p.useColors=t.useColors(),p.color=t.selectColor(c),p.extend=i,p.destroy=t.destroy,Object.defineProperty(p,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(f!==t.namespaces&&(f=t.namespaces,m=t.enabled(c)),m),set:b=>{d=b}}),typeof t.init=="function"&&t.init(p),p}function i(c,h){let d=t(this.namespace+(typeof h>"u"?":":h)+c);return d.log=this.log,d}function s(c){t.save(c),t.namespaces=c,t.names=[],t.skips=[];let h=(typeof c=="string"?c:"").trim().replace(" ",",").split(",").filter(Boolean);for(let d of h)d[0]==="-"?t.skips.push(d.slice(1)):t.names.push(d)}function n(c,h){let d=0,f=0,m=-1,p=0;for(;d<c.length;)if(f<h.length&&(h[f]===c[d]||h[f]==="*"))h[f]==="*"?(m=f,p=d,f++):(d++,f++);else if(m!==-1)f=m+1,p++,d=p;else return!1;for(;f<h.length&&h[f]==="*";)f++;return f===h.length}function o(){let c=[...t.names,...t.skips.map(h=>"-"+h)].join(",");return t.enable(""),c}function a(c){for(let h of t.skips)if(n(c,h))return!1;for(let h of t.names)if(n(c,h))return!0;return!1}function l(c){return c instanceof Error?c.stack||c.message:c}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Be.exports=Pt});var Ge=P((v,se)=>{v.formatArgs=Dt;v.save=$t;v.load=Mt;v.useColors=Lt;v.storage=Nt();v.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();v.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Lt(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Dt(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+se.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,i=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(i=t))}),r.splice(i,0,e)}v.log=console.debug||console.log||(()=>{});function $t(r){try{r?v.storage.setItem("debug",r):v.storage.removeItem("debug")}catch{}}function Mt(){let r;try{r=v.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function Nt(){try{return localStorage}catch{}}se.exports=me()(v);var{formatters:kt}=se.exports;kt.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Ve=P((vr,ze)=>{"use strict";ze.exports=(r,e=process.argv)=>{let t=r.startsWith("-")?"":r.length===1?"-":"--",i=e.indexOf(t+r),s=e.indexOf("--");return i!==-1&&(s===-1||i<s)}});var Qe=P((Rr,He)=>{"use strict";var Ut=require("os"),We=require("tty"),R=Ve(),{env:T}=process,N;R("no-color")||R("no-colors")||R("color=false")||R("color=never")?N=0:(R("color")||R("colors")||R("color=true")||R("color=always"))&&(N=1);"FORCE_COLOR"in T&&(T.FORCE_COLOR==="true"?N=1:T.FORCE_COLOR==="false"?N=0:N=T.FORCE_COLOR.length===0?1:Math.min(parseInt(T.FORCE_COLOR,10),3));function ye(r){return r===0?!1:{level:r,hasBasic:!0,has256:r>=2,has16m:r>=3}}function Ee(r,e){if(N===0)return 0;if(R("color=16m")||R("color=full")||R("color=truecolor"))return 3;if(R("color=256"))return 2;if(r&&!e&&N===void 0)return 0;let t=N||0;if(T.TERM==="dumb")return t;if(process.platform==="win32"){let i=Ut.release().split(".");return Number(i[0])>=10&&Number(i[2])>=10586?Number(i[2])>=14931?3:2:1}if("CI"in T)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some(i=>i in T)||T.CI_NAME==="codeship"?1:t;if("TEAMCITY_VERSION"in T)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(T.TEAMCITY_VERSION)?1:0;if(T.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in T){let i=parseInt((T.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(T.TERM_PROGRAM){case"iTerm.app":return i>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(T.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(T.TERM)||"COLORTERM"in T?1:t}function jt(r){let e=Ee(r,r&&r.isTTY);return ye(e)}He.exports={supportsColor:jt,stdout:ye(Ee(!0,We.isatty(1))),stderr:ye(Ee(!0,We.isatty(2)))}});var Je=P((A,oe)=>{var qt=require("tty"),ne=require("util");A.init=Qt;A.log=Vt;A.formatArgs=Gt;A.save=Wt;A.load=Ht;A.useColors=Bt;A.destroy=ne.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");A.colors=[6,2,3,4,5,1];try{let r=Qe();r&&(r.stderr||r).level>=2&&(A.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch{}A.inspectOpts=Object.keys(process.env).filter(r=>/^debug_/i.test(r)).reduce((r,e)=>{let t=e.substring(6).toLowerCase().replace(/_([a-z])/g,(s,n)=>n.toUpperCase()),i=process.env[e];return/^(yes|on|true|enabled)$/i.test(i)?i=!0:/^(no|off|false|disabled)$/i.test(i)?i=!1:i==="null"?i=null:i=Number(i),r[t]=i,r},{});function Bt(){return"colors"in A.inspectOpts?!!A.inspectOpts.colors:qt.isatty(process.stderr.fd)}function Gt(r){let{namespace:e,useColors:t}=this;if(t){let i=this.color,s="\x1B[3"+(i<8?i:"8;5;"+i),n=`  ${s};1m${e} \x1B[0m`;r[0]=n+r[0].split(`
`).join(`
`+n),r.push(s+"m+"+oe.exports.humanize(this.diff)+"\x1B[0m")}else r[0]=zt()+e+" "+r[0]}function zt(){return A.inspectOpts.hideDate?"":new Date().toISOString()+" "}function Vt(...r){return process.stderr.write(ne.formatWithOptions(A.inspectOpts,...r)+`
`)}function Wt(r){r?process.env.DEBUG=r:delete process.env.DEBUG}function Ht(){return process.env.DEBUG}function Qt(r){r.inspectOpts={};let e=Object.keys(A.inspectOpts);for(let t=0;t<e.length;t++)r.inspectOpts[e[t]]=A.inspectOpts[e[t]]}oe.exports=me()(A);var{formatters:Ke}=oe.exports;Ke.o=function(r){return this.inspectOpts.colors=this.useColors,ne.inspect(r,this.inspectOpts).split(`
`).map(e=>e.trim()).join(" ")};Ke.O=function(r){return this.inspectOpts.colors=this.useColors,ne.inspect(r,this.inspectOpts)}});var ae=P((Fr,be)=>{typeof process>"u"||process.type==="renderer"||process.browser===!0||process.__nwjs?be.exports=Ge():be.exports=Je()});var ht=P((ni,ct)=>{function F(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}ct.exports=F;F.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};F.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};F.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var i=this;return this._timer=setTimeout(function(){i._attempts++,i._operationTimeoutCb&&(i._timeout=setTimeout(function(){i._operationTimeoutCb(i._attempts)},i._operationTimeout),i._options.unref&&i._timeout.unref()),i._fn(i._attempts)},t),this._options.unref&&this._timer.unref(),!0};F.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};F.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};F.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};F.prototype.start=F.prototype.try;F.prototype.errors=function(){return this._errors};F.prototype.attempts=function(){return this._attempts};F.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,i=0;i<this._errors.length;i++){var s=this._errors[i],n=s.message,o=(r[n]||0)+1;r[n]=o,o>=t&&(e=s,t=o)}return e}});var ut=P(G=>{var yr=ht();G.operation=function(r){var e=G.timeouts(r);return new yr(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};G.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],s=0;s<e.retries;s++)i.push(this.createTimeout(s,e));return r&&r.forever&&!i.length&&i.push(this.createTimeout(s,e)),i.sort(function(n,o){return n-o}),i};G.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,i=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return i=Math.min(i,e.maxTimeout),i};G.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var i in r)typeof r[i]=="function"&&t.push(i)}for(var s=0;s<t.length;s++){var n=t[s],o=r[n];r[n]=function(l){var u=G.operation(e),c=Array.prototype.slice.call(arguments,1),h=c.pop();c.push(function(d){u.retry(d)||(d&&(arguments[0]=u.mainError()),h.apply(this,arguments))}),u.attempt(function(){l.apply(r,c)})}.bind(r,o),r[n].options=e}}});var dt=P((ai,ft)=>{ft.exports=ut()});var gt=P((li,pt)=>{var Er=dt();function br(r,e){function t(i,s){var n=e||{},o;"randomize"in n||(n.randomize=!0),o=Er.operation(n);function a(c){s(c||new Error("Aborted"))}function l(c,h){if(c.bail){a(c);return}o.retry(c)?n.onRetry&&n.onRetry(c,h):s(o.mainError())}function u(c){var h;try{h=r(a,c)}catch(d){l(d,c);return}Promise.resolve(h).then(i).catch(function(f){l(f,c)})}o.attempt(u)}return new Promise(t)}pt.exports=br});var Cr={};At(Cr,{GlueTableCache:()=>de});module.exports=xt(Cr);var mt=require("@aws-sdk/client-glue"),yt=require("@aws-sdk/client-s3");var z=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,Ne=new Set,pe=typeof process=="object"&&process?process:{},ke=(r,e,t,i)=>{typeof pe.emitWarning=="function"?pe.emitWarning(r,e,t,i):console.error(`[${t}] ${e}: ${r}`)},re=globalThis.AbortController,Me=globalThis.AbortSignal;if(typeof re>"u"){Me=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(i,s){this._onabort.push(s)}},re=class{constructor(){e()}signal=new Me;abort(i){if(!this.signal.aborted){this.signal.reason=i,this.signal.aborted=!0;for(let s of this.signal._onabort)s(i);this.signal.onabort?.(i)}}};let r=pe.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",e=()=>{r&&(r=!1,ke("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}var Ot=r=>!Ne.has(r),Ar=Symbol("type"),M=r=>r&&r===Math.floor(r)&&r>0&&isFinite(r),Ue=r=>M(r)?r<=Math.pow(2,8)?Uint8Array:r<=Math.pow(2,16)?Uint16Array:r<=Math.pow(2,32)?Uint32Array:r<=Number.MAX_SAFE_INTEGER?V:null:null,V=class extends Array{constructor(e){super(e),this.fill(0)}},ge=class r{heap;length;static#l=!1;static create(e){let t=Ue(e);if(!t)return[];r.#l=!0;let i=new r(e,t);return r.#l=!1,i}constructor(e,t){if(!r.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}},ee=class r{#l;#u;#g;#m;#F;#I;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#s;#y;#i;#r;#e;#c;#f;#a;#n;#E;#o;#b;#C;#d;#w;#O;#h;static unsafeExposeInternals(e){return{starts:e.#C,ttls:e.#d,sizes:e.#b,keyMap:e.#i,keyList:e.#r,valList:e.#e,next:e.#c,prev:e.#f,get head(){return e.#a},get tail(){return e.#n},free:e.#E,isBackgroundFetch:t=>e.#t(t),backgroundFetch:(t,i,s,n)=>e.#D(t,i,s,n),moveToTail:t=>e.#R(t),indexes:t=>e.#_(t),rindexes:t=>e.#T(t),isStale:t=>e.#p(t)}}get max(){return this.#l}get maxSize(){return this.#u}get calculatedSize(){return this.#y}get size(){return this.#s}get fetchMethod(){return this.#F}get memoMethod(){return this.#I}get dispose(){return this.#g}get disposeAfter(){return this.#m}constructor(e){let{max:t=0,ttl:i,ttlResolution:s=1,ttlAutopurge:n,updateAgeOnGet:o,updateAgeOnHas:a,allowStale:l,dispose:u,disposeAfter:c,noDisposeOnSet:h,noUpdateTTL:d,maxSize:f=0,maxEntrySize:m=0,sizeCalculation:p,fetchMethod:b,memoMethod:g,noDeleteOnFetchRejection:y,noDeleteOnStaleGet:I,allowStaleOnFetchRejection:w,allowStaleOnFetchAbort:S,ignoreFetchAbort:D}=e;if(t!==0&&!M(t))throw new TypeError("max option must be a nonnegative integer");let L=t?Ue(t):Array;if(!L)throw new Error("invalid max value: "+t);if(this.#l=t,this.#u=f,this.maxEntrySize=m||this.#u,this.sizeCalculation=p,this.sizeCalculation){if(!this.#u&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(g!==void 0&&typeof g!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#I=g,b!==void 0&&typeof b!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#F=b,this.#O=!!b,this.#i=new Map,this.#r=new Array(t).fill(void 0),this.#e=new Array(t).fill(void 0),this.#c=new L(t),this.#f=new L(t),this.#a=0,this.#n=0,this.#E=ge.create(t),this.#s=0,this.#y=0,typeof u=="function"&&(this.#g=u),typeof c=="function"?(this.#m=c,this.#o=[]):(this.#m=void 0,this.#o=void 0),this.#w=!!this.#g,this.#h=!!this.#m,this.noDisposeOnSet=!!h,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!y,this.allowStaleOnFetchRejection=!!w,this.allowStaleOnFetchAbort=!!S,this.ignoreFetchAbort=!!D,this.maxEntrySize!==0){if(this.#u!==0&&!M(this.#u))throw new TypeError("maxSize must be a positive integer if specified");if(!M(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#q()}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!I,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!a,this.ttlResolution=M(s)||s===0?s:1,this.ttlAutopurge=!!n,this.ttl=i||0,this.ttl){if(!M(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#$()}if(this.#l===0&&this.ttl===0&&this.#u===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#u){let j="LRU_CACHE_UNBOUNDED";Ot(j)&&(Ne.add(j),ke("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",j,r))}}getRemainingTTL(e){return this.#i.has(e)?1/0:0}#$(){let e=new V(this.#l),t=new V(this.#l);this.#d=e,this.#C=t,this.#M=(n,o,a=z.now())=>{if(t[n]=o!==0?a:0,e[n]=o,o!==0&&this.ttlAutopurge){let l=setTimeout(()=>{this.#p(n)&&this.#A(this.#r[n],"expire")},o+1);l.unref&&l.unref()}},this.#S=n=>{t[n]=e[n]!==0?z.now():0},this.#x=(n,o)=>{if(e[o]){let a=e[o],l=t[o];if(!a||!l)return;n.ttl=a,n.start=l,n.now=i||s();let u=n.now-l;n.remainingTTL=a-u}};let i=0,s=()=>{let n=z.now();if(this.ttlResolution>0){i=n;let o=setTimeout(()=>i=0,this.ttlResolution);o.unref&&o.unref()}return n};this.getRemainingTTL=n=>{let o=this.#i.get(n);if(o===void 0)return 0;let a=e[o],l=t[o];if(!a||!l)return 1/0;let u=(i||s())-l;return a-u},this.#p=n=>{let o=t[n],a=e[n];return!!a&&!!o&&(i||s())-o>a}}#S=()=>{};#x=()=>{};#M=()=>{};#p=()=>!1;#q(){let e=new V(this.#l);this.#y=0,this.#b=e,this.#v=t=>{this.#y-=e[t],e[t]=0},this.#N=(t,i,s,n)=>{if(this.#t(i))return 0;if(!M(s))if(n){if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(s=n(i,t),!M(s))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return s},this.#P=(t,i,s)=>{if(e[t]=i,this.#u){let n=this.#u-e[t];for(;this.#y>n;)this.#L(!0)}this.#y+=e[t],s&&(s.entrySize=i,s.totalCalculatedSize=this.#y)}}#v=e=>{};#P=(e,t,i)=>{};#N=(e,t,i,s)=>{if(i||s)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#_({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#n;!(!this.#k(t)||((e||!this.#p(t))&&(yield t),t===this.#a));)t=this.#f[t]}*#T({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#a;!(!this.#k(t)||((e||!this.#p(t))&&(yield t),t===this.#n));)t=this.#c[t]}#k(e){return e!==void 0&&this.#i.get(this.#r[e])===e}*entries(){for(let e of this.#_())this.#e[e]!==void 0&&this.#r[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#r[e],this.#e[e]])}*rentries(){for(let e of this.#T())this.#e[e]!==void 0&&this.#r[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#r[e],this.#e[e]])}*keys(){for(let e of this.#_()){let t=this.#r[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*rkeys(){for(let e of this.#T()){let t=this.#r[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*values(){for(let e of this.#_())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}*rvalues(){for(let e of this.#T())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let i of this.#_()){let s=this.#e[i],n=this.#t(s)?s.__staleWhileFetching:s;if(n!==void 0&&e(n,this.#r[i],this))return this.get(this.#r[i],t)}}forEach(e,t=this){for(let i of this.#_()){let s=this.#e[i],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#r[i],this)}}rforEach(e,t=this){for(let i of this.#T()){let s=this.#e[i],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#r[i],this)}}purgeStale(){let e=!1;for(let t of this.#T({allowStale:!0}))this.#p(t)&&(this.#A(this.#r[t],"expire"),e=!0);return e}info(e){let t=this.#i.get(e);if(t===void 0)return;let i=this.#e[t],s=this.#t(i)?i.__staleWhileFetching:i;if(s===void 0)return;let n={value:s};if(this.#d&&this.#C){let o=this.#d[t],a=this.#C[t];if(o&&a){let l=o-(z.now()-a);n.ttl=l,n.start=Date.now()}}return this.#b&&(n.size=this.#b[t]),n}dump(){let e=[];for(let t of this.#_({allowStale:!0})){let i=this.#r[t],s=this.#e[t],n=this.#t(s)?s.__staleWhileFetching:s;if(n===void 0||i===void 0)continue;let o={value:n};if(this.#d&&this.#C){o.ttl=this.#d[t];let a=z.now()-this.#C[t];o.start=Math.floor(Date.now()-a)}this.#b&&(o.size=this.#b[t]),e.unshift([i,o])}return e}load(e){this.clear();for(let[t,i]of e){if(i.start){let s=Date.now()-i.start;i.start=z.now()-s}this.set(t,i.value,i)}}set(e,t,i={}){if(t===void 0)return this.delete(e),this;let{ttl:s=this.ttl,start:n,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:l}=i,{noUpdateTTL:u=this.noUpdateTTL}=i,c=this.#N(e,t,i.size||0,a);if(this.maxEntrySize&&c>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.#A(e,"set"),this;let h=this.#s===0?void 0:this.#i.get(e);if(h===void 0)h=this.#s===0?this.#n:this.#E.length!==0?this.#E.pop():this.#s===this.#l?this.#L(!1):this.#s,this.#r[h]=e,this.#e[h]=t,this.#i.set(e,h),this.#c[this.#n]=h,this.#f[h]=this.#n,this.#n=h,this.#s++,this.#P(h,c,l),l&&(l.set="add"),u=!1;else{this.#R(h);let d=this.#e[h];if(t!==d){if(this.#O&&this.#t(d)){d.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:f}=d;f!==void 0&&!o&&(this.#w&&this.#g?.(f,e,"set"),this.#h&&this.#o?.push([f,e,"set"]))}else o||(this.#w&&this.#g?.(d,e,"set"),this.#h&&this.#o?.push([d,e,"set"]));if(this.#v(h),this.#P(h,c,l),this.#e[h]=t,l){l.set="replace";let f=d&&this.#t(d)?d.__staleWhileFetching:d;f!==void 0&&(l.oldValue=f)}}else l&&(l.set="update")}if(s!==0&&!this.#d&&this.#$(),this.#d&&(u||this.#M(h,s,n),l&&this.#x(l,h)),!o&&this.#h&&this.#o){let d=this.#o,f;for(;f=d?.shift();)this.#m?.(...f)}return this}pop(){try{for(;this.#s;){let e=this.#e[this.#a];if(this.#L(!0),this.#t(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#h&&this.#o){let e=this.#o,t;for(;t=e?.shift();)this.#m?.(...t)}}}#L(e){let t=this.#a,i=this.#r[t],s=this.#e[t];return this.#O&&this.#t(s)?s.__abortController.abort(new Error("evicted")):(this.#w||this.#h)&&(this.#w&&this.#g?.(s,i,"evict"),this.#h&&this.#o?.push([s,i,"evict"])),this.#v(t),e&&(this.#r[t]=void 0,this.#e[t]=void 0,this.#E.push(t)),this.#s===1?(this.#a=this.#n=0,this.#E.length=0):this.#a=this.#c[t],this.#i.delete(i),this.#s--,t}has(e,t={}){let{updateAgeOnHas:i=this.updateAgeOnHas,status:s}=t,n=this.#i.get(e);if(n!==void 0){let o=this.#e[n];if(this.#t(o)&&o.__staleWhileFetching===void 0)return!1;if(this.#p(n))s&&(s.has="stale",this.#x(s,n));else return i&&this.#S(n),s&&(s.has="hit",this.#x(s,n)),!0}else s&&(s.has="miss");return!1}peek(e,t={}){let{allowStale:i=this.allowStale}=t,s=this.#i.get(e);if(s===void 0||!i&&this.#p(s))return;let n=this.#e[s];return this.#t(n)?n.__staleWhileFetching:n}#D(e,t,i,s){let n=t===void 0?void 0:this.#e[t];if(this.#t(n))return n;let o=new re,{signal:a}=i;a?.addEventListener("abort",()=>o.abort(a.reason),{signal:o.signal});let l={signal:o.signal,options:i,context:s},u=(p,b=!1)=>{let{aborted:g}=o.signal,y=i.ignoreFetchAbort&&p!==void 0;if(i.status&&(g&&!b?(i.status.fetchAborted=!0,i.status.fetchError=o.signal.reason,y&&(i.status.fetchAbortIgnored=!0)):i.status.fetchResolved=!0),g&&!y&&!b)return h(o.signal.reason);let I=f;return this.#e[t]===f&&(p===void 0?I.__staleWhileFetching?this.#e[t]=I.__staleWhileFetching:this.#A(e,"fetch"):(i.status&&(i.status.fetchUpdated=!0),this.set(e,p,l.options))),p},c=p=>(i.status&&(i.status.fetchRejected=!0,i.status.fetchError=p),h(p)),h=p=>{let{aborted:b}=o.signal,g=b&&i.allowStaleOnFetchAbort,y=g||i.allowStaleOnFetchRejection,I=y||i.noDeleteOnFetchRejection,w=f;if(this.#e[t]===f&&(!I||w.__staleWhileFetching===void 0?this.#A(e,"fetch"):g||(this.#e[t]=w.__staleWhileFetching)),y)return i.status&&w.__staleWhileFetching!==void 0&&(i.status.returnedStale=!0),w.__staleWhileFetching;if(w.__returned===w)throw p},d=(p,b)=>{let g=this.#F?.(e,n,l);g&&g instanceof Promise&&g.then(y=>p(y===void 0?void 0:y),b),o.signal.addEventListener("abort",()=>{(!i.ignoreFetchAbort||i.allowStaleOnFetchAbort)&&(p(void 0),i.allowStaleOnFetchAbort&&(p=y=>u(y,!0)))})};i.status&&(i.status.fetchDispatched=!0);let f=new Promise(d).then(u,c),m=Object.assign(f,{__abortController:o,__staleWhileFetching:n,__returned:void 0});return t===void 0?(this.set(e,m,{...l.options,status:void 0}),t=this.#i.get(e)):this.#e[t]=m,m}#t(e){if(!this.#O)return!1;let t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof re}async fetch(e,t={}){let{allowStale:i=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:l=0,sizeCalculation:u=this.sizeCalculation,noUpdateTTL:c=this.noUpdateTTL,noDeleteOnFetchRejection:h=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:d=this.allowStaleOnFetchRejection,ignoreFetchAbort:f=this.ignoreFetchAbort,allowStaleOnFetchAbort:m=this.allowStaleOnFetchAbort,context:p,forceRefresh:b=!1,status:g,signal:y}=t;if(!this.#O)return g&&(g.fetch="get"),this.get(e,{allowStale:i,updateAgeOnGet:s,noDeleteOnStaleGet:n,status:g});let I={allowStale:i,updateAgeOnGet:s,noDeleteOnStaleGet:n,ttl:o,noDisposeOnSet:a,size:l,sizeCalculation:u,noUpdateTTL:c,noDeleteOnFetchRejection:h,allowStaleOnFetchRejection:d,allowStaleOnFetchAbort:m,ignoreFetchAbort:f,status:g,signal:y},w=this.#i.get(e);if(w===void 0){g&&(g.fetch="miss");let S=this.#D(e,w,I,p);return S.__returned=S}else{let S=this.#e[w];if(this.#t(S)){let De=i&&S.__staleWhileFetching!==void 0;return g&&(g.fetch="inflight",De&&(g.returnedStale=!0)),De?S.__staleWhileFetching:S.__returned=S}let D=this.#p(w);if(!b&&!D)return g&&(g.fetch="hit"),this.#R(w),s&&this.#S(w),g&&this.#x(g,w),S;let L=this.#D(e,w,I,p),Y=L.__staleWhileFetching!==void 0&&i;return g&&(g.fetch=D?"stale":"refresh",Y&&D&&(g.returnedStale=!0)),Y?L.__staleWhileFetching:L.__returned=L}}async forceFetch(e,t={}){let i=await this.fetch(e,t);if(i===void 0)throw new Error("fetch() returned undefined");return i}memo(e,t={}){let i=this.#I;if(!i)throw new Error("no memoMethod provided to constructor");let{context:s,forceRefresh:n,...o}=t,a=this.get(e,o);if(!n&&a!==void 0)return a;let l=i(e,a,{options:o,context:s});return this.set(e,l,o),l}get(e,t={}){let{allowStale:i=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:o}=t,a=this.#i.get(e);if(a!==void 0){let l=this.#e[a],u=this.#t(l);return o&&this.#x(o,a),this.#p(a)?(o&&(o.get="stale"),u?(o&&i&&l.__staleWhileFetching!==void 0&&(o.returnedStale=!0),i?l.__staleWhileFetching:void 0):(n||this.#A(e,"expire"),o&&i&&(o.returnedStale=!0),i?l:void 0)):(o&&(o.get="hit"),u?l.__staleWhileFetching:(this.#R(a),s&&this.#S(a),l))}else o&&(o.get="miss")}#U(e,t){this.#f[t]=e,this.#c[e]=t}#R(e){e!==this.#n&&(e===this.#a?this.#a=this.#c[e]:this.#U(this.#f[e],this.#c[e]),this.#U(this.#n,e),this.#n=e)}delete(e){return this.#A(e,"delete")}#A(e,t){let i=!1;if(this.#s!==0){let s=this.#i.get(e);if(s!==void 0)if(i=!0,this.#s===1)this.#j(t);else{this.#v(s);let n=this.#e[s];if(this.#t(n)?n.__abortController.abort(new Error("deleted")):(this.#w||this.#h)&&(this.#w&&this.#g?.(n,e,t),this.#h&&this.#o?.push([n,e,t])),this.#i.delete(e),this.#r[s]=void 0,this.#e[s]=void 0,s===this.#n)this.#n=this.#f[s];else if(s===this.#a)this.#a=this.#c[s];else{let o=this.#f[s];this.#c[o]=this.#c[s];let a=this.#c[s];this.#f[a]=this.#f[s]}this.#s--,this.#E.push(s)}}if(this.#h&&this.#o?.length){let s=this.#o,n;for(;n=s?.shift();)this.#m?.(...n)}return i}clear(){return this.#j("delete")}#j(e){for(let t of this.#T({allowStale:!0})){let i=this.#e[t];if(this.#t(i))i.__abortController.abort(new Error("deleted"));else{let s=this.#r[t];this.#w&&this.#g?.(i,s,e),this.#h&&this.#o?.push([i,s,e])}}if(this.#i.clear(),this.#e.fill(void 0),this.#r.fill(void 0),this.#d&&this.#C&&(this.#d.fill(0),this.#C.fill(0)),this.#b&&this.#b.fill(0),this.#a=0,this.#n=0,this.#E.length=0,this.#y=0,this.#s=0,this.#h&&this.#o){let t=this.#o,i;for(;i=t?.shift();)this.#m?.(...i)}}};var Et=require("@duckdb/node-api"),Le=Z(ae(),1);var Oe=Z(ae(),1);var Ye=Z(require("vm"),1),we=class{add(e,t,i){if(typeof arguments[0]!="string")for(let s in arguments[0])this.add(s,arguments[0][s],arguments[1]);else(Array.isArray(e)?e:[e]).forEach(function(s){this[s]=this[s]||[],t&&this[s][i?"unshift":"push"](t)},this)}run(e,t){this[e]=this[e]||[],this[e].forEach(function(i){i.call(t&&t.context?t.context:t,t)})}},_e=class{constructor(e){this.jsep=e,this.registered={}}register(...e){e.forEach(t=>{if(typeof t!="object"||!t.name||!t.init)throw new Error("Invalid JSEP plugin format");this.registered[t.name]||(t.init(this.jsep),this.registered[t.name]=t)})}},O=class r{static get version(){return"1.4.0"}static toString(){return"JavaScript Expression Parser (JSEP) v"+r.version}static addUnaryOp(e){return r.max_unop_len=Math.max(e.length,r.max_unop_len),r.unary_ops[e]=1,r}static addBinaryOp(e,t,i){return r.max_binop_len=Math.max(e.length,r.max_binop_len),r.binary_ops[e]=t,i?r.right_associative.add(e):r.right_associative.delete(e),r}static addIdentifierChar(e){return r.additional_identifier_chars.add(e),r}static addLiteral(e,t){return r.literals[e]=t,r}static removeUnaryOp(e){return delete r.unary_ops[e],e.length===r.max_unop_len&&(r.max_unop_len=r.getMaxKeyLen(r.unary_ops)),r}static removeAllUnaryOps(){return r.unary_ops={},r.max_unop_len=0,r}static removeIdentifierChar(e){return r.additional_identifier_chars.delete(e),r}static removeBinaryOp(e){return delete r.binary_ops[e],e.length===r.max_binop_len&&(r.max_binop_len=r.getMaxKeyLen(r.binary_ops)),r.right_associative.delete(e),r}static removeAllBinaryOps(){return r.binary_ops={},r.max_binop_len=0,r}static removeLiteral(e){return delete r.literals[e],r}static removeAllLiterals(){return r.literals={},r}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(e){this.expr=e,this.index=0}static parse(e){return new r(e).parse()}static getMaxKeyLen(e){return Math.max(0,...Object.keys(e).map(t=>t.length))}static isDecimalDigit(e){return e>=48&&e<=57}static binaryPrecedence(e){return r.binary_ops[e]||0}static isIdentifierStart(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!r.binary_ops[String.fromCharCode(e)]||r.additional_identifier_chars.has(String.fromCharCode(e))}static isIdentifierPart(e){return r.isIdentifierStart(e)||r.isDecimalDigit(e)}throwError(e){let t=new Error(e+" at character "+this.index);throw t.index=this.index,t.description=e,t}runHook(e,t){if(r.hooks[e]){let i={context:this,node:t};return r.hooks.run(e,i),i.node}return t}searchHook(e){if(r.hooks[e]){let t={context:this};return r.hooks[e].find(function(i){return i.call(t.context,t),t.node}),t.node}}gobbleSpaces(){let e=this.code;for(;e===r.SPACE_CODE||e===r.TAB_CODE||e===r.LF_CODE||e===r.CR_CODE;)e=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");let e=this.gobbleExpressions(),t=e.length===1?e[0]:{type:r.COMPOUND,body:e};return this.runHook("after-all",t)}gobbleExpressions(e){let t=[],i,s;for(;this.index<this.expr.length;)if(i=this.code,i===r.SEMCOL_CODE||i===r.COMMA_CODE)this.index++;else if(s=this.gobbleExpression())t.push(s);else if(this.index<this.expr.length){if(i===e)break;this.throwError('Unexpected "'+this.char+'"')}return t}gobbleExpression(){let e=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",e)}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,r.max_binop_len),t=e.length;for(;t>0;){if(r.binary_ops.hasOwnProperty(e)&&(!r.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!r.isIdentifierPart(this.expr.charCodeAt(this.index+e.length))))return this.index+=t,e;e=e.substr(0,--t)}return!1}gobbleBinaryExpression(){let e,t,i,s,n,o,a,l,u;if(o=this.gobbleToken(),!o||(t=this.gobbleBinaryOp(),!t))return o;for(n={value:t,prec:r.binaryPrecedence(t),right_a:r.right_associative.has(t)},a=this.gobbleToken(),a||this.throwError("Expected expression after "+t),s=[o,n,a];t=this.gobbleBinaryOp();){if(i=r.binaryPrecedence(t),i===0){this.index-=t.length;break}n={value:t,prec:i,right_a:r.right_associative.has(t)},u=t;let c=h=>n.right_a&&h.right_a?i>h.prec:i<=h.prec;for(;s.length>2&&c(s[s.length-2]);)a=s.pop(),t=s.pop().value,o=s.pop(),e={type:r.BINARY_EXP,operator:t,left:o,right:a},s.push(e);e=this.gobbleToken(),e||this.throwError("Expected expression after "+u),s.push(n,e)}for(l=s.length-1,e=s[l];l>1;)e={type:r.BINARY_EXP,operator:s[l-1].value,left:s[l-2],right:e},l-=2;return e}gobbleToken(){let e,t,i,s;if(this.gobbleSpaces(),s=this.searchHook("gobble-token"),s)return this.runHook("after-token",s);if(e=this.code,r.isDecimalDigit(e)||e===r.PERIOD_CODE)return this.gobbleNumericLiteral();if(e===r.SQUOTE_CODE||e===r.DQUOTE_CODE)s=this.gobbleStringLiteral();else if(e===r.OBRACK_CODE)s=this.gobbleArray();else{for(t=this.expr.substr(this.index,r.max_unop_len),i=t.length;i>0;){if(r.unary_ops.hasOwnProperty(t)&&(!r.isIdentifierStart(this.code)||this.index+t.length<this.expr.length&&!r.isIdentifierPart(this.expr.charCodeAt(this.index+t.length)))){this.index+=i;let n=this.gobbleToken();return n||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:r.UNARY_EXP,operator:t,argument:n,prefix:!0})}t=t.substr(0,--i)}r.isIdentifierStart(e)?(s=this.gobbleIdentifier(),r.literals.hasOwnProperty(s.name)?s={type:r.LITERAL,value:r.literals[s.name],raw:s.name}:s.name===r.this_str&&(s={type:r.THIS_EXP})):e===r.OPAREN_CODE&&(s=this.gobbleGroup())}return s?(s=this.gobbleTokenProperty(s),this.runHook("after-token",s)):this.runHook("after-token",!1)}gobbleTokenProperty(e){this.gobbleSpaces();let t=this.code;for(;t===r.PERIOD_CODE||t===r.OBRACK_CODE||t===r.OPAREN_CODE||t===r.QUMARK_CODE;){let i;if(t===r.QUMARK_CODE){if(this.expr.charCodeAt(this.index+1)!==r.PERIOD_CODE)break;i=!0,this.index+=2,this.gobbleSpaces(),t=this.code}this.index++,t===r.OBRACK_CODE?(e={type:r.MEMBER_EXP,computed:!0,object:e,property:this.gobbleExpression()},e.property||this.throwError('Unexpected "'+this.char+'"'),this.gobbleSpaces(),t=this.code,t!==r.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):t===r.OPAREN_CODE?e={type:r.CALL_EXP,arguments:this.gobbleArguments(r.CPAREN_CODE),callee:e}:(t===r.PERIOD_CODE||i)&&(i&&this.index--,this.gobbleSpaces(),e={type:r.MEMBER_EXP,computed:!1,object:e,property:this.gobbleIdentifier()}),i&&(e.optional=!0),this.gobbleSpaces(),t=this.code}return e}gobbleNumericLiteral(){let e="",t,i;for(;r.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(this.code===r.PERIOD_CODE)for(e+=this.expr.charAt(this.index++);r.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(t=this.char,t==="e"||t==="E"){for(e+=this.expr.charAt(this.index++),t=this.char,(t==="+"||t==="-")&&(e+=this.expr.charAt(this.index++));r.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);r.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+e+this.char+")")}return i=this.code,r.isIdentifierStart(i)?this.throwError("Variable names cannot start with a number ("+e+this.char+")"):(i===r.PERIOD_CODE||e.length===1&&e.charCodeAt(0)===r.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:r.LITERAL,value:parseFloat(e),raw:e}}gobbleStringLiteral(){let e="",t=this.index,i=this.expr.charAt(this.index++),s=!1;for(;this.index<this.expr.length;){let n=this.expr.charAt(this.index++);if(n===i){s=!0;break}else if(n==="\\")switch(n=this.expr.charAt(this.index++),n){case"n":e+=`
`;break;case"r":e+="\r";break;case"t":e+="	";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=n}else e+=n}return s||this.throwError('Unclosed quote after "'+e+'"'),{type:r.LITERAL,value:e,raw:this.expr.substring(t,this.index)}}gobbleIdentifier(){let e=this.code,t=this.index;for(r.isIdentifierStart(e)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(e=this.code,r.isIdentifierPart(e));)this.index++;return{type:r.IDENTIFIER,name:this.expr.slice(t,this.index)}}gobbleArguments(e){let t=[],i=!1,s=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let n=this.code;if(n===e){i=!0,this.index++,e===r.CPAREN_CODE&&s&&s>=t.length&&this.throwError("Unexpected token "+String.fromCharCode(e));break}else if(n===r.COMMA_CODE){if(this.index++,s++,s!==t.length){if(e===r.CPAREN_CODE)this.throwError("Unexpected token ,");else if(e===r.CBRACK_CODE)for(let o=t.length;o<s;o++)t.push(null)}}else if(t.length!==s&&s!==0)this.throwError("Expected comma");else{let o=this.gobbleExpression();(!o||o.type===r.COMPOUND)&&this.throwError("Expected comma"),t.push(o)}}return i||this.throwError("Expected "+String.fromCharCode(e)),t}gobbleGroup(){this.index++;let e=this.gobbleExpressions(r.CPAREN_CODE);if(this.code===r.CPAREN_CODE)return this.index++,e.length===1?e[0]:e.length?{type:r.SEQUENCE_EXP,expressions:e}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:r.ARRAY_EXP,elements:this.gobbleArguments(r.CBRACK_CODE)}}},Kt=new we;Object.assign(O,{hooks:Kt,plugins:new _e(O),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"??":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10,"**":11},right_associative:new Set(["**"]),additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});O.max_unop_len=O.getMaxKeyLen(O.unary_ops);O.max_binop_len=O.getMaxKeyLen(O.binary_ops);var $=r=>new O(r).parse(),Jt=Object.getOwnPropertyNames(class{});Object.getOwnPropertyNames(O).filter(r=>!Jt.includes(r)&&$[r]===void 0).forEach(r=>{$[r]=O[r]});$.Jsep=O;var Xt="ConditionalExpression",Yt={name:"ternary",init(r){r.hooks.add("after-expression",function(t){if(t.node&&this.code===r.QUMARK_CODE){this.index++;let i=t.node,s=this.gobbleExpression();if(s||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===r.COLON_CODE){this.index++;let n=this.gobbleExpression();if(n||this.throwError("Expected expression"),t.node={type:Xt,test:i,consequent:s,alternate:n},i.operator&&r.binary_ops[i.operator]<=.9){let o=i;for(;o.right.operator&&r.binary_ops[o.right.operator]<=.9;)o=o.right;t.node.test=o.right,o.right=t.node,t.node=i}}else this.throwError("Expected :")}})}};$.plugins.register(Yt);var Xe=47,Zt=92,er={name:"regex",init(r){r.hooks.add("gobble-token",function(t){if(this.code===Xe){let i=++this.index,s=!1;for(;this.index<this.expr.length;){if(this.code===Xe&&!s){let n=this.expr.slice(i,this.index),o="";for(;++this.index<this.expr.length;){let l=this.code;if(l>=97&&l<=122||l>=65&&l<=90||l>=48&&l<=57)o+=this.char;else break}let a;try{a=new RegExp(n,o)}catch(l){this.throwError(l.message)}return t.node={type:r.LITERAL,value:a,raw:this.expr.slice(i-1,this.index)},t.node=this.gobbleTokenProperty(t.node),t.node}this.code===r.OBRACK_CODE?s=!0:s&&this.code===r.CBRACK_CODE&&(s=!1),this.index+=this.code===Zt?2:1}this.throwError("Unclosed Regex")}})}},Ce=43,tr=45,K={name:"assignment",assignmentOperators:new Set(["=","*=","**=","/=","%=","+=","-=","<<=",">>=",">>>=","&=","^=","|=","||=","&&=","??="]),updateOperators:[Ce,tr],assignmentPrecedence:.9,init(r){let e=[r.IDENTIFIER,r.MEMBER_EXP];K.assignmentOperators.forEach(i=>r.addBinaryOp(i,K.assignmentPrecedence,!0)),r.hooks.add("gobble-token",function(s){let n=this.code;K.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(this.index+=2,s.node={type:"UpdateExpression",operator:n===Ce?"++":"--",argument:this.gobbleTokenProperty(this.gobbleIdentifier()),prefix:!0},(!s.node.argument||!e.includes(s.node.argument.type))&&this.throwError(`Unexpected ${s.node.operator}`))}),r.hooks.add("after-token",function(s){if(s.node){let n=this.code;K.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(e.includes(s.node.type)||this.throwError(`Unexpected ${s.node.operator}`),this.index+=2,s.node={type:"UpdateExpression",operator:n===Ce?"++":"--",argument:s.node,prefix:!1})}}),r.hooks.add("after-expression",function(s){s.node&&t(s.node)});function t(i){K.assignmentOperators.has(i.operator)?(i.type="AssignmentExpression",t(i.left),t(i.right)):i.operator||Object.values(i).forEach(s=>{s&&typeof s=="object"&&t(s)})}}};$.plugins.register(er,K);$.addUnaryOp("typeof");$.addLiteral("null",null);$.addLiteral("undefined",void 0);var rr=new Set(["constructor","__proto__","__defineGetter__","__defineSetter__"]),C={evalAst(r,e){switch(r.type){case"BinaryExpression":case"LogicalExpression":return C.evalBinaryExpression(r,e);case"Compound":return C.evalCompound(r,e);case"ConditionalExpression":return C.evalConditionalExpression(r,e);case"Identifier":return C.evalIdentifier(r,e);case"Literal":return C.evalLiteral(r,e);case"MemberExpression":return C.evalMemberExpression(r,e);case"UnaryExpression":return C.evalUnaryExpression(r,e);case"ArrayExpression":return C.evalArrayExpression(r,e);case"CallExpression":return C.evalCallExpression(r,e);case"AssignmentExpression":return C.evalAssignmentExpression(r,e);default:throw SyntaxError("Unexpected expression",r)}},evalBinaryExpression(r,e){return{"||":(i,s)=>i||s(),"&&":(i,s)=>i&&s(),"|":(i,s)=>i|s(),"^":(i,s)=>i^s(),"&":(i,s)=>i&s(),"==":(i,s)=>i==s(),"!=":(i,s)=>i!=s(),"===":(i,s)=>i===s(),"!==":(i,s)=>i!==s(),"<":(i,s)=>i<s(),">":(i,s)=>i>s(),"<=":(i,s)=>i<=s(),">=":(i,s)=>i>=s(),"<<":(i,s)=>i<<s(),">>":(i,s)=>i>>s(),">>>":(i,s)=>i>>>s(),"+":(i,s)=>i+s(),"-":(i,s)=>i-s(),"*":(i,s)=>i*s(),"/":(i,s)=>i/s(),"%":(i,s)=>i%s()}[r.operator](C.evalAst(r.left,e),()=>C.evalAst(r.right,e))},evalCompound(r,e){let t;for(let i=0;i<r.body.length;i++){r.body[i].type==="Identifier"&&["var","let","const"].includes(r.body[i].name)&&r.body[i+1]&&r.body[i+1].type==="AssignmentExpression"&&(i+=1);let s=r.body[i];t=C.evalAst(s,e)}return t},evalConditionalExpression(r,e){return C.evalAst(r.test,e)?C.evalAst(r.consequent,e):C.evalAst(r.alternate,e)},evalIdentifier(r,e){if(Object.hasOwn(e,r.name))return e[r.name];throw ReferenceError(`${r.name} is not defined`)},evalLiteral(r){return r.value},evalMemberExpression(r,e){let t=r.computed?C.evalAst(r.property):r.property.name,i=C.evalAst(r.object,e);if(i==null)throw TypeError(`Cannot read properties of ${i} (reading '${t}')`);if(!Object.hasOwn(i,t)&&rr.has(t))throw TypeError(`Cannot read properties of ${i} (reading '${t}')`);let s=i[t];return typeof s=="function"?s.bind(i):s},evalUnaryExpression(r,e){return{"-":i=>-C.evalAst(i,e),"!":i=>!C.evalAst(i,e),"~":i=>~C.evalAst(i,e),"+":i=>+C.evalAst(i,e),typeof:i=>typeof C.evalAst(i,e)}[r.operator](r.argument)},evalArrayExpression(r,e){return r.elements.map(t=>C.evalAst(t,e))},evalCallExpression(r,e){let t=r.arguments.map(s=>C.evalAst(s,e));return C.evalAst(r.callee,e)(...t)},evalAssignmentExpression(r,e){if(r.left.type!=="Identifier")throw SyntaxError("Invalid left-hand side in assignment");let t=r.left.name,i=C.evalAst(r.right,e);return e[t]=i,e[t]}},Te=class{constructor(e){this.code=e,this.ast=$(this.code)}runInNewContext(e){let t=Object.assign(Object.create(null),e);return C.evalAst(this.ast,t)}};function k(r,e){return r=r.slice(),r.push(e),r}function Ae(r,e){return e=e.slice(),e.unshift(r),e}var xe=class extends Error{constructor(e){super('JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),this.avoidNew=!0,this.value=e,this.name="NewError"}};function E(r,e,t,i,s){if(!(this instanceof E))try{return new E(r,e,t,i,s)}catch(o){if(!o.avoidNew)throw o;return o.value}typeof r=="string"&&(s=i,i=t,t=e,e=r,r=null);let n=r&&typeof r=="object";if(r=r||{},this.json=r.json||t,this.path=r.path||e,this.resultType=r.resultType||"value",this.flatten=r.flatten||!1,this.wrap=Object.hasOwn(r,"wrap")?r.wrap:!0,this.sandbox=r.sandbox||{},this.eval=r.eval===void 0?"safe":r.eval,this.ignoreEvalErrors=typeof r.ignoreEvalErrors>"u"?!1:r.ignoreEvalErrors,this.parent=r.parent||null,this.parentProperty=r.parentProperty||null,this.callback=r.callback||i||null,this.otherTypeCallback=r.otherTypeCallback||s||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},r.autostart!==!1){let o={path:n?r.path:e};n?"json"in r&&(o.json=r.json):o.json=t;let a=this.evaluate(o);if(!a||typeof a!="object")throw new xe(a);return a}}E.prototype.evaluate=function(r,e,t,i){let s=this.parent,n=this.parentProperty,{flatten:o,wrap:a}=this;if(this.currResultType=this.resultType,this.currEval=this.eval,this.currSandbox=this.sandbox,t=t||this.callback,this.currOtherTypeCallback=i||this.otherTypeCallback,e=e||this.json,r=r||this.path,r&&typeof r=="object"&&!Array.isArray(r)){if(!r.path&&r.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!Object.hasOwn(r,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');({json:e}=r),o=Object.hasOwn(r,"flatten")?r.flatten:o,this.currResultType=Object.hasOwn(r,"resultType")?r.resultType:this.currResultType,this.currSandbox=Object.hasOwn(r,"sandbox")?r.sandbox:this.currSandbox,a=Object.hasOwn(r,"wrap")?r.wrap:a,this.currEval=Object.hasOwn(r,"eval")?r.eval:this.currEval,t=Object.hasOwn(r,"callback")?r.callback:t,this.currOtherTypeCallback=Object.hasOwn(r,"otherTypeCallback")?r.otherTypeCallback:this.currOtherTypeCallback,s=Object.hasOwn(r,"parent")?r.parent:s,n=Object.hasOwn(r,"parentProperty")?r.parentProperty:n,r=r.path}if(s=s||null,n=n||null,Array.isArray(r)&&(r=E.toPathString(r)),!r&&r!==""||!e)return;let l=E.toPathArray(r);l[0]==="$"&&l.length>1&&l.shift(),this._hasParentSelector=null;let u=this._trace(l,e,["$"],s,n,t).filter(function(c){return c&&!c.isParentSelector});return u.length?!a&&u.length===1&&!u[0].hasArrExpr?this._getPreferredOutput(u[0]):u.reduce((c,h)=>{let d=this._getPreferredOutput(h);return o&&Array.isArray(d)?c=c.concat(d):c.push(d),c},[]):a?[]:void 0};E.prototype._getPreferredOutput=function(r){let e=this.currResultType;switch(e){case"all":{let t=Array.isArray(r.path)?r.path:E.toPathArray(r.path);return r.pointer=E.toPointer(t),r.path=typeof r.path=="string"?r.path:E.toPathString(r.path),r}case"value":case"parent":case"parentProperty":return r[e];case"path":return E.toPathString(r[e]);case"pointer":return E.toPointer(r.path);default:throw new TypeError("Unknown result type")}};E.prototype._handleCallback=function(r,e,t){if(e){let i=this._getPreferredOutput(r);r.path=typeof r.path=="string"?r.path:E.toPathString(r.path),e(i,t,r)}};E.prototype._trace=function(r,e,t,i,s,n,o,a){let l;if(!r.length)return l={path:t,value:e,parent:i,parentProperty:s,hasArrExpr:o},this._handleCallback(l,n,"value"),l;let u=r[0],c=r.slice(1),h=[];function d(f){Array.isArray(f)?f.forEach(m=>{h.push(m)}):h.push(f)}if((typeof u!="string"||a)&&e&&Object.hasOwn(e,u))d(this._trace(c,e[u],k(t,u),e,u,n,o));else if(u==="*")this._walk(e,f=>{d(this._trace(c,e[f],k(t,f),e,f,n,!0,!0))});else if(u==="..")d(this._trace(c,e,t,i,s,n,o)),this._walk(e,f=>{typeof e[f]=="object"&&d(this._trace(r.slice(),e[f],k(t,f),e,f,n,!0))});else{if(u==="^")return this._hasParentSelector=!0,{path:t.slice(0,-1),expr:c,isParentSelector:!0};if(u==="~")return l={path:k(t,u),value:s,parent:i,parentProperty:null},this._handleCallback(l,n,"property"),l;if(u==="$")d(this._trace(c,e,t,null,null,n,o));else if(/^(-?\d*):(-?\d*):?(\d*)$/u.test(u))d(this._slice(u,c,e,t,i,s,n));else if(u.indexOf("?(")===0){if(this.currEval===!1)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");let f=u.replace(/^\?\((.*?)\)$/u,"$1"),m=/@.?([^?]*)[['](\??\(.*?\))(?!.\)\])[\]']/gu.exec(f);m?this._walk(e,p=>{let b=[m[2]],g=m[1]?e[p][m[1]]:e[p];this._trace(b,g,t,i,s,n,!0).length>0&&d(this._trace(c,e[p],k(t,p),e,p,n,!0))}):this._walk(e,p=>{this._eval(f,e[p],p,t,i,s)&&d(this._trace(c,e[p],k(t,p),e,p,n,!0))})}else if(u[0]==="("){if(this.currEval===!1)throw new Error("Eval [(expr)] prevented in JSONPath expression.");d(this._trace(Ae(this._eval(u,e,t.at(-1),t.slice(0,-1),i,s),c),e,t,i,s,n,o))}else if(u[0]==="@"){let f=!1,m=u.slice(1,-2);switch(m){case"scalar":(!e||!["object","function"].includes(typeof e))&&(f=!0);break;case"boolean":case"string":case"undefined":case"function":typeof e===m&&(f=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(f=!0);break;case"number":Number.isFinite(e)&&(f=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(f=!0);break;case"object":e&&typeof e===m&&(f=!0);break;case"array":Array.isArray(e)&&(f=!0);break;case"other":f=this.currOtherTypeCallback(e,t,i,s);break;case"null":e===null&&(f=!0);break;default:throw new TypeError("Unknown value type "+m)}if(f)return l={path:t,value:e,parent:i,parentProperty:s},this._handleCallback(l,n,"value"),l}else if(u[0]==="`"&&e&&Object.hasOwn(e,u.slice(1))){let f=u.slice(1);d(this._trace(c,e[f],k(t,f),e,f,n,o,!0))}else if(u.includes(",")){let f=u.split(",");for(let m of f)d(this._trace(Ae(m,c),e,t,i,s,n,!0))}else!a&&e&&Object.hasOwn(e,u)&&d(this._trace(c,e[u],k(t,u),e,u,n,o,!0))}if(this._hasParentSelector)for(let f=0;f<h.length;f++){let m=h[f];if(m&&m.isParentSelector){let p=this._trace(m.expr,e,m.path,i,s,n,o);if(Array.isArray(p)){h[f]=p[0];let b=p.length;for(let g=1;g<b;g++)f++,h.splice(f,0,p[g])}else h[f]=p}}return h};E.prototype._walk=function(r,e){if(Array.isArray(r)){let t=r.length;for(let i=0;i<t;i++)e(i)}else r&&typeof r=="object"&&Object.keys(r).forEach(t=>{e(t)})};E.prototype._slice=function(r,e,t,i,s,n,o){if(!Array.isArray(t))return;let a=t.length,l=r.split(":"),u=l[2]&&Number.parseInt(l[2])||1,c=l[0]&&Number.parseInt(l[0])||0,h=l[1]&&Number.parseInt(l[1])||a;c=c<0?Math.max(0,c+a):Math.min(a,c),h=h<0?Math.max(0,h+a):Math.min(a,h);let d=[];for(let f=c;f<h;f+=u)this._trace(Ae(f,e),t,i,s,n,o,!0).forEach(p=>{d.push(p)});return d};E.prototype._eval=function(r,e,t,i,s,n){this.currSandbox._$_parentProperty=n,this.currSandbox._$_parent=s,this.currSandbox._$_property=t,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;let o=r.includes("@path");o&&(this.currSandbox._$_path=E.toPathString(i.concat([t])));let a=this.currEval+"Script:"+r;if(!E.cache[a]){let l=r.replaceAll("@parentProperty","_$_parentProperty").replaceAll("@parent","_$_parent").replaceAll("@property","_$_property").replaceAll("@root","_$_root").replaceAll(/@([.\s)[])/gu,"_$_v$1");if(o&&(l=l.replaceAll("@path","_$_path")),this.currEval==="safe"||this.currEval===!0||this.currEval===void 0)E.cache[a]=new this.safeVm.Script(l);else if(this.currEval==="native")E.cache[a]=new this.vm.Script(l);else if(typeof this.currEval=="function"&&this.currEval.prototype&&Object.hasOwn(this.currEval.prototype,"runInNewContext")){let u=this.currEval;E.cache[a]=new u(l)}else if(typeof this.currEval=="function")E.cache[a]={runInNewContext:u=>this.currEval(l,u)};else throw new TypeError(`Unknown "eval" property "${this.currEval}"`)}try{return E.cache[a].runInNewContext(this.currSandbox)}catch(l){if(this.ignoreEvalErrors)return!1;throw new Error("jsonPath: "+l.message+": "+r)}};E.cache={};E.toPathString=function(r){let e=r,t=e.length,i="$";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(i+=/^[0-9*]+$/u.test(e[s])?"["+e[s]+"]":"['"+e[s]+"']");return i};E.toPointer=function(r){let e=r,t=e.length,i="";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(i+="/"+e[s].toString().replaceAll("~","~0").replaceAll("/","~1"));return i};E.toPathArray=function(r){let{cache:e}=E;if(e[r])return e[r].concat();let t=[],s=r.replaceAll(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/gu,";$&;").replaceAll(/[['](\??\(.*?\))[\]'](?!.\])/gu,function(n,o){return"[#"+(t.push(o)-1)+"]"}).replaceAll(/\[['"]([^'\]]*)['"]\]/gu,function(n,o){return"['"+o.replaceAll(".","%@%").replaceAll("~","%%@@%%")+"']"}).replaceAll("~",";~;").replaceAll(/['"]?\.['"]?(?![^[]*\])|\[['"]?/gu,";").replaceAll("%@%",".").replaceAll("%%@@%%","~").replaceAll(/(?:;)?(\^+)(?:;)?/gu,function(n,o){return";"+o.split("").join(";")+";"}).replaceAll(/;;;|;;/gu,";..;").replaceAll(/;$|'?\]|'$/gu,"").split(";").map(function(n){let o=n.match(/#(\d+)/u);return!o||!o[1]?n:t[o[1]]});return e[r]=s,e[r].concat()};E.prototype.safeVm={Script:Te};E.prototype.vm=Ye.default;var U=(0,Oe.default)("glue-table-cache:sql"),J=(0,Oe.default)("glue-table-cache:sql:ast"),B=class{constructor(e){this.db=e}async getQueryAST(e){let t=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;U("Serializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to serialize SQL query");let n=JSON.parse(s[0][0]);if(n.error)throw new Error(JSON.stringify(n));return n}async getSqlFromAst(e){let t=`SELECT json_deserialize_sql('${JSON.stringify(e).replace(/'/g,"''")}')`;U("Deserializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to deserialize SQL query");return s[0][0]+";"}async transformGlueTableQuery(e){U("Transforming query: %s",e);let t=await this.getQueryAST(e);J("Original AST: %O",t),this.transformNode(t),J("Transformed AST: %O",t);let i=await this.getSqlFromAst(t);return U("Transformed query: %s",i),i}async getQueryGlueTableRefs(e){let t=await this.getQueryAST(e);return J("Original AST: %O",t),this.getAstGlueTableRefs(t)}getAstGlueTableRefs(e){return this.getAstTableRefs(e).map(t=>t.tableRef).filter(Boolean)}getAstTableRefs(e){return E({path:"$..*[?(@ && @.type=='BASE_TABLE' && (@.catalog_name=='glue' || @.catalog_name=='GLUE'))]",json:e}).map(n=>({node:n,tableRef:this.getGlueTableRef(n)}))}transformNode(e){U("Finding Glue table references in AST"),J("AST structure:",e);let t=this.getAstTableRefs(e);U("Found %d Glue table references",t.length),J("Table references:",t),E({path:"$..query_location",json:e,resultType:"pointer"}).forEach(s=>{let n=s.split("/").filter(Boolean);n.pop();let o=e;for(let a of n)o=o[a];o&&(o.query_location=void 0)});for(let s of t){let n=s.tableRef;n&&(U("Transforming table reference %s.%s",n.database,n.table),Object.assign(s.node,{type:"TABLE_FUNCTION",function:{class:"FUNCTION",type:"FUNCTION",function_name:"parquet_scan",schema:"",catalog:"",children:[{class:"FUNCTION",type:"FUNCTION",function_name:"getvariable",schema:"",catalog:"",children:[{class:"CONSTANT",type:"VALUE_CONSTANT",value:{type:{id:"VARCHAR",type_info:null},is_null:!1,value:this.getQueryFilesVarName(n.database,n.table)}}]}],filter:null,order_bys:{type:"ORDER_MODIFIER",orders:[]},distinct:!1,is_operator:!1,export_state:!1}}))}}getGlueTableRef(e){return e.type==="BASE_TABLE"&&(e.catalog_name==="glue"||e.catalog_name==="GLUE")?{database:e.schema_name||"default",table:e.table_name}:null}async extractPartitionFilters(e,t){let i=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;U("Serializing SQL: %s",i);let n=(await this.db.runAndReadAll(i)).getRows();if(!n.length||n[0].length===0||n[0][0]===null)throw new Error("Failed to serialize SQL query");let o=JSON.parse(n[0][0]);if(o.error)throw new Error(JSON.stringify(o));J("Original AST: %O",o);let a=new Set;return o?.statements?.[0]?.node?.where_clause&&this.extractFiltersFromCondition(o.statements[0].node.where_clause,t,a),Array.from(a)}findPartitionFilters(e,t,i,s){if(!(!e||typeof e!="object")){e.type==="SELECT"&&e.where&&this.extractFiltersFromCondition(e.where,i,s);for(let n in e)Array.isArray(e[n])?e[n].forEach(o=>this.findPartitionFilters(o,t,i,s)):typeof e[n]=="object"&&this.findPartitionFilters(e[n],t,i,s)}}extractFiltersFromCondition(e,t,i){if(!(!e||typeof e!="object")){if(e.class==="COMPARISON"){let s=e.left,n=e.right;if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])&&n?.class==="CONSTANT"&&n?.type==="VALUE_CONSTANT"){let o=n.value?.value;if(o!==void 0){let a=this.getComparisonOperator(e.type),l=typeof o=="string"?`'${o}'`:o;i.add(`${s.column_names[0]} ${a} ${l}`)}}}else if(e.class==="CONJUNCTION")e.children?.forEach(s=>this.extractFiltersFromCondition(s,t,i));else if(e.class==="OPERATOR"&&e.type==="COMPARE_IN"){let s=e.children?.[0];if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])){let n=e.children.slice(1).filter(o=>o.class==="CONSTANT"&&o.type==="VALUE_CONSTANT").map(o=>`'${o.value.value}'`);n.length>0&&i.add(`${s.column_names[0]} IN (${n.join(", ")})`)}}}}getComparisonOperator(e){switch(e){case"COMPARE_EQUAL":return"=";case"COMPARE_GREATERTHAN":return">";case"COMPARE_LESSTHAN":return"<";case"COMPARE_GREATERTHANOREQUALTO":return">=";case"COMPARE_LESSTHANOREQUALTO":return"<=";case"COMPARE_NOTEQUAL":return"!=";default:throw new Error(`Unsupported comparison type: ${e}`)}}getQueryFilesVarName(e,t){return`${e}_${t}_files`.replaceAll("-","")}getGlueTableFilesVarName(e,t){return`${e}_${t}_gview_files`.replaceAll("-","")}getGlueTableViewName(e,t){return`GLUE__${e}_${t}`.replaceAll("-","")}async getGlueTableViewSql(e,t=1){let i=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`,n=(await this.db.runAndReadAll(i)).getRows();if(!n.length||n[0].length===0||n[0][0]===null)throw new Error("Failed to serialize SQL query");let o=JSON.parse(n[0][0]);if(o.error)throw new Error(JSON.stringify(o));let a=this.getAstGlueTableRefs(o);if(!a.length)throw new Error("No Glue table references found in query");let l=[],u=new Set;for(let c of a){let h=this.getGlueTableFilesVarName(c.database,c.table),d=`${c.database}_${c.table}`;if(!u.has(d)){u.add(d);let f=this.getGlueTableViewName(c.database,c.table),m=t?`SELECT * FROM parquet_scan(getvariable('${h}'))`:"SELECT NULL LIMIT 0";l.push(`CREATE OR REPLACE VIEW ${f} AS ${m};`)}}return l}};var Ze=require("@aws-sdk/client-s3");function ir(r){let e=new URL(r);if(!r.startsWith("s3://")&&!r.startsWith("S3://"))throw new Error(`Not an S3 URL: ${e.protocol}`);return{bucket:e.hostname,prefix:e.pathname.substring(1)}}function sr(r,e){let t={};for(let i of e){let s=r.match(new RegExp(`${i}=([^/]+)`));s&&(t[i]=s[1])}return t}function Se(r,e){return r.map(t=>({path:t,partitionValues:sr(t,e)}))}async function et(r,e,t){let{bucket:i,prefix:s}=ir(e),n=[],o=s.endsWith("/")?s:`${s}/`,a;do{let l=new Ze.ListObjectsV2Command({Bucket:i,Prefix:o,ContinuationToken:a}),u=await r.send(l);n.push(...u.Contents?.map(c=>`s3://${i}/${c.Key}`).filter(c=>!c.endsWith("_$folder$"))??[]),a=u.NextContinuationToken}while(a);return Se(n.filter(Boolean),t)}var le=require("@aws-sdk/client-glue");var tt=Z(ae(),1),or=(0,tt.default)("glue-api");function ar(r){let e=r.Parameters??{};return e.table_type==="ICEBERG"?"ICEBERG":e["projection.enabled"]==="true"?"GLUE_PROJECTED":r.PartitionKeys&&r.PartitionKeys.length?"HIVE":"UNPARTITIONED"}async function rt(r,e,t){try{let i={DatabaseName:e,Name:t},n=(await r.send(new le.GetTableCommand(i))).Table;if(!n)throw new Error(`Table ${e}.${t} not found`);let o=ar(n),a={timestamp:Date.now(),table:n,tableType:o};return o==="GLUE_PROJECTED"&&n.Parameters?a.projectionPatterns=cr(n.Parameters):o==="HIVE"&&(a.partitionMetadata=await hr(r,e,t)),a}catch(i){throw or("getGlueTableMetadata ERROR:",i),i}}function lr(r,e){switch(r){case"type":return e;case"format":return e;case"range":try{return JSON.parse(e)}catch{return e.split(",").map(t=>t.trim())}case"values":return JSON.parse(e);default:return e}}function cr(r){let e={};return Object.entries(r).filter(([t])=>t.startsWith("projection.")).forEach(([t,i])=>{let s=t.match(/projection\.(\w+)\.(type|range|format|values)/);if(s){let[n,o,a]=s;e[o]||(e[o]={type:"enum"}),(a==="type"||a==="format"||a==="range"||a==="values")&&(e[o][a]=lr(a,i))}}),{enabled:!0,patterns:e}}async function hr(r,e,t){let i=new le.GetPartitionsCommand({DatabaseName:e,TableName:t});try{let s=await r.send(i);return!s.Partitions||s.Partitions.length===0?{keys:[],values:[]}:{keys:s.Partitions[0].Values||[],values:s.Partitions.map(n=>({values:n.Values||[],location:n.StorageDescriptor?.Location}))||[]}}catch(s){return console.warn(`Failed to load partitions for ${e}_${t}:`,s),{keys:[],values:[]}}}async function it(r,e){if(e.projectionPatterns?.enabled){let t=e.projectionPatterns.patterns[r];if(!t)throw new Error(`No projection pattern found for partition key ${r}`);switch(t.type){case"date":let i=t.format||"yyyy-MM-dd";return`regexp_extract(path, '(${ur(i)})', 1)`;case"integer":return"CAST(regexp_extract(path, '/([0-9]+)/', 1) AS INTEGER)";case"enum":return"regexp_extract(path, '/([^/]+)/[^/]*$', 1)";case"injected":throw new Error("Injected partition values not supported yet");default:throw new Error(`Unsupported projection type: ${t.type}`)}}return`regexp_extract(path, '${r}=([^/]+)', 1)`}function ur(r){let e={yyyy:"\\d{4}",MM:"\\d{2}",dd:"\\d{2}",HH:"\\d{2}",mm:"\\d{2}",ss:"\\d{2}"},t=r;for(let[i,s]of Object.entries(e))t=t.replace(i,s);return t}var x=[];for(let r=0;r<256;++r)x.push((r+256).toString(16).slice(1));function st(r,e=0){return(x[r[e+0]]+x[r[e+1]]+x[r[e+2]]+x[r[e+3]]+"-"+x[r[e+4]]+x[r[e+5]]+"-"+x[r[e+6]]+x[r[e+7]]+"-"+x[r[e+8]]+x[r[e+9]]+"-"+x[r[e+10]]+x[r[e+11]]+x[r[e+12]]+x[r[e+13]]+x[r[e+14]]+x[r[e+15]]).toLowerCase()}var nt=require("crypto"),he=new Uint8Array(256),ce=he.length;function ve(){return ce>he.length-16&&((0,nt.randomFillSync)(he),ce=0),he.slice(ce,ce+=16)}var ot=require("crypto"),Re={randomUUID:ot.randomUUID};function fr(r,e,t){if(Re.randomUUID&&!e&&!r)return Re.randomUUID();r=r||{};let i=r.random??r.rng?.()??ve();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let s=0;s<16;++s)e[t+s]=i[s];return e}return st(i)}var Fe=fr;function at(r,e,t=0){let i=[],s=t<0?0:t,n=e??"a"+Fe().replaceAll("-",""),o=r.endsWith("/")?r:r+"/";return i.push("INSTALL avro FROM community","LOAD avro",`SET VARIABLE ${n}_metadata_json_path = ( SELECT filename FROM read_json_auto('${o}metadata/*.json', filename=1) ORDER BY "last-sequence-number" DESC OFFSET ${s} LIMIT 1 )`,`SET VARIABLE ${n}_manifest_list_avro_file = ( SELECT snapshots[len(snapshots)]['manifest-list'] AS path FROM read_json(getvariable('${n}_metadata_json_path')))`,`SET VARIABLE ${n}_manifests = ( SELECT list(manifest_path) AS path FROM read_avro(getvariable('${n}_manifest_list_avro_file')))`,`SELECT data_file['file_path'] AS path FROM read_avro(getvariable('${n}_manifests'))`),i}var ri=new Error("timeout while waiting for mutex to become available"),ii=new Error("mutex already locked"),dr=new Error("request for lock canceled"),pr=function(r,e,t,i){function s(n){return n instanceof t?n:new t(function(o){o(n)})}return new(t||(t=Promise))(function(n,o){function a(c){try{u(i.next(c))}catch(h){o(h)}}function l(c){try{u(i.throw(c))}catch(h){o(h)}}function u(c){c.done?n(c.value):s(c.value).then(a,l)}u((i=i.apply(r,e||[])).next())})},Ie=class{constructor(e,t=dr){this._value=e,this._cancelError=t,this._queue=[],this._weightedWaiters=[]}acquire(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((i,s)=>{let n={resolve:i,reject:s,weight:e,priority:t},o=lt(this._queue,a=>t<=a.priority);o===-1&&e<=this._value?this._dispatchItem(n):this._queue.splice(o+1,0,n)})}runExclusive(e){return pr(this,arguments,void 0,function*(t,i=1,s=0){let[n,o]=yield this.acquire(i,s);try{return yield t(n)}finally{o()}})}waitForUnlock(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return this._couldLockImmediately(e,t)?Promise.resolve():new Promise(i=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),gr(this._weightedWaiters[e-1],{resolve:i,priority:t})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatchQueue()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatchQueue()}cancel(){this._queue.forEach(e=>e.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(e){let t=this._value;this._value-=e.weight,e.resolve([t,this._newReleaser(e.weight)])}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let e=this._value;e>0;e--){let t=this._weightedWaiters[e-1];t&&(t.forEach(i=>i.resolve()),this._weightedWaiters[e-1]=[])}else{let e=this._queue[0].priority;for(let t=this._value;t>0;t--){let i=this._weightedWaiters[t-1];if(!i)continue;let s=i.findIndex(n=>n.priority<=e);(s===-1?i:i.splice(0,s)).forEach(n=>n.resolve())}}}_couldLockImmediately(e,t){return(this._queue.length===0||this._queue[0].priority<t)&&e<=this._value}};function gr(r,e){let t=lt(r,i=>e.priority<=i.priority);r.splice(t+1,0,e)}function lt(r,e){for(let t=r.length-1;t>=0;t--)if(e(r[t]))return t;return-1}var mr=function(r,e,t,i){function s(n){return n instanceof t?n:new t(function(o){o(n)})}return new(t||(t=Promise))(function(n,o){function a(c){try{u(i.next(c))}catch(h){o(h)}}function l(c){try{u(i.throw(c))}catch(h){o(h)}}function u(c){c.done?n(c.value):s(c.value).then(a,l)}u((i=i.apply(r,e||[])).next())})},ue=class{constructor(e){this._semaphore=new Ie(1,e)}acquire(){return mr(this,arguments,void 0,function*(e=0){let[,t]=yield this._semaphore.acquire(1,e);return t})}runExclusive(e,t=0){return this._semaphore.runExclusive(()=>e(),1,t)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(e=0){return this._semaphore.waitForUnlock(1,e)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}};var fe=Z(gt(),1),_=(0,Le.default)("glue-table-cache"),X=(0,Le.default)("glue-table-cache:aws"),Pe={region:"eu-west-1",maxEntries:100,glueTableMetadataTtlMs:36e5,s3ListingRefresTtlhMs:36e5,proxyAddress:void 0},de=class{tableCache;s3ListingCache;glueClient;s3Client;db;sqlTransformer;config;constructor(e=Pe){if(_("GlueTableCache config:",JSON.stringify(e)),this.config={...Pe,...e,region:e?.region||process.env.AWS_REGION||Pe.region||"eu-west-1"},this.config.proxyAddress)try{new URL(this.config.proxyAddress),this.config.proxyAddress.endsWith("/")||(this.config.proxyAddress=this.config.proxyAddress+"/"),_("Using proxyAddress:",this.config.proxyAddress)}catch(i){console.error(i),this.config.proxyAddress=void 0}_("Initialised GlueTableCache config:",JSON.stringify(e));let t={region:e.region,credentials:this.config.credentials};this.glueClient=new mt.GlueClient(t),this.s3Client=new yt.S3Client(t),this.tableCache=new ee({max:this.config.maxEntries,ttl:this.config.glueTableMetadataTtlMs}),this.s3ListingCache=new ee({max:this.config.maxEntries,ttl:this.config.s3ListingRefresTtlhMs})}setCredentials(e){if(_("Setting credentials -- accessKeyId:",e.accessKeyId),e.secretAccessKey.length<=0)throw new Error("No secretAccessKey");this.config.credentials=e}async __connect(){if(this.db||(this.db=await(await Et.DuckDBInstance.create(":memory:")).connect()),!this.db)throw new Error("Could not create DuckDB instance (neo)");if(this.config.credentials?.accessKeyId&&this.config.credentials?.secretAccessKey){let{accessKeyId:e,secretAccessKey:t,sessionToken:i}=this.config.credentials;_("Using configured credentials for DuckDB (neo)"),await this.__runAndReadAll(`CREATE SECRET s3SecretForIcebergFromCreds (
            TYPE S3,
            KEY_ID '${e}',
            SECRET '${t}',
            ${i?`SESSION_TOKEN '${i}',`:""}
            REGION '${this.config.region}'
        );`)}else _("Using default credentials chain provider for DuckDB (neo)"),await this.__runAndReadAll("CREATE OR REPLACE SECRET s3SecretForIcebergWithProvider ( TYPE S3, PROVIDER CREDENTIAL_CHAIN );");return this.sqlTransformer||(this.sqlTransformer=new B(this.db)),this.db}clearCache(){this.tableCache.clear(),this.s3ListingCache.clear()}close(){this.db?.close(),this.db=void 0,this.sqlTransformer=void 0}getCacheKeyWithMutex(e,t){let i=e.get(t);if(i||(e.set(t,{mutex:new ue,timestamp:Date.now(),data:void 0}),i=e.get(t)),!i)throw new Error("ummm");return i}async getTableMetadataCached(e,t){let i=`${e}_${t}`;_("Getting table metadata for %s",i);let s=this.getCacheKeyWithMutex(this.tableCache,i);if(s.error&&delete s.error,!s||!s.mutex)throw new Error("Failed to init cache entry");return s.data?(_("Cache hit for %s",i),s.data):s.mutex.runExclusive(async()=>(0,fe.default)(async(n,o)=>{if(s.data)return s.data;if(s.error){n(s.error);return}_("Cache miss for %s, refreshing...",i);try{X("Fetching table metadata from AWS for %s.%s",e,t);let a=await rt(this.glueClient,e,t),l=Date.now();return s.timestamp=l,s.data=a,s.data}catch(a){if(_("getTableMetadataCached ERROR:",a?.$metadata),a?.$metadata?.httpStatusCode===403||a?.[0]?.$metadata?.httpStatusCode===403||a?.$metadata?.httpStatusCode===400||a?.[0]?.$metadata?.httpStatusCode===400||a?.message.includes("HTTP 40")){n(a);return}throw a}},{retries:3,minTimeout:200,maxTimeout:500,onRetry:(n,o)=>_("getTableMetadataCached -- retry:",o,n)}))}invalidateTable(e,t){let i=`${e}_${t}`;this.tableCache.delete(i);for(let s of this.s3ListingCache.keys())s.includes(i)&&this.s3ListingCache.delete(s)}async createGlueTableFilesVarSql(e,t,i){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new B(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let n=`SELECT path FROM "${`${e}_${t}`}_s3_listing"`;i&&i.length>0&&(n+=` WHERE ${i.join(" AND ")}`);let o=this.sqlTransformer?.getGlueTableFilesVarName(e,t);return this.config.proxyAddress?`SET VARIABLE ${o} = ( SELECT list(replace(path, 's3://', '${this.config.proxyAddress}')) FROM (${n}));`:`SET VARIABLE ${o} = ( SELECT list(path) FROM (${n}));`}async convertGlueTableQuery(e){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new B(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=await this.getGlueTableViewSetupSql(e),i=await this.sqlTransformer.transformGlueTableQuery(e);return t.join("")+i}async getGlueTableViewSetupSql(e){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new B(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=[],i=await this.sqlTransformer.getQueryGlueTableRefs(e);_("Found Glue Table references: %O",i),await Promise.all(i.map(async({database:n,table:o})=>{_("Found Glue Table reference: %s",{database:n,table:o});let a=await this.getTableMetadataCached(n,o);if(!a)throw new Error("Metadata not found");let l=`${n}_${o}`,u=a.table.StorageDescriptor?.Location;if(!u)throw new Error(`No storage location found for ${l}`);let c=(a.table.PartitionKeys||[]).map(y=>y.Name),h=[];switch(a.tableType){case"ICEBERG":{let y=await this.__listS3IcebergFilesCached(u,c);y&&h.push(...y);break}default:{let y=await this.__listS3FilesCached(u,c);y&&h.push(...y);break}}t.push(`CREATE OR REPLACE TABLE "${l}_s3_files" AS SELECT path FROM (VALUES ${h.length?h.map(y=>`('${y.path}')`).join(","):"( '' )"}) t(path);`);let d=await Promise.all(c.map(async y=>`${await it(y,a)} as ${y}`));t.push(`CREATE OR REPLACE TABLE "${l}_s3_listing" AS SELECT path, ${d.join(", ")} FROM "${l}_s3_files";`);for(let y of c)t.push(`CREATE INDEX IF NOT EXISTS idx_${y} ON "${l}_s3_listing" (${y});`);if(!this.sqlTransformer)throw new Error("SQL transformer not initialized");c=(a.table.PartitionKeys||[]).map(y=>y.Name);let f=await this.sqlTransformer.extractPartitionFilters(e,c),m=`SELECT list(path) FROM "${l}_s3_listing"`;this.config.proxyAddress&&(m=`SELECT list(replace(path, 's3://', '${this.config.proxyAddress}')) FROM "${l}_s3_listing"`),f.length>0&&(m+=` WHERE ${f.join(" AND ")}`);let p=this.sqlTransformer.getQueryFilesVarName(n,o);t.push(`SET VARIABLE ${p} = (${m});`);let b=await this.createGlueTableFilesVarSql(n,o);b&&t.push(b);let g=await this.sqlTransformer.getGlueTableViewSql(e,h.length);t.push(...g)}));let s=t.map(n=>n.trim());return _(s),s}async __listS3IcebergFilesCached(e,t){let i=`${e}:${t.join(",")}`,s=this.getCacheKeyWithMutex(this.s3ListingCache,i);if(!s)throw new Error("Could not initialise cache entry");return s.error&&delete s.error,s.data?(X("Using cached S3 (Iceberg) listing for %s",e),s.data):s.mutex.runExclusive(async()=>(0,fe.default)(async(n,o)=>{if(s.data)return s.data;if(s.error){n(s.error);return}try{let a=at(e);if(X(a),this.db||await this.__connect(),!this.db)throw new Error("Could not create db connection");let l=a.pop();if(!l)throw new Error("No SQL statements generated");for await(let h of a)_(h),await this.db.runAndReadAll(h);let u=(await this.db.runAndReadAll(l)).getRows(),c=Se(u.flat(),t);return X("Listing Iceberg S3 files for %s",{s3Path:e,partitionKeys:t,listing:c}),this.s3ListingCache.set(i,{...s,timestamp:Date.now(),data:c}),s.error=void 0,c}catch(a){if(s.error=a,_("__listS3IcebergFilesCached ERROR:",o,a),a?.$metadata?.httpStatusCode===403||a?.[0]?.$metadata?.httpStatusCode===403||a?.$metadata?.httpStatusCode===400||a?.[0]?.$metadata?.httpStatusCode===400||a?.message.includes("HTTP 40")){n(a);return}throw a}},{retries:3,minTimeout:200,maxTimeout:500,onRetry:(n,o)=>_("__listS3IcebergFilesCached -- retry:",o,n)}))}async __listS3FilesCached(e,t){let i=`${e}:${t.join(",")}`,s=this.getCacheKeyWithMutex(this.s3ListingCache,i);if(!s)throw new Error("Could not initialise cache entry");return s.error&&delete s.error,s.data?(X("Using cached S3 listing for %s",e),s.data):s.mutex.runExclusive(async()=>(0,fe.default)(async(n,o)=>{if(s.data)return s.data;if(s.error){n(s.error);return}try{X("Listing S3 files for %s",e);let a=await et(this.s3Client,e,t);return this.s3ListingCache.set(i,{...s,timestamp:Date.now(),data:a}),a}catch(a){if(_("__listS3FilesCached ERROR:",o,a),a?.$metadata?.httpStatusCode===403||a?.[0]?.$metadata?.httpStatusCode===403||a?.$metadata?.httpStatusCode===400||a?.[0]?.$metadata?.httpStatusCode===400||a?.message.includes("HTTP 40")){n(a);return}throw a}},{retries:3,minTimeout:200,maxTimeout:500,onRetry:(n,o)=>_("__listS3FilesCached -- retry:",o,n)}))}async __runAndReadAll(e){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");return this.db.runAndReadAll(e)}};0&&(module.exports={GlueTableCache});
