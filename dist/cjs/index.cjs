"use strict";var Ge=Object.create;var z=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var We=Object.getPrototypeOf,Ve=Object.prototype.hasOwnProperty;var W=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports),He=(i,e)=>{for(var t in e)z(i,t,{get:e[t],enumerable:!0})},ge=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ze(e))!Ve.call(i,s)&&s!==t&&z(i,s,{get:()=>e[s],enumerable:!(r=Be(e,s))||r.enumerable});return i};var me=(i,e,t)=>(t=i!=null?Ge(We(i)):{},ge(e||!i||!i.__esModule?z(t,"default",{value:i,enumerable:!0}):t,i)),Qe=i=>ge(z({},"__esModule",{value:!0}),i);var De=W((si,Ie)=>{function x(i,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(i)),this._timeouts=i,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Ie.exports=x;x.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};x.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};x.prototype.retry=function(i){if(this._timeout&&clearTimeout(this._timeout),!i)return!1;var e=new Date().getTime();if(i&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(i),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(i);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};x.prototype.attempt=function(i,e){this._fn=i,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};x.prototype.try=function(i){console.log("Using RetryOperation.try() is deprecated"),this.attempt(i)};x.prototype.start=function(i){console.log("Using RetryOperation.start() is deprecated"),this.attempt(i)};x.prototype.start=x.prototype.try;x.prototype.errors=function(){return this._errors};x.prototype.attempts=function(){return this._attempts};x.prototype.mainError=function(){if(this._errors.length===0)return null;for(var i={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],n=s.message,o=(i[n]||0)+1;i[n]=o,o>=t&&(e=s,t=o)}return e}});var Fe=W($=>{var yt=De();$.operation=function(i){var e=$.timeouts(i);return new yt(e,{forever:i&&(i.forever||i.retries===1/0),unref:i&&i.unref,maxRetryTime:i&&i.maxRetryTime})};$.timeouts=function(i){if(i instanceof Array)return[].concat(i);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in i)e[t]=i[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<e.retries;s++)r.push(this.createTimeout(s,e));return i&&i.forever&&!r.length&&r.push(this.createTimeout(s,e)),r.sort(function(n,o){return n-o}),r};$.createTimeout=function(i,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,i));return r=Math.min(r,e.maxTimeout),r};$.wrap=function(i,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in i)typeof i[r]=="function"&&t.push(r)}for(var s=0;s<t.length;s++){var n=t[s],o=i[n];i[n]=function(l){var c=$.operation(e),h=Array.prototype.slice.call(arguments,1),f=h.pop();h.push(function(d){c.retry(d)||(d&&(arguments[0]=c.mainError()),f.apply(this,arguments))}),c.attempt(function(){l.apply(i,h)})}.bind(i,o),i[n].options=e}}});var Ne=W((oi,$e)=>{$e.exports=Fe()});var Me=W((ai,Ue)=>{var bt=Ne();function wt(i,e){function t(r,s){var n=e||{},o;"randomize"in n||(n.randomize=!0),o=bt.operation(n);function a(h){s(h||new Error("Aborted"))}function l(h,f){if(h.bail){a(h);return}o.retry(h)?n.onRetry&&n.onRetry(h,f):s(o.mainError())}function c(h){var f;try{f=i(a,h)}catch(d){l(d,h);return}Promise.resolve(f).then(r).catch(function(u){l(u,h)})}o.attempt(c)}return new Promise(t)}Ue.exports=wt});var _t={};He(_t,{GlueTableCache:()=>Y});module.exports=Qe(_t);var ke=require("@aws-sdk/client-glue"),je=require("@aws-sdk/client-s3");var N=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,ye=new Set,ee=typeof process=="object"&&process?process:{},be=(i,e,t,r)=>{typeof ee.emitWarning=="function"?ee.emitWarning(i,e,t,r):console.error(`[${t}] ${e}: ${i}`)},V=globalThis.AbortController,Ee=globalThis.AbortSignal;if(typeof V>"u"){Ee=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(r,s){this._onabort.push(s)}},V=class{constructor(){e()}signal=new Ee;abort(r){if(!this.signal.aborted){this.signal.reason=r,this.signal.aborted=!0;for(let s of this.signal._onabort)s(r);this.signal.onabort?.(r)}}};let i=ee.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",e=()=>{i&&(i=!1,be("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}var Ke=i=>!ye.has(i),St=Symbol("type"),P=i=>i&&i===Math.floor(i)&&i>0&&isFinite(i),we=i=>P(i)?i<=Math.pow(2,8)?Uint8Array:i<=Math.pow(2,16)?Uint16Array:i<=Math.pow(2,32)?Uint32Array:i<=Number.MAX_SAFE_INTEGER?U:null:null,U=class extends Array{constructor(e){super(e),this.fill(0)}},te=class i{heap;length;static#l=!1;static create(e){let t=we(e);if(!t)return[];i.#l=!0;let r=new i(e,t);return i.#l=!1,r}constructor(e,t){if(!i.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}},G=class i{#l;#u;#g;#m;#P;#L;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#s;#E;#r;#i;#e;#h;#f;#a;#n;#y;#o;#b;#w;#d;#_;#x;#c;static unsafeExposeInternals(e){return{starts:e.#w,ttls:e.#d,sizes:e.#b,keyMap:e.#r,keyList:e.#i,valList:e.#e,next:e.#h,prev:e.#f,get head(){return e.#a},get tail(){return e.#n},free:e.#y,isBackgroundFetch:t=>e.#t(t),backgroundFetch:(t,r,s,n)=>e.#F(t,r,s,n),moveToTail:t=>e.#v(t),indexes:t=>e.#T(t),rindexes:t=>e.#C(t),isStale:t=>e.#p(t)}}get max(){return this.#l}get maxSize(){return this.#u}get calculatedSize(){return this.#E}get size(){return this.#s}get fetchMethod(){return this.#P}get memoMethod(){return this.#L}get dispose(){return this.#g}get disposeAfter(){return this.#m}constructor(e){let{max:t=0,ttl:r,ttlResolution:s=1,ttlAutopurge:n,updateAgeOnGet:o,updateAgeOnHas:a,allowStale:l,dispose:c,disposeAfter:h,noDisposeOnSet:f,noUpdateTTL:d,maxSize:u=0,maxEntrySize:E=0,sizeCalculation:p,fetchMethod:w,memoMethod:g,noDeleteOnFetchRejection:y,noDeleteOnStaleGet:O,allowStaleOnFetchRejection:T,allowStaleOnFetchAbort:S,ignoreFetchAbort:q}=e;if(t!==0&&!P(t))throw new TypeError("max option must be a nonnegative integer");let v=t?we(t):Array;if(!v)throw new Error("invalid max value: "+t);if(this.#l=t,this.#u=u,this.maxEntrySize=E||this.#u,this.sizeCalculation=p,this.sizeCalculation){if(!this.#u&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(g!==void 0&&typeof g!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#L=g,w!==void 0&&typeof w!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#P=w,this.#x=!!w,this.#r=new Map,this.#i=new Array(t).fill(void 0),this.#e=new Array(t).fill(void 0),this.#h=new v(t),this.#f=new v(t),this.#a=0,this.#n=0,this.#y=te.create(t),this.#s=0,this.#E=0,typeof c=="function"&&(this.#g=c),typeof h=="function"?(this.#m=h,this.#o=[]):(this.#m=void 0,this.#o=void 0),this.#_=!!this.#g,this.#c=!!this.#m,this.noDisposeOnSet=!!f,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!y,this.allowStaleOnFetchRejection=!!T,this.allowStaleOnFetchAbort=!!S,this.ignoreFetchAbort=!!q,this.maxEntrySize!==0){if(this.#u!==0&&!P(this.#u))throw new TypeError("maxSize must be a positive integer if specified");if(!P(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#q()}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!O,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!a,this.ttlResolution=P(s)||s===0?s:1,this.ttlAutopurge=!!n,this.ttl=r||0,this.ttl){if(!P(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#$()}if(this.#l===0&&this.ttl===0&&this.#u===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#u){let B="LRU_CACHE_UNBOUNDED";Ke(B)&&(ye.add(B),be("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",B,i))}}getRemainingTTL(e){return this.#r.has(e)?1/0:0}#$(){let e=new U(this.#l),t=new U(this.#l);this.#d=e,this.#w=t,this.#N=(n,o,a=N.now())=>{if(t[n]=o!==0?a:0,e[n]=o,o!==0&&this.ttlAutopurge){let l=setTimeout(()=>{this.#p(n)&&this.#A(this.#i[n],"expire")},o+1);l.unref&&l.unref()}},this.#O=n=>{t[n]=e[n]!==0?N.now():0},this.#S=(n,o)=>{if(e[o]){let a=e[o],l=t[o];if(!a||!l)return;n.ttl=a,n.start=l,n.now=r||s();let c=n.now-l;n.remainingTTL=a-c}};let r=0,s=()=>{let n=N.now();if(this.ttlResolution>0){r=n;let o=setTimeout(()=>r=0,this.ttlResolution);o.unref&&o.unref()}return n};this.getRemainingTTL=n=>{let o=this.#r.get(n);if(o===void 0)return 0;let a=e[o],l=t[o];if(!a||!l)return 1/0;let c=(r||s())-l;return a-c},this.#p=n=>{let o=t[n],a=e[n];return!!a&&!!o&&(r||s())-o>a}}#O=()=>{};#S=()=>{};#N=()=>{};#p=()=>!1;#q(){let e=new U(this.#l);this.#E=0,this.#b=e,this.#R=t=>{this.#E-=e[t],e[t]=0},this.#U=(t,r,s,n)=>{if(this.#t(r))return 0;if(!P(s))if(n){if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(s=n(r,t),!P(s))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return s},this.#I=(t,r,s)=>{if(e[t]=r,this.#u){let n=this.#u-e[t];for(;this.#E>n;)this.#D(!0)}this.#E+=e[t],s&&(s.entrySize=r,s.totalCalculatedSize=this.#E)}}#R=e=>{};#I=(e,t,r)=>{};#U=(e,t,r,s)=>{if(r||s)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#T({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#n;!(!this.#M(t)||((e||!this.#p(t))&&(yield t),t===this.#a));)t=this.#f[t]}*#C({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#a;!(!this.#M(t)||((e||!this.#p(t))&&(yield t),t===this.#n));)t=this.#h[t]}#M(e){return e!==void 0&&this.#r.get(this.#i[e])===e}*entries(){for(let e of this.#T())this.#e[e]!==void 0&&this.#i[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#i[e],this.#e[e]])}*rentries(){for(let e of this.#C())this.#e[e]!==void 0&&this.#i[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#i[e],this.#e[e]])}*keys(){for(let e of this.#T()){let t=this.#i[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*rkeys(){for(let e of this.#C()){let t=this.#i[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*values(){for(let e of this.#T())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}*rvalues(){for(let e of this.#C())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let r of this.#T()){let s=this.#e[r],n=this.#t(s)?s.__staleWhileFetching:s;if(n!==void 0&&e(n,this.#i[r],this))return this.get(this.#i[r],t)}}forEach(e,t=this){for(let r of this.#T()){let s=this.#e[r],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#i[r],this)}}rforEach(e,t=this){for(let r of this.#C()){let s=this.#e[r],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#i[r],this)}}purgeStale(){let e=!1;for(let t of this.#C({allowStale:!0}))this.#p(t)&&(this.#A(this.#i[t],"expire"),e=!0);return e}info(e){let t=this.#r.get(e);if(t===void 0)return;let r=this.#e[t],s=this.#t(r)?r.__staleWhileFetching:r;if(s===void 0)return;let n={value:s};if(this.#d&&this.#w){let o=this.#d[t],a=this.#w[t];if(o&&a){let l=o-(N.now()-a);n.ttl=l,n.start=Date.now()}}return this.#b&&(n.size=this.#b[t]),n}dump(){let e=[];for(let t of this.#T({allowStale:!0})){let r=this.#i[t],s=this.#e[t],n=this.#t(s)?s.__staleWhileFetching:s;if(n===void 0||r===void 0)continue;let o={value:n};if(this.#d&&this.#w){o.ttl=this.#d[t];let a=N.now()-this.#w[t];o.start=Math.floor(Date.now()-a)}this.#b&&(o.size=this.#b[t]),e.unshift([r,o])}return e}load(e){this.clear();for(let[t,r]of e){if(r.start){let s=Date.now()-r.start;r.start=N.now()-s}this.set(t,r.value,r)}}set(e,t,r={}){if(t===void 0)return this.delete(e),this;let{ttl:s=this.ttl,start:n,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:l}=r,{noUpdateTTL:c=this.noUpdateTTL}=r,h=this.#U(e,t,r.size||0,a);if(this.maxEntrySize&&h>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.#A(e,"set"),this;let f=this.#s===0?void 0:this.#r.get(e);if(f===void 0)f=this.#s===0?this.#n:this.#y.length!==0?this.#y.pop():this.#s===this.#l?this.#D(!1):this.#s,this.#i[f]=e,this.#e[f]=t,this.#r.set(e,f),this.#h[this.#n]=f,this.#f[f]=this.#n,this.#n=f,this.#s++,this.#I(f,h,l),l&&(l.set="add"),c=!1;else{this.#v(f);let d=this.#e[f];if(t!==d){if(this.#x&&this.#t(d)){d.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:u}=d;u!==void 0&&!o&&(this.#_&&this.#g?.(u,e,"set"),this.#c&&this.#o?.push([u,e,"set"]))}else o||(this.#_&&this.#g?.(d,e,"set"),this.#c&&this.#o?.push([d,e,"set"]));if(this.#R(f),this.#I(f,h,l),this.#e[f]=t,l){l.set="replace";let u=d&&this.#t(d)?d.__staleWhileFetching:d;u!==void 0&&(l.oldValue=u)}}else l&&(l.set="update")}if(s!==0&&!this.#d&&this.#$(),this.#d&&(c||this.#N(f,s,n),l&&this.#S(l,f)),!o&&this.#c&&this.#o){let d=this.#o,u;for(;u=d?.shift();)this.#m?.(...u)}return this}pop(){try{for(;this.#s;){let e=this.#e[this.#a];if(this.#D(!0),this.#t(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#c&&this.#o){let e=this.#o,t;for(;t=e?.shift();)this.#m?.(...t)}}}#D(e){let t=this.#a,r=this.#i[t],s=this.#e[t];return this.#x&&this.#t(s)?s.__abortController.abort(new Error("evicted")):(this.#_||this.#c)&&(this.#_&&this.#g?.(s,r,"evict"),this.#c&&this.#o?.push([s,r,"evict"])),this.#R(t),e&&(this.#i[t]=void 0,this.#e[t]=void 0,this.#y.push(t)),this.#s===1?(this.#a=this.#n=0,this.#y.length=0):this.#a=this.#h[t],this.#r.delete(r),this.#s--,t}has(e,t={}){let{updateAgeOnHas:r=this.updateAgeOnHas,status:s}=t,n=this.#r.get(e);if(n!==void 0){let o=this.#e[n];if(this.#t(o)&&o.__staleWhileFetching===void 0)return!1;if(this.#p(n))s&&(s.has="stale",this.#S(s,n));else return r&&this.#O(n),s&&(s.has="hit",this.#S(s,n)),!0}else s&&(s.has="miss");return!1}peek(e,t={}){let{allowStale:r=this.allowStale}=t,s=this.#r.get(e);if(s===void 0||!r&&this.#p(s))return;let n=this.#e[s];return this.#t(n)?n.__staleWhileFetching:n}#F(e,t,r,s){let n=t===void 0?void 0:this.#e[t];if(this.#t(n))return n;let o=new V,{signal:a}=r;a?.addEventListener("abort",()=>o.abort(a.reason),{signal:o.signal});let l={signal:o.signal,options:r,context:s},c=(p,w=!1)=>{let{aborted:g}=o.signal,y=r.ignoreFetchAbort&&p!==void 0;if(r.status&&(g&&!w?(r.status.fetchAborted=!0,r.status.fetchError=o.signal.reason,y&&(r.status.fetchAbortIgnored=!0)):r.status.fetchResolved=!0),g&&!y&&!w)return f(o.signal.reason);let O=u;return this.#e[t]===u&&(p===void 0?O.__staleWhileFetching?this.#e[t]=O.__staleWhileFetching:this.#A(e,"fetch"):(r.status&&(r.status.fetchUpdated=!0),this.set(e,p,l.options))),p},h=p=>(r.status&&(r.status.fetchRejected=!0,r.status.fetchError=p),f(p)),f=p=>{let{aborted:w}=o.signal,g=w&&r.allowStaleOnFetchAbort,y=g||r.allowStaleOnFetchRejection,O=y||r.noDeleteOnFetchRejection,T=u;if(this.#e[t]===u&&(!O||T.__staleWhileFetching===void 0?this.#A(e,"fetch"):g||(this.#e[t]=T.__staleWhileFetching)),y)return r.status&&T.__staleWhileFetching!==void 0&&(r.status.returnedStale=!0),T.__staleWhileFetching;if(T.__returned===T)throw p},d=(p,w)=>{let g=this.#P?.(e,n,l);g&&g instanceof Promise&&g.then(y=>p(y===void 0?void 0:y),w),o.signal.addEventListener("abort",()=>{(!r.ignoreFetchAbort||r.allowStaleOnFetchAbort)&&(p(void 0),r.allowStaleOnFetchAbort&&(p=y=>c(y,!0)))})};r.status&&(r.status.fetchDispatched=!0);let u=new Promise(d).then(c,h),E=Object.assign(u,{__abortController:o,__staleWhileFetching:n,__returned:void 0});return t===void 0?(this.set(e,E,{...l.options,status:void 0}),t=this.#r.get(e)):this.#e[t]=E,E}#t(e){if(!this.#x)return!1;let t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof V}async fetch(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:l=0,sizeCalculation:c=this.sizeCalculation,noUpdateTTL:h=this.noUpdateTTL,noDeleteOnFetchRejection:f=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:d=this.allowStaleOnFetchRejection,ignoreFetchAbort:u=this.ignoreFetchAbort,allowStaleOnFetchAbort:E=this.allowStaleOnFetchAbort,context:p,forceRefresh:w=!1,status:g,signal:y}=t;if(!this.#x)return g&&(g.fetch="get"),this.get(e,{allowStale:r,updateAgeOnGet:s,noDeleteOnStaleGet:n,status:g});let O={allowStale:r,updateAgeOnGet:s,noDeleteOnStaleGet:n,ttl:o,noDisposeOnSet:a,size:l,sizeCalculation:c,noUpdateTTL:h,noDeleteOnFetchRejection:f,allowStaleOnFetchRejection:d,allowStaleOnFetchAbort:E,ignoreFetchAbort:u,status:g,signal:y},T=this.#r.get(e);if(T===void 0){g&&(g.fetch="miss");let S=this.#F(e,T,O,p);return S.__returned=S}else{let S=this.#e[T];if(this.#t(S)){let pe=r&&S.__staleWhileFetching!==void 0;return g&&(g.fetch="inflight",pe&&(g.returnedStale=!0)),pe?S.__staleWhileFetching:S.__returned=S}let q=this.#p(T);if(!w&&!q)return g&&(g.fetch="hit"),this.#v(T),s&&this.#O(T),g&&this.#S(g,T),S;let v=this.#F(e,T,O,p),Z=v.__staleWhileFetching!==void 0&&r;return g&&(g.fetch=q?"stale":"refresh",Z&&q&&(g.returnedStale=!0)),Z?v.__staleWhileFetching:v.__returned=v}}async forceFetch(e,t={}){let r=await this.fetch(e,t);if(r===void 0)throw new Error("fetch() returned undefined");return r}memo(e,t={}){let r=this.#L;if(!r)throw new Error("no memoMethod provided to constructor");let{context:s,forceRefresh:n,...o}=t,a=this.get(e,o);if(!n&&a!==void 0)return a;let l=r(e,a,{options:o,context:s});return this.set(e,l,o),l}get(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:o}=t,a=this.#r.get(e);if(a!==void 0){let l=this.#e[a],c=this.#t(l);return o&&this.#S(o,a),this.#p(a)?(o&&(o.get="stale"),c?(o&&r&&l.__staleWhileFetching!==void 0&&(o.returnedStale=!0),r?l.__staleWhileFetching:void 0):(n||this.#A(e,"expire"),o&&r&&(o.returnedStale=!0),r?l:void 0)):(o&&(o.get="hit"),c?l.__staleWhileFetching:(this.#v(a),s&&this.#O(a),l))}else o&&(o.get="miss")}#k(e,t){this.#f[t]=e,this.#h[e]=t}#v(e){e!==this.#n&&(e===this.#a?this.#a=this.#h[e]:this.#k(this.#f[e],this.#h[e]),this.#k(this.#n,e),this.#n=e)}delete(e){return this.#A(e,"delete")}#A(e,t){let r=!1;if(this.#s!==0){let s=this.#r.get(e);if(s!==void 0)if(r=!0,this.#s===1)this.#j(t);else{this.#R(s);let n=this.#e[s];if(this.#t(n)?n.__abortController.abort(new Error("deleted")):(this.#_||this.#c)&&(this.#_&&this.#g?.(n,e,t),this.#c&&this.#o?.push([n,e,t])),this.#r.delete(e),this.#i[s]=void 0,this.#e[s]=void 0,s===this.#n)this.#n=this.#f[s];else if(s===this.#a)this.#a=this.#h[s];else{let o=this.#f[s];this.#h[o]=this.#h[s];let a=this.#h[s];this.#f[a]=this.#f[s]}this.#s--,this.#y.push(s)}}if(this.#c&&this.#o?.length){let s=this.#o,n;for(;n=s?.shift();)this.#m?.(...n)}return r}clear(){return this.#j("delete")}#j(e){for(let t of this.#C({allowStale:!0})){let r=this.#e[t];if(this.#t(r))r.__abortController.abort(new Error("deleted"));else{let s=this.#i[t];this.#_&&this.#g?.(r,s,e),this.#c&&this.#o?.push([r,s,e])}}if(this.#r.clear(),this.#e.fill(void 0),this.#i.fill(void 0),this.#d&&this.#w&&(this.#d.fill(0),this.#w.fill(0)),this.#b&&this.#b.fill(0),this.#a=0,this.#n=0,this.#y.length=0,this.#E=0,this.#s=0,this.#c&&this.#o){let t=this.#o,r;for(;r=t?.shift();)this.#m?.(...r)}}};var qe=require("@duckdb/node-api");var Te=me(require("vm"),1),re=class{add(e,t,r){if(typeof arguments[0]!="string")for(let s in arguments[0])this.add(s,arguments[0][s],arguments[1]);else(Array.isArray(e)?e:[e]).forEach(function(s){this[s]=this[s]||[],t&&this[s][r?"unshift":"push"](t)},this)}run(e,t){this[e]=this[e]||[],this[e].forEach(function(r){r.call(t&&t.context?t.context:t,t)})}},se=class{constructor(e){this.jsep=e,this.registered={}}register(...e){e.forEach(t=>{if(typeof t!="object"||!t.name||!t.init)throw new Error("Invalid JSEP plugin format");this.registered[t.name]||(t.init(this.jsep),this.registered[t.name]=t)})}},A=class i{static get version(){return"1.4.0"}static toString(){return"JavaScript Expression Parser (JSEP) v"+i.version}static addUnaryOp(e){return i.max_unop_len=Math.max(e.length,i.max_unop_len),i.unary_ops[e]=1,i}static addBinaryOp(e,t,r){return i.max_binop_len=Math.max(e.length,i.max_binop_len),i.binary_ops[e]=t,r?i.right_associative.add(e):i.right_associative.delete(e),i}static addIdentifierChar(e){return i.additional_identifier_chars.add(e),i}static addLiteral(e,t){return i.literals[e]=t,i}static removeUnaryOp(e){return delete i.unary_ops[e],e.length===i.max_unop_len&&(i.max_unop_len=i.getMaxKeyLen(i.unary_ops)),i}static removeAllUnaryOps(){return i.unary_ops={},i.max_unop_len=0,i}static removeIdentifierChar(e){return i.additional_identifier_chars.delete(e),i}static removeBinaryOp(e){return delete i.binary_ops[e],e.length===i.max_binop_len&&(i.max_binop_len=i.getMaxKeyLen(i.binary_ops)),i.right_associative.delete(e),i}static removeAllBinaryOps(){return i.binary_ops={},i.max_binop_len=0,i}static removeLiteral(e){return delete i.literals[e],i}static removeAllLiterals(){return i.literals={},i}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(e){this.expr=e,this.index=0}static parse(e){return new i(e).parse()}static getMaxKeyLen(e){return Math.max(0,...Object.keys(e).map(t=>t.length))}static isDecimalDigit(e){return e>=48&&e<=57}static binaryPrecedence(e){return i.binary_ops[e]||0}static isIdentifierStart(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!i.binary_ops[String.fromCharCode(e)]||i.additional_identifier_chars.has(String.fromCharCode(e))}static isIdentifierPart(e){return i.isIdentifierStart(e)||i.isDecimalDigit(e)}throwError(e){let t=new Error(e+" at character "+this.index);throw t.index=this.index,t.description=e,t}runHook(e,t){if(i.hooks[e]){let r={context:this,node:t};return i.hooks.run(e,r),r.node}return t}searchHook(e){if(i.hooks[e]){let t={context:this};return i.hooks[e].find(function(r){return r.call(t.context,t),t.node}),t.node}}gobbleSpaces(){let e=this.code;for(;e===i.SPACE_CODE||e===i.TAB_CODE||e===i.LF_CODE||e===i.CR_CODE;)e=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");let e=this.gobbleExpressions(),t=e.length===1?e[0]:{type:i.COMPOUND,body:e};return this.runHook("after-all",t)}gobbleExpressions(e){let t=[],r,s;for(;this.index<this.expr.length;)if(r=this.code,r===i.SEMCOL_CODE||r===i.COMMA_CODE)this.index++;else if(s=this.gobbleExpression())t.push(s);else if(this.index<this.expr.length){if(r===e)break;this.throwError('Unexpected "'+this.char+'"')}return t}gobbleExpression(){let e=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",e)}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,i.max_binop_len),t=e.length;for(;t>0;){if(i.binary_ops.hasOwnProperty(e)&&(!i.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!i.isIdentifierPart(this.expr.charCodeAt(this.index+e.length))))return this.index+=t,e;e=e.substr(0,--t)}return!1}gobbleBinaryExpression(){let e,t,r,s,n,o,a,l,c;if(o=this.gobbleToken(),!o||(t=this.gobbleBinaryOp(),!t))return o;for(n={value:t,prec:i.binaryPrecedence(t),right_a:i.right_associative.has(t)},a=this.gobbleToken(),a||this.throwError("Expected expression after "+t),s=[o,n,a];t=this.gobbleBinaryOp();){if(r=i.binaryPrecedence(t),r===0){this.index-=t.length;break}n={value:t,prec:r,right_a:i.right_associative.has(t)},c=t;let h=f=>n.right_a&&f.right_a?r>f.prec:r<=f.prec;for(;s.length>2&&h(s[s.length-2]);)a=s.pop(),t=s.pop().value,o=s.pop(),e={type:i.BINARY_EXP,operator:t,left:o,right:a},s.push(e);e=this.gobbleToken(),e||this.throwError("Expected expression after "+c),s.push(n,e)}for(l=s.length-1,e=s[l];l>1;)e={type:i.BINARY_EXP,operator:s[l-1].value,left:s[l-2],right:e},l-=2;return e}gobbleToken(){let e,t,r,s;if(this.gobbleSpaces(),s=this.searchHook("gobble-token"),s)return this.runHook("after-token",s);if(e=this.code,i.isDecimalDigit(e)||e===i.PERIOD_CODE)return this.gobbleNumericLiteral();if(e===i.SQUOTE_CODE||e===i.DQUOTE_CODE)s=this.gobbleStringLiteral();else if(e===i.OBRACK_CODE)s=this.gobbleArray();else{for(t=this.expr.substr(this.index,i.max_unop_len),r=t.length;r>0;){if(i.unary_ops.hasOwnProperty(t)&&(!i.isIdentifierStart(this.code)||this.index+t.length<this.expr.length&&!i.isIdentifierPart(this.expr.charCodeAt(this.index+t.length)))){this.index+=r;let n=this.gobbleToken();return n||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:i.UNARY_EXP,operator:t,argument:n,prefix:!0})}t=t.substr(0,--r)}i.isIdentifierStart(e)?(s=this.gobbleIdentifier(),i.literals.hasOwnProperty(s.name)?s={type:i.LITERAL,value:i.literals[s.name],raw:s.name}:s.name===i.this_str&&(s={type:i.THIS_EXP})):e===i.OPAREN_CODE&&(s=this.gobbleGroup())}return s?(s=this.gobbleTokenProperty(s),this.runHook("after-token",s)):this.runHook("after-token",!1)}gobbleTokenProperty(e){this.gobbleSpaces();let t=this.code;for(;t===i.PERIOD_CODE||t===i.OBRACK_CODE||t===i.OPAREN_CODE||t===i.QUMARK_CODE;){let r;if(t===i.QUMARK_CODE){if(this.expr.charCodeAt(this.index+1)!==i.PERIOD_CODE)break;r=!0,this.index+=2,this.gobbleSpaces(),t=this.code}this.index++,t===i.OBRACK_CODE?(e={type:i.MEMBER_EXP,computed:!0,object:e,property:this.gobbleExpression()},e.property||this.throwError('Unexpected "'+this.char+'"'),this.gobbleSpaces(),t=this.code,t!==i.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):t===i.OPAREN_CODE?e={type:i.CALL_EXP,arguments:this.gobbleArguments(i.CPAREN_CODE),callee:e}:(t===i.PERIOD_CODE||r)&&(r&&this.index--,this.gobbleSpaces(),e={type:i.MEMBER_EXP,computed:!1,object:e,property:this.gobbleIdentifier()}),r&&(e.optional=!0),this.gobbleSpaces(),t=this.code}return e}gobbleNumericLiteral(){let e="",t,r;for(;i.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(this.code===i.PERIOD_CODE)for(e+=this.expr.charAt(this.index++);i.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(t=this.char,t==="e"||t==="E"){for(e+=this.expr.charAt(this.index++),t=this.char,(t==="+"||t==="-")&&(e+=this.expr.charAt(this.index++));i.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);i.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+e+this.char+")")}return r=this.code,i.isIdentifierStart(r)?this.throwError("Variable names cannot start with a number ("+e+this.char+")"):(r===i.PERIOD_CODE||e.length===1&&e.charCodeAt(0)===i.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:i.LITERAL,value:parseFloat(e),raw:e}}gobbleStringLiteral(){let e="",t=this.index,r=this.expr.charAt(this.index++),s=!1;for(;this.index<this.expr.length;){let n=this.expr.charAt(this.index++);if(n===r){s=!0;break}else if(n==="\\")switch(n=this.expr.charAt(this.index++),n){case"n":e+=`
`;break;case"r":e+="\r";break;case"t":e+="	";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=n}else e+=n}return s||this.throwError('Unclosed quote after "'+e+'"'),{type:i.LITERAL,value:e,raw:this.expr.substring(t,this.index)}}gobbleIdentifier(){let e=this.code,t=this.index;for(i.isIdentifierStart(e)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(e=this.code,i.isIdentifierPart(e));)this.index++;return{type:i.IDENTIFIER,name:this.expr.slice(t,this.index)}}gobbleArguments(e){let t=[],r=!1,s=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let n=this.code;if(n===e){r=!0,this.index++,e===i.CPAREN_CODE&&s&&s>=t.length&&this.throwError("Unexpected token "+String.fromCharCode(e));break}else if(n===i.COMMA_CODE){if(this.index++,s++,s!==t.length){if(e===i.CPAREN_CODE)this.throwError("Unexpected token ,");else if(e===i.CBRACK_CODE)for(let o=t.length;o<s;o++)t.push(null)}}else if(t.length!==s&&s!==0)this.throwError("Expected comma");else{let o=this.gobbleExpression();(!o||o.type===i.COMPOUND)&&this.throwError("Expected comma"),t.push(o)}}return r||this.throwError("Expected "+String.fromCharCode(e)),t}gobbleGroup(){this.index++;let e=this.gobbleExpressions(i.CPAREN_CODE);if(this.code===i.CPAREN_CODE)return this.index++,e.length===1?e[0]:e.length?{type:i.SEQUENCE_EXP,expressions:e}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:i.ARRAY_EXP,elements:this.gobbleArguments(i.CBRACK_CODE)}}},Je=new re;Object.assign(A,{hooks:Je,plugins:new se(A),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"??":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10,"**":11},right_associative:new Set(["**"]),additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});A.max_unop_len=A.getMaxKeyLen(A.unary_ops);A.max_binop_len=A.getMaxKeyLen(A.binary_ops);var R=i=>new A(i).parse(),Xe=Object.getOwnPropertyNames(class{});Object.getOwnPropertyNames(A).filter(i=>!Xe.includes(i)&&R[i]===void 0).forEach(i=>{R[i]=A[i]});R.Jsep=A;var Ye="ConditionalExpression",Ze={name:"ternary",init(i){i.hooks.add("after-expression",function(t){if(t.node&&this.code===i.QUMARK_CODE){this.index++;let r=t.node,s=this.gobbleExpression();if(s||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===i.COLON_CODE){this.index++;let n=this.gobbleExpression();if(n||this.throwError("Expected expression"),t.node={type:Ye,test:r,consequent:s,alternate:n},r.operator&&i.binary_ops[r.operator]<=.9){let o=r;for(;o.right.operator&&i.binary_ops[o.right.operator]<=.9;)o=o.right;t.node.test=o.right,o.right=t.node,t.node=r}}else this.throwError("Expected :")}})}};R.plugins.register(Ze);var _e=47,et=92,tt={name:"regex",init(i){i.hooks.add("gobble-token",function(t){if(this.code===_e){let r=++this.index,s=!1;for(;this.index<this.expr.length;){if(this.code===_e&&!s){let n=this.expr.slice(r,this.index),o="";for(;++this.index<this.expr.length;){let l=this.code;if(l>=97&&l<=122||l>=65&&l<=90||l>=48&&l<=57)o+=this.char;else break}let a;try{a=new RegExp(n,o)}catch(l){this.throwError(l.message)}return t.node={type:i.LITERAL,value:a,raw:this.expr.slice(r-1,this.index)},t.node=this.gobbleTokenProperty(t.node),t.node}this.code===i.OBRACK_CODE?s=!0:s&&this.code===i.CBRACK_CODE&&(s=!1),this.index+=this.code===et?2:1}this.throwError("Unclosed Regex")}})}},ie=43,it=45,M={name:"assignment",assignmentOperators:new Set(["=","*=","**=","/=","%=","+=","-=","<<=",">>=",">>>=","&=","^=","|=","||=","&&=","??="]),updateOperators:[ie,it],assignmentPrecedence:.9,init(i){let e=[i.IDENTIFIER,i.MEMBER_EXP];M.assignmentOperators.forEach(r=>i.addBinaryOp(r,M.assignmentPrecedence,!0)),i.hooks.add("gobble-token",function(s){let n=this.code;M.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(this.index+=2,s.node={type:"UpdateExpression",operator:n===ie?"++":"--",argument:this.gobbleTokenProperty(this.gobbleIdentifier()),prefix:!0},(!s.node.argument||!e.includes(s.node.argument.type))&&this.throwError(`Unexpected ${s.node.operator}`))}),i.hooks.add("after-token",function(s){if(s.node){let n=this.code;M.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(e.includes(s.node.type)||this.throwError(`Unexpected ${s.node.operator}`),this.index+=2,s.node={type:"UpdateExpression",operator:n===ie?"++":"--",argument:s.node,prefix:!1})}}),i.hooks.add("after-expression",function(s){s.node&&t(s.node)});function t(r){M.assignmentOperators.has(r.operator)?(r.type="AssignmentExpression",t(r.left),t(r.right)):r.operator||Object.values(r).forEach(s=>{s&&typeof s=="object"&&t(s)})}}};R.plugins.register(tt,M);R.addUnaryOp("typeof");R.addLiteral("null",null);R.addLiteral("undefined",void 0);var rt=new Set(["constructor","__proto__","__defineGetter__","__defineSetter__"]),b={evalAst(i,e){switch(i.type){case"BinaryExpression":case"LogicalExpression":return b.evalBinaryExpression(i,e);case"Compound":return b.evalCompound(i,e);case"ConditionalExpression":return b.evalConditionalExpression(i,e);case"Identifier":return b.evalIdentifier(i,e);case"Literal":return b.evalLiteral(i,e);case"MemberExpression":return b.evalMemberExpression(i,e);case"UnaryExpression":return b.evalUnaryExpression(i,e);case"ArrayExpression":return b.evalArrayExpression(i,e);case"CallExpression":return b.evalCallExpression(i,e);case"AssignmentExpression":return b.evalAssignmentExpression(i,e);default:throw SyntaxError("Unexpected expression",i)}},evalBinaryExpression(i,e){return{"||":(r,s)=>r||s(),"&&":(r,s)=>r&&s(),"|":(r,s)=>r|s(),"^":(r,s)=>r^s(),"&":(r,s)=>r&s(),"==":(r,s)=>r==s(),"!=":(r,s)=>r!=s(),"===":(r,s)=>r===s(),"!==":(r,s)=>r!==s(),"<":(r,s)=>r<s(),">":(r,s)=>r>s(),"<=":(r,s)=>r<=s(),">=":(r,s)=>r>=s(),"<<":(r,s)=>r<<s(),">>":(r,s)=>r>>s(),">>>":(r,s)=>r>>>s(),"+":(r,s)=>r+s(),"-":(r,s)=>r-s(),"*":(r,s)=>r*s(),"/":(r,s)=>r/s(),"%":(r,s)=>r%s()}[i.operator](b.evalAst(i.left,e),()=>b.evalAst(i.right,e))},evalCompound(i,e){let t;for(let r=0;r<i.body.length;r++){i.body[r].type==="Identifier"&&["var","let","const"].includes(i.body[r].name)&&i.body[r+1]&&i.body[r+1].type==="AssignmentExpression"&&(r+=1);let s=i.body[r];t=b.evalAst(s,e)}return t},evalConditionalExpression(i,e){return b.evalAst(i.test,e)?b.evalAst(i.consequent,e):b.evalAst(i.alternate,e)},evalIdentifier(i,e){if(Object.hasOwn(e,i.name))return e[i.name];throw ReferenceError(`${i.name} is not defined`)},evalLiteral(i){return i.value},evalMemberExpression(i,e){let t=i.computed?b.evalAst(i.property):i.property.name,r=b.evalAst(i.object,e);if(r==null)throw TypeError(`Cannot read properties of ${r} (reading '${t}')`);if(!Object.hasOwn(r,t)&&rt.has(t))throw TypeError(`Cannot read properties of ${r} (reading '${t}')`);let s=r[t];return typeof s=="function"?s.bind(r):s},evalUnaryExpression(i,e){return{"-":r=>-b.evalAst(r,e),"!":r=>!b.evalAst(r,e),"~":r=>~b.evalAst(r,e),"+":r=>+b.evalAst(r,e),typeof:r=>typeof b.evalAst(r,e)}[i.operator](i.argument)},evalArrayExpression(i,e){return i.elements.map(t=>b.evalAst(t,e))},evalCallExpression(i,e){let t=i.arguments.map(s=>b.evalAst(s,e));return b.evalAst(i.callee,e)(...t)},evalAssignmentExpression(i,e){if(i.left.type!=="Identifier")throw SyntaxError("Invalid left-hand side in assignment");let t=i.left.name,r=b.evalAst(i.right,e);return e[t]=r,e[t]}},ne=class{constructor(e){this.code=e,this.ast=R(this.code)}runInNewContext(e){let t=Object.assign(Object.create(null),e);return b.evalAst(this.ast,t)}};function L(i,e){return i=i.slice(),i.push(e),i}function oe(i,e){return e=e.slice(),e.unshift(i),e}var ae=class extends Error{constructor(e){super('JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),this.avoidNew=!0,this.value=e,this.name="NewError"}};function m(i,e,t,r,s){if(!(this instanceof m))try{return new m(i,e,t,r,s)}catch(o){if(!o.avoidNew)throw o;return o.value}typeof i=="string"&&(s=r,r=t,t=e,e=i,i=null);let n=i&&typeof i=="object";if(i=i||{},this.json=i.json||t,this.path=i.path||e,this.resultType=i.resultType||"value",this.flatten=i.flatten||!1,this.wrap=Object.hasOwn(i,"wrap")?i.wrap:!0,this.sandbox=i.sandbox||{},this.eval=i.eval===void 0?"safe":i.eval,this.ignoreEvalErrors=typeof i.ignoreEvalErrors>"u"?!1:i.ignoreEvalErrors,this.parent=i.parent||null,this.parentProperty=i.parentProperty||null,this.callback=i.callback||r||null,this.otherTypeCallback=i.otherTypeCallback||s||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},i.autostart!==!1){let o={path:n?i.path:e};n?"json"in i&&(o.json=i.json):o.json=t;let a=this.evaluate(o);if(!a||typeof a!="object")throw new ae(a);return a}}m.prototype.evaluate=function(i,e,t,r){let s=this.parent,n=this.parentProperty,{flatten:o,wrap:a}=this;if(this.currResultType=this.resultType,this.currEval=this.eval,this.currSandbox=this.sandbox,t=t||this.callback,this.currOtherTypeCallback=r||this.otherTypeCallback,e=e||this.json,i=i||this.path,i&&typeof i=="object"&&!Array.isArray(i)){if(!i.path&&i.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!Object.hasOwn(i,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');({json:e}=i),o=Object.hasOwn(i,"flatten")?i.flatten:o,this.currResultType=Object.hasOwn(i,"resultType")?i.resultType:this.currResultType,this.currSandbox=Object.hasOwn(i,"sandbox")?i.sandbox:this.currSandbox,a=Object.hasOwn(i,"wrap")?i.wrap:a,this.currEval=Object.hasOwn(i,"eval")?i.eval:this.currEval,t=Object.hasOwn(i,"callback")?i.callback:t,this.currOtherTypeCallback=Object.hasOwn(i,"otherTypeCallback")?i.otherTypeCallback:this.currOtherTypeCallback,s=Object.hasOwn(i,"parent")?i.parent:s,n=Object.hasOwn(i,"parentProperty")?i.parentProperty:n,i=i.path}if(s=s||null,n=n||null,Array.isArray(i)&&(i=m.toPathString(i)),!i&&i!==""||!e)return;let l=m.toPathArray(i);l[0]==="$"&&l.length>1&&l.shift(),this._hasParentSelector=null;let c=this._trace(l,e,["$"],s,n,t).filter(function(h){return h&&!h.isParentSelector});return c.length?!a&&c.length===1&&!c[0].hasArrExpr?this._getPreferredOutput(c[0]):c.reduce((h,f)=>{let d=this._getPreferredOutput(f);return o&&Array.isArray(d)?h=h.concat(d):h.push(d),h},[]):a?[]:void 0};m.prototype._getPreferredOutput=function(i){let e=this.currResultType;switch(e){case"all":{let t=Array.isArray(i.path)?i.path:m.toPathArray(i.path);return i.pointer=m.toPointer(t),i.path=typeof i.path=="string"?i.path:m.toPathString(i.path),i}case"value":case"parent":case"parentProperty":return i[e];case"path":return m.toPathString(i[e]);case"pointer":return m.toPointer(i.path);default:throw new TypeError("Unknown result type")}};m.prototype._handleCallback=function(i,e,t){if(e){let r=this._getPreferredOutput(i);i.path=typeof i.path=="string"?i.path:m.toPathString(i.path),e(r,t,i)}};m.prototype._trace=function(i,e,t,r,s,n,o,a){let l;if(!i.length)return l={path:t,value:e,parent:r,parentProperty:s,hasArrExpr:o},this._handleCallback(l,n,"value"),l;let c=i[0],h=i.slice(1),f=[];function d(u){Array.isArray(u)?u.forEach(E=>{f.push(E)}):f.push(u)}if((typeof c!="string"||a)&&e&&Object.hasOwn(e,c))d(this._trace(h,e[c],L(t,c),e,c,n,o));else if(c==="*")this._walk(e,u=>{d(this._trace(h,e[u],L(t,u),e,u,n,!0,!0))});else if(c==="..")d(this._trace(h,e,t,r,s,n,o)),this._walk(e,u=>{typeof e[u]=="object"&&d(this._trace(i.slice(),e[u],L(t,u),e,u,n,!0))});else{if(c==="^")return this._hasParentSelector=!0,{path:t.slice(0,-1),expr:h,isParentSelector:!0};if(c==="~")return l={path:L(t,c),value:s,parent:r,parentProperty:null},this._handleCallback(l,n,"property"),l;if(c==="$")d(this._trace(h,e,t,null,null,n,o));else if(/^(-?\d*):(-?\d*):?(\d*)$/u.test(c))d(this._slice(c,h,e,t,r,s,n));else if(c.indexOf("?(")===0){if(this.currEval===!1)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");let u=c.replace(/^\?\((.*?)\)$/u,"$1"),E=/@.?([^?]*)[['](\??\(.*?\))(?!.\)\])[\]']/gu.exec(u);E?this._walk(e,p=>{let w=[E[2]],g=E[1]?e[p][E[1]]:e[p];this._trace(w,g,t,r,s,n,!0).length>0&&d(this._trace(h,e[p],L(t,p),e,p,n,!0))}):this._walk(e,p=>{this._eval(u,e[p],p,t,r,s)&&d(this._trace(h,e[p],L(t,p),e,p,n,!0))})}else if(c[0]==="("){if(this.currEval===!1)throw new Error("Eval [(expr)] prevented in JSONPath expression.");d(this._trace(oe(this._eval(c,e,t.at(-1),t.slice(0,-1),r,s),h),e,t,r,s,n,o))}else if(c[0]==="@"){let u=!1,E=c.slice(1,-2);switch(E){case"scalar":(!e||!["object","function"].includes(typeof e))&&(u=!0);break;case"boolean":case"string":case"undefined":case"function":typeof e===E&&(u=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(u=!0);break;case"number":Number.isFinite(e)&&(u=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(u=!0);break;case"object":e&&typeof e===E&&(u=!0);break;case"array":Array.isArray(e)&&(u=!0);break;case"other":u=this.currOtherTypeCallback(e,t,r,s);break;case"null":e===null&&(u=!0);break;default:throw new TypeError("Unknown value type "+E)}if(u)return l={path:t,value:e,parent:r,parentProperty:s},this._handleCallback(l,n,"value"),l}else if(c[0]==="`"&&e&&Object.hasOwn(e,c.slice(1))){let u=c.slice(1);d(this._trace(h,e[u],L(t,u),e,u,n,o,!0))}else if(c.includes(",")){let u=c.split(",");for(let E of u)d(this._trace(oe(E,h),e,t,r,s,n,!0))}else!a&&e&&Object.hasOwn(e,c)&&d(this._trace(h,e[c],L(t,c),e,c,n,o,!0))}if(this._hasParentSelector)for(let u=0;u<f.length;u++){let E=f[u];if(E&&E.isParentSelector){let p=this._trace(E.expr,e,E.path,r,s,n,o);if(Array.isArray(p)){f[u]=p[0];let w=p.length;for(let g=1;g<w;g++)u++,f.splice(u,0,p[g])}else f[u]=p}}return f};m.prototype._walk=function(i,e){if(Array.isArray(i)){let t=i.length;for(let r=0;r<t;r++)e(r)}else i&&typeof i=="object"&&Object.keys(i).forEach(t=>{e(t)})};m.prototype._slice=function(i,e,t,r,s,n,o){if(!Array.isArray(t))return;let a=t.length,l=i.split(":"),c=l[2]&&Number.parseInt(l[2])||1,h=l[0]&&Number.parseInt(l[0])||0,f=l[1]&&Number.parseInt(l[1])||a;h=h<0?Math.max(0,h+a):Math.min(a,h),f=f<0?Math.max(0,f+a):Math.min(a,f);let d=[];for(let u=h;u<f;u+=c)this._trace(oe(u,e),t,r,s,n,o,!0).forEach(p=>{d.push(p)});return d};m.prototype._eval=function(i,e,t,r,s,n){this.currSandbox._$_parentProperty=n,this.currSandbox._$_parent=s,this.currSandbox._$_property=t,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;let o=i.includes("@path");o&&(this.currSandbox._$_path=m.toPathString(r.concat([t])));let a=this.currEval+"Script:"+i;if(!m.cache[a]){let l=i.replaceAll("@parentProperty","_$_parentProperty").replaceAll("@parent","_$_parent").replaceAll("@property","_$_property").replaceAll("@root","_$_root").replaceAll(/@([.\s)[])/gu,"_$_v$1");if(o&&(l=l.replaceAll("@path","_$_path")),this.currEval==="safe"||this.currEval===!0||this.currEval===void 0)m.cache[a]=new this.safeVm.Script(l);else if(this.currEval==="native")m.cache[a]=new this.vm.Script(l);else if(typeof this.currEval=="function"&&this.currEval.prototype&&Object.hasOwn(this.currEval.prototype,"runInNewContext")){let c=this.currEval;m.cache[a]=new c(l)}else if(typeof this.currEval=="function")m.cache[a]={runInNewContext:c=>this.currEval(l,c)};else throw new TypeError(`Unknown "eval" property "${this.currEval}"`)}try{return m.cache[a].runInNewContext(this.currSandbox)}catch(l){if(this.ignoreEvalErrors)return!1;throw new Error("jsonPath: "+l.message+": "+i)}};m.cache={};m.toPathString=function(i){let e=i,t=e.length,r="$";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(r+=/^[0-9*]+$/u.test(e[s])?"["+e[s]+"]":"['"+e[s]+"']");return r};m.toPointer=function(i){let e=i,t=e.length,r="";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(r+="/"+e[s].toString().replaceAll("~","~0").replaceAll("/","~1"));return r};m.toPathArray=function(i){let{cache:e}=m;if(e[i])return e[i].concat();let t=[],s=i.replaceAll(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/gu,";$&;").replaceAll(/[['](\??\(.*?\))[\]'](?!.\])/gu,function(n,o){return"[#"+(t.push(o)-1)+"]"}).replaceAll(/\[['"]([^'\]]*)['"]\]/gu,function(n,o){return"['"+o.replaceAll(".","%@%").replaceAll("~","%%@@%%")+"']"}).replaceAll("~",";~;").replaceAll(/['"]?\.['"]?(?![^[]*\])|\[['"]?/gu,";").replaceAll("%@%",".").replaceAll("%%@@%%","~").replaceAll(/(?:;)?(\^+)(?:;)?/gu,function(n,o){return";"+o.split("").join(";")+";"}).replaceAll(/;;;|;;/gu,";..;").replaceAll(/;$|'?\]|'$/gu,"").split(";").map(function(n){let o=n.match(/#(\d+)/u);return!o||!o[1]?n:t[o[1]]});return e[i]=s,e[i].concat()};m.prototype.safeVm={Script:ne};m.prototype.vm=Te.default;function I(i){return(...e)=>{let t=process.env.DEBUG;t&&i.startsWith(t.replace("*",""))&&console.log(i,e)}}var D=I("glue-table-cache:sql"),k=I("glue-table-cache:sql:ast"),F=class{constructor(e){this.db=e}async getQueryAST(e){let t=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;D("Serializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to serialize SQL query");let n=JSON.parse(s[0][0]);if(n.error)throw new Error(JSON.stringify(n));return n}async getSqlFromAst(e){let t=`SELECT json_deserialize_sql('${JSON.stringify(e).replace(/'/g,"''")}')`;D("Deserializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to deserialize SQL query");return s[0][0]+";"}async transformGlueTableQuery(e){D("Transforming query: %s",e);let t=await this.getQueryAST(e);k("Original AST: %O",t),this.transformNode(t),k("Transformed AST: %O",t);let r=await this.getSqlFromAst(t);return D("Transformed query: %s",r),r}async getQueryGlueTableRefs(e){let t=await this.getQueryAST(e);return k("Original AST: %O",t),this.getAstGlueTableRefs(t)}getAstGlueTableRefs(e){return this.getAstTableRefs(e).map(t=>t.tableRef).filter(Boolean)}getAstTableRefs(e){return m({path:"$..*[?(@ && @.type=='BASE_TABLE' && (@.catalog_name=='glue' || @.catalog_name=='GLUE'))]",json:e}).map(n=>({node:n,tableRef:this.getGlueTableRef(n)}))}transformNode(e){D("Finding Glue table references in AST"),k("AST structure:",e);let t=this.getAstTableRefs(e);D("Found %d Glue table references",t.length),k("Table references:",t),m({path:"$..query_location",json:e,resultType:"pointer"}).forEach(s=>{let n=s.split("/").filter(Boolean);n.pop();let o=e;for(let a of n)o=o[a];o&&(o.query_location=void 0)});for(let s of t){let n=s.tableRef;n&&(D("Transforming table reference %s.%s",n.database,n.table),Object.assign(s.node,{type:"TABLE_FUNCTION",function:{class:"FUNCTION",type:"FUNCTION",function_name:"parquet_scan",schema:"",catalog:"",children:[{class:"FUNCTION",type:"FUNCTION",function_name:"getvariable",schema:"",catalog:"",children:[{class:"CONSTANT",type:"VALUE_CONSTANT",value:{type:{id:"VARCHAR",type_info:null},is_null:!1,value:this.getQueryFilesVarName(n.database,n.table)}}]}],filter:null,order_bys:{type:"ORDER_MODIFIER",orders:[]},distinct:!1,is_operator:!1,export_state:!1}}))}}getGlueTableRef(e){return e.type==="BASE_TABLE"&&(e.catalog_name==="glue"||e.catalog_name==="GLUE")?{database:e.schema_name||"default",table:e.table_name}:null}async extractPartitionFilters(e,t){let r=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;D("Serializing SQL: %s",r);let n=(await this.db.runAndReadAll(r)).getRows();if(!n.length||n[0].length===0||n[0][0]===null)throw new Error("Failed to serialize SQL query");let o=JSON.parse(n[0][0]);if(o.error)throw new Error(JSON.stringify(o));k("Original AST: %O",o);let a=new Set;return o?.statements?.[0]?.node?.where_clause&&this.extractFiltersFromCondition(o.statements[0].node.where_clause,t,a),Array.from(a)}findPartitionFilters(e,t,r,s){if(!(!e||typeof e!="object")){e.type==="SELECT"&&e.where&&this.extractFiltersFromCondition(e.where,r,s);for(let n in e)Array.isArray(e[n])?e[n].forEach(o=>this.findPartitionFilters(o,t,r,s)):typeof e[n]=="object"&&this.findPartitionFilters(e[n],t,r,s)}}extractFiltersFromCondition(e,t,r){if(!(!e||typeof e!="object")){if(e.class==="COMPARISON"){let s=e.left,n=e.right;if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])&&n?.class==="CONSTANT"&&n?.type==="VALUE_CONSTANT"){let o=n.value?.value;if(o!==void 0){let a=this.getComparisonOperator(e.type),l=typeof o=="string"?`'${o}'`:o;r.add(`${s.column_names[0]} ${a} ${l}`)}}}else if(e.class==="CONJUNCTION")e.children?.forEach(s=>this.extractFiltersFromCondition(s,t,r));else if(e.class==="OPERATOR"&&e.type==="COMPARE_IN"){let s=e.children?.[0];if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])){let n=e.children.slice(1).filter(o=>o.class==="CONSTANT"&&o.type==="VALUE_CONSTANT").map(o=>`'${o.value.value}'`);n.length>0&&r.add(`${s.column_names[0]} IN (${n.join(", ")})`)}}}}getComparisonOperator(e){switch(e){case"COMPARE_EQUAL":return"=";case"COMPARE_GREATERTHAN":return">";case"COMPARE_LESSTHAN":return"<";case"COMPARE_GREATERTHANOREQUALTO":return">=";case"COMPARE_LESSTHANOREQUALTO":return"<=";case"COMPARE_NOTEQUAL":return"!=";default:throw new Error(`Unsupported comparison type: ${e}`)}}getQueryFilesVarName(e,t){return`${e}_${t}_files`.replaceAll("-","")}getGlueTableFilesVarName(e,t){return`${e}_${t}_gview_files`.replaceAll("-","")}getGlueTableViewName(e,t){return`GLUE__${e}_${t}`.replaceAll("-","")}async getGlueTableViewSql(e,t=1){let r=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`,n=(await this.db.runAndReadAll(r)).getRows();if(!n.length||n[0].length===0||n[0][0]===null)throw new Error("Failed to serialize SQL query");let o=JSON.parse(n[0][0]);if(o.error)throw new Error(JSON.stringify(o));let a=this.getAstGlueTableRefs(o);if(!a.length)throw new Error("No Glue table references found in query");let l=[],c=new Set;for(let h of a){let f=this.getGlueTableFilesVarName(h.database,h.table),d=`${h.database}_${h.table}`;if(!c.has(d)){c.add(d);let u=this.getGlueTableViewName(h.database,h.table),E=t?`SELECT * FROM parquet_scan(getvariable('${f}'))`:"SELECT NULL LIMIT 0";l.push(`CREATE OR REPLACE VIEW ${u} AS ${E};`)}}return l}};var Ce=require("@aws-sdk/client-s3");function st(i){let e=new URL(i);if(!i.startsWith("s3://")&&!i.startsWith("S3://"))throw new Error(`Not an S3 URL: ${e.protocol}`);return{bucket:e.hostname,prefix:e.pathname.substring(1)}}function nt(i,e){let t={};for(let r of e){let s=i.match(new RegExp(`${r}=([^/]+)`));s&&(t[r]=s[1])}return t}function le(i,e){return i.map(t=>({path:t,partitionValues:nt(t,e)}))}async function Ae(i,e,t){let{bucket:r,prefix:s}=st(e),n=[],o=s.endsWith("/")?s:`${s}/`,a;do{let l=new Ce.ListObjectsV2Command({Bucket:r,Prefix:o,ContinuationToken:a}),c=await i.send(l);n.push(...c.Contents?.map(h=>`s3://${r}/${h.Key}`).filter(h=>!h.endsWith("_$folder$"))??[]),a=c.NextContinuationToken}while(a);return le(n.filter(Boolean),t)}var H=require("@aws-sdk/client-glue");var at=I("glue-api");function lt(i){let e=i.Parameters??{};return e.table_type==="ICEBERG"?"ICEBERG":e["projection.enabled"]==="true"?"GLUE_PROJECTED":i.PartitionKeys&&i.PartitionKeys.length?"HIVE":"UNPARTITIONED"}async function Se(i,e,t){try{let r={DatabaseName:e,Name:t},n=(await i.send(new H.GetTableCommand(r))).Table;if(!n)throw new Error(`Table ${e}.${t} not found`);let o=lt(n),a={timestamp:Date.now(),table:n,tableType:o};return o==="GLUE_PROJECTED"&&n.Parameters?a.projectionPatterns=ct(n.Parameters):o==="HIVE"&&(a.partitionMetadata=await ut(i,e,t)),a}catch(r){throw at("getGlueTableMetadata ERROR:",r),r}}function ht(i,e){switch(i){case"type":return e;case"format":return e;case"range":try{return JSON.parse(e)}catch{return e.split(",").map(t=>t.trim())}case"values":return JSON.parse(e);default:return e}}function ct(i){let e={};return Object.entries(i).filter(([t])=>t.startsWith("projection.")).forEach(([t,r])=>{let s=t.match(/projection\.(\w+)\.(type|range|format|values)/);if(s){let[n,o,a]=s;e[o]||(e[o]={type:"enum"}),(a==="type"||a==="format"||a==="range"||a==="values")&&(e[o][a]=ht(a,r))}}),{enabled:!0,patterns:e}}async function ut(i,e,t){let r=new H.GetPartitionsCommand({DatabaseName:e,TableName:t});try{let s=await i.send(r);return!s.Partitions||s.Partitions.length===0?{keys:[],values:[]}:{keys:s.Partitions[0].Values||[],values:s.Partitions.map(n=>({values:n.Values||[],location:n.StorageDescriptor?.Location}))||[]}}catch(s){return console.warn(`Failed to load partitions for ${e}_${t}:`,s),{keys:[],values:[]}}}async function xe(i,e){if(e.projectionPatterns?.enabled){let t=e.projectionPatterns.patterns[i];if(!t)throw new Error(`No projection pattern found for partition key ${i}`);switch(t.type){case"date":let r=t.format||"yyyy-MM-dd";return`regexp_extract(path, '(${ft(r)})', 1)`;case"integer":return"CAST(regexp_extract(path, '/([0-9]+)/', 1) AS INTEGER)";case"enum":return"regexp_extract(path, '/([^/]+)/[^/]*$', 1)";case"injected":throw new Error("Injected partition values not supported yet");default:throw new Error(`Unsupported projection type: ${t.type}`)}}return`regexp_extract(path, '${i}=([^/]+)', 1)`}function ft(i){let e={yyyy:"\\d{4}",MM:"\\d{2}",dd:"\\d{2}",HH:"\\d{2}",mm:"\\d{2}",ss:"\\d{2}"},t=i;for(let[r,s]of Object.entries(e))t=t.replace(r,s);return t}var C=[];for(let i=0;i<256;++i)C.push((i+256).toString(16).slice(1));function Oe(i,e=0){return(C[i[e+0]]+C[i[e+1]]+C[i[e+2]]+C[i[e+3]]+"-"+C[i[e+4]]+C[i[e+5]]+"-"+C[i[e+6]]+C[i[e+7]]+"-"+C[i[e+8]]+C[i[e+9]]+"-"+C[i[e+10]]+C[i[e+11]]+C[i[e+12]]+C[i[e+13]]+C[i[e+14]]+C[i[e+15]]).toLowerCase()}var Re=require("crypto"),K=new Uint8Array(256),Q=K.length;function he(){return Q>K.length-16&&((0,Re.randomFillSync)(K),Q=0),K.slice(Q,Q+=16)}var ve=require("crypto"),ce={randomUUID:ve.randomUUID};function dt(i,e,t){if(ce.randomUUID&&!e&&!i)return ce.randomUUID();i=i||{};let r=i.random??i.rng?.()??he();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let s=0;s<16;++s)e[t+s]=r[s];return e}return Oe(r)}var ue=dt;function Pe(i,e,t=0){let r=[],s=t<0?0:t,n=e??"a"+ue().replaceAll("-",""),o=i.endsWith("/")?i:i+"/";return r.push("INSTALL avro FROM community","LOAD avro",`SET VARIABLE ${n}_metadata_json_path = ( SELECT filename FROM read_json_auto('${o}metadata/*.json', filename=1) ORDER BY "last-sequence-number" DESC OFFSET ${s} LIMIT 1 )`,`SET VARIABLE ${n}_manifest_list_avro_file = ( SELECT snapshots[len(snapshots)]['manifest-list'] AS path FROM read_json(getvariable('${n}_metadata_json_path')))`,`SET VARIABLE ${n}_manifests = ( SELECT list(manifest_path) AS path FROM read_avro(getvariable('${n}_manifest_list_avro_file')))`,`SELECT data_file['file_path'] AS path FROM read_avro(getvariable('${n}_manifests'))`),r}var ti=new Error("timeout while waiting for mutex to become available"),ii=new Error("mutex already locked"),pt=new Error("request for lock canceled"),gt=function(i,e,t,r){function s(n){return n instanceof t?n:new t(function(o){o(n)})}return new(t||(t=Promise))(function(n,o){function a(h){try{c(r.next(h))}catch(f){o(f)}}function l(h){try{c(r.throw(h))}catch(f){o(f)}}function c(h){h.done?n(h.value):s(h.value).then(a,l)}c((r=r.apply(i,e||[])).next())})},fe=class{constructor(e,t=pt){this._value=e,this._cancelError=t,this._queue=[],this._weightedWaiters=[]}acquire(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((r,s)=>{let n={resolve:r,reject:s,weight:e,priority:t},o=Le(this._queue,a=>t<=a.priority);o===-1&&e<=this._value?this._dispatchItem(n):this._queue.splice(o+1,0,n)})}runExclusive(e){return gt(this,arguments,void 0,function*(t,r=1,s=0){let[n,o]=yield this.acquire(r,s);try{return yield t(n)}finally{o()}})}waitForUnlock(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return this._couldLockImmediately(e,t)?Promise.resolve():new Promise(r=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),mt(this._weightedWaiters[e-1],{resolve:r,priority:t})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatchQueue()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatchQueue()}cancel(){this._queue.forEach(e=>e.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(e){let t=this._value;this._value-=e.weight,e.resolve([t,this._newReleaser(e.weight)])}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let e=this._value;e>0;e--){let t=this._weightedWaiters[e-1];t&&(t.forEach(r=>r.resolve()),this._weightedWaiters[e-1]=[])}else{let e=this._queue[0].priority;for(let t=this._value;t>0;t--){let r=this._weightedWaiters[t-1];if(!r)continue;let s=r.findIndex(n=>n.priority<=e);(s===-1?r:r.splice(0,s)).forEach(n=>n.resolve())}}}_couldLockImmediately(e,t){return(this._queue.length===0||this._queue[0].priority<t)&&e<=this._value}};function mt(i,e){let t=Le(i,r=>e.priority<=r.priority);i.splice(t+1,0,e)}function Le(i,e){for(let t=i.length-1;t>=0;t--)if(e(i[t]))return t;return-1}var Et=function(i,e,t,r){function s(n){return n instanceof t?n:new t(function(o){o(n)})}return new(t||(t=Promise))(function(n,o){function a(h){try{c(r.next(h))}catch(f){o(f)}}function l(h){try{c(r.throw(h))}catch(f){o(f)}}function c(h){h.done?n(h.value):s(h.value).then(a,l)}c((r=r.apply(i,e||[])).next())})},J=class{constructor(e){this._semaphore=new fe(1,e)}acquire(){return Et(this,arguments,void 0,function*(e=0){let[,t]=yield this._semaphore.acquire(1,e);return t})}runExclusive(e,t=0){return this._semaphore.runExclusive(()=>e(),1,t)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(e=0){return this._semaphore.waitForUnlock(1,e)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}};var X=me(Me(),1);var _=I("glue-table-cache"),j=I("glue-table-cache:aws"),de={region:"eu-west-1",maxEntries:100,glueTableMetadataTtlMs:36e5,s3ListingRefresTtlhMs:36e5,proxyAddress:void 0},Y=class{tableCache;s3ListingCache;glueClient;s3Client;db;sqlTransformer;config;constructor(e=de){if(_("GlueTableCache config:",JSON.stringify(e)),this.config={...de,...e,region:e?.region||process.env.AWS_REGION||de.region||"eu-west-1"},this.config.proxyAddress)try{new URL(this.config.proxyAddress),this.config.proxyAddress.endsWith("/")||(this.config.proxyAddress=this.config.proxyAddress+"/"),_("Using proxyAddress:",this.config.proxyAddress)}catch(r){console.error(r),this.config.proxyAddress=void 0}_("Initialised GlueTableCache config:",JSON.stringify(e));let t={region:e.region,credentials:this.config.credentials};this.glueClient=new ke.GlueClient(t),this.s3Client=new je.S3Client(t),this.tableCache=new G({max:this.config.maxEntries,ttl:this.config.glueTableMetadataTtlMs}),this.s3ListingCache=new G({max:this.config.maxEntries,ttl:this.config.s3ListingRefresTtlhMs})}setCredentials(e){if(_("Setting credentials -- accessKeyId:",e.accessKeyId),e.secretAccessKey.length<=0)throw new Error("No secretAccessKey");this.config.credentials=e}async __connect(){if(this.db||(this.db=await(await qe.DuckDBInstance.create(":memory:")).connect()),!this.db)throw new Error("Could not create DuckDB instance (neo)");if(this.config.credentials?.accessKeyId&&this.config.credentials?.secretAccessKey){let{accessKeyId:e,secretAccessKey:t,sessionToken:r}=this.config.credentials;_("Using configured credentials for DuckDB (neo)"),await this.__runAndReadAll(`CREATE SECRET s3SecretForIcebergFromCreds (
            TYPE S3,
            KEY_ID '${e}',
            SECRET '${t}',
            ${r?`SESSION_TOKEN '${r}',`:""}
            REGION '${this.config.region}'
        );`)}else _("Using default credentials chain provider for DuckDB (neo)"),await this.__runAndReadAll("CREATE OR REPLACE SECRET s3SecretForIcebergWithProvider ( TYPE S3, PROVIDER CREDENTIAL_CHAIN );");return this.sqlTransformer||(this.sqlTransformer=new F(this.db)),this.db}clearCache(){this.tableCache.clear(),this.s3ListingCache.clear()}close(){this.db?.close(),this.db=void 0,this.sqlTransformer=void 0}getCacheKeyWithMutex(e,t){let r=e.get(t);if(r||(e.set(t,{mutex:new J,timestamp:Date.now(),data:void 0}),r=e.get(t)),!r)throw new Error("ummm");return r}async getTableMetadataCached(e,t){let r=`${e}_${t}`;_("Getting table metadata for %s",r);let s=this.getCacheKeyWithMutex(this.tableCache,r);if(s.error&&delete s.error,!s||!s.mutex)throw new Error("Failed to init cache entry");return s.data?(_("Cache hit for %s",r),s.data):s.mutex.runExclusive(async()=>(0,X.default)(async(n,o)=>{if(s.data)return s.data;if(s.error){n(s.error);return}_("Cache miss for %s, refreshing...",r);try{j("Fetching table metadata from AWS for %s.%s",e,t);let a=await Se(this.glueClient,e,t),l=Date.now();return s.timestamp=l,s.data=a,s.data}catch(a){if(_("getTableMetadataCached ERROR:",a?.$metadata),a?.$metadata?.httpStatusCode===403||a?.[0]?.$metadata?.httpStatusCode===403||a?.$metadata?.httpStatusCode===400||a?.[0]?.$metadata?.httpStatusCode===400||a?.message.includes("HTTP 40")){n(a);return}throw a}},{retries:3,minTimeout:200,maxTimeout:500,onRetry:(n,o)=>_("getTableMetadataCached -- retry:",o,n)}))}invalidateTable(e,t){let r=`${e}_${t}`;this.tableCache.delete(r);for(let s of this.s3ListingCache.keys())s.includes(r)&&this.s3ListingCache.delete(s)}async createGlueTableFilesVarSql(e,t,r){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new F(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let n=`SELECT path FROM "${`${e}_${t}`}_s3_listing"`;r&&r.length>0&&(n+=` WHERE ${r.join(" AND ")}`);let o=this.sqlTransformer?.getGlueTableFilesVarName(e,t);return this.config.proxyAddress?`SET VARIABLE ${o} = ( SELECT list(replace(path, 's3://', '${this.config.proxyAddress}')) FROM (${n}));`:`SET VARIABLE ${o} = ( SELECT list(path) FROM (${n}));`}async convertGlueTableQuery(e){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new F(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=await this.getGlueTableViewSetupSql(e),r=await this.sqlTransformer.transformGlueTableQuery(e);return t.join("")+r}async getGlueTableViewSetupSql(e){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new F(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=[],r=await this.sqlTransformer.getQueryGlueTableRefs(e);_("Found Glue Table references: %O",r),await Promise.all(r.map(async({database:n,table:o})=>{_("Found Glue Table reference: %s",{database:n,table:o});let a=await this.getTableMetadataCached(n,o);if(!a)throw new Error("Metadata not found");let l=`${n}_${o}`,c=a.table.StorageDescriptor?.Location;if(!c)throw new Error(`No storage location found for ${l}`);let h=(a.table.PartitionKeys||[]).map(y=>y.Name),f=[];switch(a.tableType){case"ICEBERG":{let y=await this.__listS3IcebergFilesCached(c,h);y&&f.push(...y);break}default:{let y=await this.__listS3FilesCached(c,h);y&&f.push(...y);break}}t.push(`CREATE OR REPLACE TABLE "${l}_s3_files" AS SELECT path FROM (VALUES ${f.length?f.map(y=>`('${y.path}')`).join(","):"( '' )"}) t(path);`);let d=await Promise.all(h.map(async y=>`${await xe(y,a)} as ${y}`));t.push(`CREATE OR REPLACE TABLE "${l}_s3_listing" AS SELECT path, ${d.join(", ")} FROM "${l}_s3_files";`);for(let y of h)t.push(`CREATE INDEX IF NOT EXISTS idx_${y} ON "${l}_s3_listing" (${y});`);if(!this.sqlTransformer)throw new Error("SQL transformer not initialized");h=(a.table.PartitionKeys||[]).map(y=>y.Name);let u=await this.sqlTransformer.extractPartitionFilters(e,h),E=`SELECT list(path) FROM "${l}_s3_listing"`;this.config.proxyAddress&&(E=`SELECT list(replace(path, 's3://', '${this.config.proxyAddress}')) FROM "${l}_s3_listing"`),u.length>0&&(E+=` WHERE ${u.join(" AND ")}`);let p=this.sqlTransformer.getQueryFilesVarName(n,o);t.push(`SET VARIABLE ${p} = (${E});`);let w=await this.createGlueTableFilesVarSql(n,o);w&&t.push(w);let g=await this.sqlTransformer.getGlueTableViewSql(e,f.length);t.push(...g)}));let s=t.map(n=>n.trim());return _(s),s}async __listS3IcebergFilesCached(e,t){let r=`${e}:${t.join(",")}`,s=this.getCacheKeyWithMutex(this.s3ListingCache,r);if(!s)throw new Error("Could not initialise cache entry");return s.error&&delete s.error,s.data?(j("Using cached S3 (Iceberg) listing for %s",e),s.data):s.mutex.runExclusive(async()=>(0,X.default)(async(n,o)=>{if(s.data)return s.data;if(s.error){n(s.error);return}try{let a=Pe(e);if(j(a),this.db||await this.__connect(),!this.db)throw new Error("Could not create db connection");let l=a.pop();if(!l)throw new Error("No SQL statements generated");for await(let f of a)_(f),await this.db.runAndReadAll(f);let c=(await this.db.runAndReadAll(l)).getRows(),h=le(c.flat(),t);return j("Listing Iceberg S3 files for %s",{s3Path:e,partitionKeys:t,listing:h}),this.s3ListingCache.set(r,{...s,timestamp:Date.now(),data:h}),s.error=void 0,h}catch(a){if(s.error=a,_("__listS3IcebergFilesCached ERROR:",o,a),a?.$metadata?.httpStatusCode===403||a?.[0]?.$metadata?.httpStatusCode===403||a?.$metadata?.httpStatusCode===400||a?.[0]?.$metadata?.httpStatusCode===400||a?.message.includes("HTTP 40")){n(a);return}throw a}},{retries:3,minTimeout:200,maxTimeout:500,onRetry:(n,o)=>_("__listS3IcebergFilesCached -- retry:",o,n)}))}async __listS3FilesCached(e,t){let r=`${e}:${t.join(",")}`,s=this.getCacheKeyWithMutex(this.s3ListingCache,r);if(!s)throw new Error("Could not initialise cache entry");return s.error&&delete s.error,s.data?(j("Using cached S3 listing for %s",e),s.data):s.mutex.runExclusive(async()=>(0,X.default)(async(n,o)=>{if(s.data)return s.data;if(s.error){n(s.error);return}try{j("Listing S3 files for %s",e);let a=await Ae(this.s3Client,e,t);return this.s3ListingCache.set(r,{...s,timestamp:Date.now(),data:a}),a}catch(a){if(_("__listS3FilesCached ERROR:",o,a),a?.$metadata?.httpStatusCode===403||a?.[0]?.$metadata?.httpStatusCode===403||a?.$metadata?.httpStatusCode===400||a?.[0]?.$metadata?.httpStatusCode===400||a?.message.includes("HTTP 40")){n(a);return}throw a}},{retries:3,minTimeout:200,maxTimeout:500,onRetry:(n,o)=>_("__listS3FilesCached -- retry:",o,n)}))}async __runAndReadAll(e){if(this.db||await this.__connect(),!this.db)throw new Error("DB not connected");return this.db.runAndReadAll(e)}};0&&(module.exports={GlueTableCache});
