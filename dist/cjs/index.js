"use strict";var qe=Object.create;var X=Object.defineProperty;var Ge=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var We=Object.getPrototypeOf,Qe=Object.prototype.hasOwnProperty;var $=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),He=(r,e)=>{for(var t in e)X(r,t,{get:e[t],enumerable:!0})},Se=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ve(e))!Qe.call(r,s)&&s!==t&&X(r,s,{get:()=>e[s],enumerable:!(i=Ge(e,s))||i.enumerable});return r};var ne=(r,e,t)=>(t=r!=null?qe(We(r)):{},Se(e||!r||!r.__esModule?X(t,"default",{value:r,enumerable:!0}):t,r)),Ke=r=>Se(X({},"__esModule",{value:!0}),r);var Fe=$((Lt,ve)=>{var q=1e3,G=q*60,V=G*60,k=V*24,Xe=k*7,Ye=k*365.25;ve.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Ze(r);if(t==="number"&&isFinite(r))return e.long?tt(r):et(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Ze(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),i=(e[2]||"ms").toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return t*Ye;case"weeks":case"week":case"w":return t*Xe;case"days":case"day":case"d":return t*k;case"hours":case"hour":case"hrs":case"hr":case"h":return t*V;case"minutes":case"minute":case"mins":case"min":case"m":return t*G;case"seconds":case"second":case"secs":case"sec":case"s":return t*q;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function et(r){var e=Math.abs(r);return e>=k?Math.round(r/k)+"d":e>=V?Math.round(r/V)+"h":e>=G?Math.round(r/G)+"m":e>=q?Math.round(r/q)+"s":r+"ms"}function tt(r){var e=Math.abs(r);return e>=k?Z(r,e,k,"day"):e>=V?Z(r,e,V,"hour"):e>=G?Z(r,e,G,"minute"):e>=q?Z(r,e,q,"second"):r+" ms"}function Z(r,e,t,i){var s=e>=t*1.5;return Math.round(r/t)+" "+i+(s?"s":"")}});var le=$((It,Pe)=>{function rt(r){t.debug=t,t.default=t,t.coerce=a,t.disable=o,t.enable=s,t.enabled=l,t.humanize=Fe(),t.destroy=f,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let c=0;for(let d=0;d<u.length;d++)c=(c<<5)-c+u.charCodeAt(d),c|=0;return t.colors[Math.abs(c)%t.colors.length]}t.selectColor=e;function t(u){let c,d=null,h,b;function p(...m){if(!p.enabled)return;let g=p,E=Number(new Date),R=E-(c||E);g.diff=R,g.prev=c,g.curr=E,c=E,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let w=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(F,v)=>{if(F==="%%")return"%";w++;let M=t.formatters[v];if(typeof M=="function"){let K=m[w];F=M.call(g,K),m.splice(w,1),w--}return F}),t.formatArgs.call(g,m),(g.log||t.log).apply(g,m)}return p.namespace=u,p.useColors=t.useColors(),p.color=t.selectColor(u),p.extend=i,p.destroy=t.destroy,Object.defineProperty(p,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(h!==t.namespaces&&(h=t.namespaces,b=t.enabled(u)),b),set:m=>{d=m}}),typeof t.init=="function"&&t.init(p),p}function i(u,c){let d=t(this.namespace+(typeof c>"u"?":":c)+u);return d.log=this.log,d}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let c=(typeof u=="string"?u:"").trim().replace(" ",",").split(",").filter(Boolean);for(let d of c)d[0]==="-"?t.skips.push(d.slice(1)):t.names.push(d)}function n(u,c){let d=0,h=0,b=-1,p=0;for(;d<u.length;)if(h<c.length&&(c[h]===u[d]||c[h]==="*"))c[h]==="*"?(b=h,p=d,h++):(d++,h++);else if(b!==-1)h=b+1,p++,d=p;else return!1;for(;h<c.length&&c[h]==="*";)h++;return h===c.length}function o(){let u=[...t.names,...t.skips.map(c=>"-"+c)].join(",");return t.enable(""),u}function l(u){for(let c of t.skips)if(n(u,c))return!1;for(let c of t.names)if(n(u,c))return!0;return!1}function a(u){return u instanceof Error?u.stack||u.message:u}function f(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Pe.exports=rt});var De=$((T,ee)=>{T.formatArgs=st;T.save=nt;T.load=ot;T.useColors=it;T.storage=at();T.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();T.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function it(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let r;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(r=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(r[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function st(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+ee.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,i=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(i=t))}),r.splice(i,0,e)}T.log=console.debug||console.log||(()=>{});function nt(r){try{r?T.storage.setItem("debug",r):T.storage.removeItem("debug")}catch{}}function ot(){let r;try{r=T.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function at(){try{return localStorage}catch{}}ee.exports=le()(T);var{formatters:lt}=ee.exports;lt.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Ie=$((Nt,Le)=>{"use strict";Le.exports=(r,e=process.argv)=>{let t=r.startsWith("-")?"":r.length===1?"-":"--",i=e.indexOf(t+r),s=e.indexOf("--");return i!==-1&&(s===-1||i<s)}});var $e=$((Mt,Me)=>{"use strict";var ht=require("os"),Ne=require("tty"),_=Ie(),{env:O}=process,L;_("no-color")||_("no-colors")||_("color=false")||_("color=never")?L=0:(_("color")||_("colors")||_("color=true")||_("color=always"))&&(L=1);"FORCE_COLOR"in O&&(O.FORCE_COLOR==="true"?L=1:O.FORCE_COLOR==="false"?L=0:L=O.FORCE_COLOR.length===0?1:Math.min(parseInt(O.FORCE_COLOR,10),3));function he(r){return r===0?!1:{level:r,hasBasic:!0,has256:r>=2,has16m:r>=3}}function ce(r,e){if(L===0)return 0;if(_("color=16m")||_("color=full")||_("color=truecolor"))return 3;if(_("color=256"))return 2;if(r&&!e&&L===void 0)return 0;let t=L||0;if(O.TERM==="dumb")return t;if(process.platform==="win32"){let i=ht.release().split(".");return Number(i[0])>=10&&Number(i[2])>=10586?Number(i[2])>=14931?3:2:1}if("CI"in O)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some(i=>i in O)||O.CI_NAME==="codeship"?1:t;if("TEAMCITY_VERSION"in O)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(O.TEAMCITY_VERSION)?1:0;if(O.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in O){let i=parseInt((O.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(O.TERM_PROGRAM){case"iTerm.app":return i>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(O.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(O.TERM)||"COLORTERM"in O?1:t}function ct(r){let e=ce(r,r&&r.isTTY);return he(e)}Me.exports={supportsColor:ct,stdout:he(ce(!0,Ne.isatty(1))),stderr:he(ce(!0,Ne.isatty(2)))}});var je=$((A,re)=>{var ut=require("tty"),te=require("util");A.init=mt;A.log=gt;A.formatArgs=dt;A.save=bt;A.load=yt;A.useColors=ft;A.destroy=te.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");A.colors=[6,2,3,4,5,1];try{let r=$e();r&&(r.stderr||r).level>=2&&(A.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch{}A.inspectOpts=Object.keys(process.env).filter(r=>/^debug_/i.test(r)).reduce((r,e)=>{let t=e.substring(6).toLowerCase().replace(/_([a-z])/g,(s,n)=>n.toUpperCase()),i=process.env[e];return/^(yes|on|true|enabled)$/i.test(i)?i=!0:/^(no|off|false|disabled)$/i.test(i)?i=!1:i==="null"?i=null:i=Number(i),r[t]=i,r},{});function ft(){return"colors"in A.inspectOpts?!!A.inspectOpts.colors:ut.isatty(process.stderr.fd)}function dt(r){let{namespace:e,useColors:t}=this;if(t){let i=this.color,s="\x1B[3"+(i<8?i:"8;5;"+i),n=`  ${s};1m${e} \x1B[0m`;r[0]=n+r[0].split(`
`).join(`
`+n),r.push(s+"m+"+re.exports.humanize(this.diff)+"\x1B[0m")}else r[0]=pt()+e+" "+r[0]}function pt(){return A.inspectOpts.hideDate?"":new Date().toISOString()+" "}function gt(...r){return process.stderr.write(te.formatWithOptions(A.inspectOpts,...r)+`
`)}function bt(r){r?process.env.DEBUG=r:delete process.env.DEBUG}function yt(){return process.env.DEBUG}function mt(r){r.inspectOpts={};let e=Object.keys(A.inspectOpts);for(let t=0;t<e.length;t++)r.inspectOpts[e[t]]=A.inspectOpts[e[t]]}re.exports=le()(A);var{formatters:ke}=re.exports;ke.o=function(r){return this.inspectOpts.colors=this.useColors,te.inspect(r,this.inspectOpts).split(`
`).map(e=>e.trim()).join(" ")};ke.O=function(r){return this.inspectOpts.colors=this.useColors,te.inspect(r,this.inspectOpts)}});var fe=$(($t,ue)=>{typeof process>"u"||process.type==="renderer"||process.browser===!0||process.__nwjs?ue.exports=De():ue.exports=je()});var _t={};He(_t,{GlueTableCache:()=>ie});module.exports=Ke(_t);var H=require("@aws-sdk/client-glue"),se=require("@aws-sdk/client-s3");var z=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,Te=new Set,oe=typeof process=="object"&&process?process:{},_e=(r,e,t,i)=>{typeof oe.emitWarning=="function"?oe.emitWarning(r,e,t,i):console.error(`[${t}] ${e}: ${r}`)},Y=globalThis.AbortController,xe=globalThis.AbortSignal;if(typeof Y>"u"){xe=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(i,s){this._onabort.push(s)}},Y=class{constructor(){e()}signal=new xe;abort(i){if(!this.signal.aborted){this.signal.reason=i,this.signal.aborted=!0;for(let s of this.signal._onabort)s(i);this.signal.onabort?.(i)}}};let r=oe.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",e=()=>{r&&(r=!1,_e("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}var Je=r=>!Te.has(r),Pt=Symbol("type"),D=r=>r&&r===Math.floor(r)&&r>0&&isFinite(r),Re=r=>D(r)?r<=Math.pow(2,8)?Uint8Array:r<=Math.pow(2,16)?Uint16Array:r<=Math.pow(2,32)?Uint32Array:r<=Number.MAX_SAFE_INTEGER?B:null:null,B=class extends Array{constructor(e){super(e),this.fill(0)}},ae=class r{heap;length;static#l=!1;static create(e){let t=Re(e);if(!t)return[];r.#l=!0;let i=new r(e,t);return r.#l=!1,i}constructor(e,t){if(!r.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}},J=class r{#l;#u;#g;#b;#F;#P;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#s;#y;#i;#r;#e;#h;#f;#a;#n;#m;#o;#E;#C;#d;#w;#T;#c;static unsafeExposeInternals(e){return{starts:e.#C,ttls:e.#d,sizes:e.#E,keyMap:e.#i,keyList:e.#r,valList:e.#e,next:e.#h,prev:e.#f,get head(){return e.#a},get tail(){return e.#n},free:e.#m,isBackgroundFetch:t=>e.#t(t),backgroundFetch:(t,i,s,n)=>e.#I(t,i,s,n),moveToTail:t=>e.#v(t),indexes:t=>e.#O(t),rindexes:t=>e.#A(t),isStale:t=>e.#p(t)}}get max(){return this.#l}get maxSize(){return this.#u}get calculatedSize(){return this.#y}get size(){return this.#s}get fetchMethod(){return this.#F}get memoMethod(){return this.#P}get dispose(){return this.#g}get disposeAfter(){return this.#b}constructor(e){let{max:t=0,ttl:i,ttlResolution:s=1,ttlAutopurge:n,updateAgeOnGet:o,updateAgeOnHas:l,allowStale:a,dispose:f,disposeAfter:u,noDisposeOnSet:c,noUpdateTTL:d,maxSize:h=0,maxEntrySize:b=0,sizeCalculation:p,fetchMethod:m,memoMethod:g,noDeleteOnFetchRejection:E,noDeleteOnStaleGet:R,allowStaleOnFetchRejection:w,allowStaleOnFetchAbort:x,ignoreFetchAbort:F}=e;if(t!==0&&!D(t))throw new TypeError("max option must be a nonnegative integer");let v=t?Re(t):Array;if(!v)throw new Error("invalid max value: "+t);if(this.#l=t,this.#u=h,this.maxEntrySize=b||this.#u,this.sizeCalculation=p,this.sizeCalculation){if(!this.#u&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(g!==void 0&&typeof g!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#P=g,m!==void 0&&typeof m!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#F=m,this.#T=!!m,this.#i=new Map,this.#r=new Array(t).fill(void 0),this.#e=new Array(t).fill(void 0),this.#h=new v(t),this.#f=new v(t),this.#a=0,this.#n=0,this.#m=ae.create(t),this.#s=0,this.#y=0,typeof f=="function"&&(this.#g=f),typeof u=="function"?(this.#b=u,this.#o=[]):(this.#b=void 0,this.#o=void 0),this.#w=!!this.#g,this.#c=!!this.#b,this.noDisposeOnSet=!!c,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!E,this.allowStaleOnFetchRejection=!!w,this.allowStaleOnFetchAbort=!!x,this.ignoreFetchAbort=!!F,this.maxEntrySize!==0){if(this.#u!==0&&!D(this.#u))throw new TypeError("maxSize must be a positive integer if specified");if(!D(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#z()}if(this.allowStale=!!a,this.noDeleteOnStaleGet=!!R,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!l,this.ttlResolution=D(s)||s===0?s:1,this.ttlAutopurge=!!n,this.ttl=i||0,this.ttl){if(!D(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#N()}if(this.#l===0&&this.ttl===0&&this.#u===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#u){let M="LRU_CACHE_UNBOUNDED";Je(M)&&(Te.add(M),_e("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",M,r))}}getRemainingTTL(e){return this.#i.has(e)?1/0:0}#N(){let e=new B(this.#l),t=new B(this.#l);this.#d=e,this.#C=t,this.#M=(n,o,l=z.now())=>{if(t[n]=o!==0?l:0,e[n]=o,o!==0&&this.ttlAutopurge){let a=setTimeout(()=>{this.#p(n)&&this.#S(this.#r[n],"expire")},o+1);a.unref&&a.unref()}},this.#_=n=>{t[n]=e[n]!==0?z.now():0},this.#x=(n,o)=>{if(e[o]){let l=e[o],a=t[o];if(!l||!a)return;n.ttl=l,n.start=a,n.now=i||s();let f=n.now-a;n.remainingTTL=l-f}};let i=0,s=()=>{let n=z.now();if(this.ttlResolution>0){i=n;let o=setTimeout(()=>i=0,this.ttlResolution);o.unref&&o.unref()}return n};this.getRemainingTTL=n=>{let o=this.#i.get(n);if(o===void 0)return 0;let l=e[o],a=t[o];if(!l||!a)return 1/0;let f=(i||s())-a;return l-f},this.#p=n=>{let o=t[n],l=e[n];return!!l&&!!o&&(i||s())-o>l}}#_=()=>{};#x=()=>{};#M=()=>{};#p=()=>!1;#z(){let e=new B(this.#l);this.#y=0,this.#E=e,this.#R=t=>{this.#y-=e[t],e[t]=0},this.#$=(t,i,s,n)=>{if(this.#t(i))return 0;if(!D(s))if(n){if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(s=n(i,t),!D(s))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return s},this.#D=(t,i,s)=>{if(e[t]=i,this.#u){let n=this.#u-e[t];for(;this.#y>n;)this.#L(!0)}this.#y+=e[t],s&&(s.entrySize=i,s.totalCalculatedSize=this.#y)}}#R=e=>{};#D=(e,t,i)=>{};#$=(e,t,i,s)=>{if(i||s)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#O({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#n;!(!this.#k(t)||((e||!this.#p(t))&&(yield t),t===this.#a));)t=this.#f[t]}*#A({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#a;!(!this.#k(t)||((e||!this.#p(t))&&(yield t),t===this.#n));)t=this.#h[t]}#k(e){return e!==void 0&&this.#i.get(this.#r[e])===e}*entries(){for(let e of this.#O())this.#e[e]!==void 0&&this.#r[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#r[e],this.#e[e]])}*rentries(){for(let e of this.#A())this.#e[e]!==void 0&&this.#r[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#r[e],this.#e[e]])}*keys(){for(let e of this.#O()){let t=this.#r[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*rkeys(){for(let e of this.#A()){let t=this.#r[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*values(){for(let e of this.#O())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}*rvalues(){for(let e of this.#A())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let i of this.#O()){let s=this.#e[i],n=this.#t(s)?s.__staleWhileFetching:s;if(n!==void 0&&e(n,this.#r[i],this))return this.get(this.#r[i],t)}}forEach(e,t=this){for(let i of this.#O()){let s=this.#e[i],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#r[i],this)}}rforEach(e,t=this){for(let i of this.#A()){let s=this.#e[i],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#r[i],this)}}purgeStale(){let e=!1;for(let t of this.#A({allowStale:!0}))this.#p(t)&&(this.#S(this.#r[t],"expire"),e=!0);return e}info(e){let t=this.#i.get(e);if(t===void 0)return;let i=this.#e[t],s=this.#t(i)?i.__staleWhileFetching:i;if(s===void 0)return;let n={value:s};if(this.#d&&this.#C){let o=this.#d[t],l=this.#C[t];if(o&&l){let a=o-(z.now()-l);n.ttl=a,n.start=Date.now()}}return this.#E&&(n.size=this.#E[t]),n}dump(){let e=[];for(let t of this.#O({allowStale:!0})){let i=this.#r[t],s=this.#e[t],n=this.#t(s)?s.__staleWhileFetching:s;if(n===void 0||i===void 0)continue;let o={value:n};if(this.#d&&this.#C){o.ttl=this.#d[t];let l=z.now()-this.#C[t];o.start=Math.floor(Date.now()-l)}this.#E&&(o.size=this.#E[t]),e.unshift([i,o])}return e}load(e){this.clear();for(let[t,i]of e){if(i.start){let s=Date.now()-i.start;i.start=z.now()-s}this.set(t,i.value,i)}}set(e,t,i={}){if(t===void 0)return this.delete(e),this;let{ttl:s=this.ttl,start:n,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:l=this.sizeCalculation,status:a}=i,{noUpdateTTL:f=this.noUpdateTTL}=i,u=this.#$(e,t,i.size||0,l);if(this.maxEntrySize&&u>this.maxEntrySize)return a&&(a.set="miss",a.maxEntrySizeExceeded=!0),this.#S(e,"set"),this;let c=this.#s===0?void 0:this.#i.get(e);if(c===void 0)c=this.#s===0?this.#n:this.#m.length!==0?this.#m.pop():this.#s===this.#l?this.#L(!1):this.#s,this.#r[c]=e,this.#e[c]=t,this.#i.set(e,c),this.#h[this.#n]=c,this.#f[c]=this.#n,this.#n=c,this.#s++,this.#D(c,u,a),a&&(a.set="add"),f=!1;else{this.#v(c);let d=this.#e[c];if(t!==d){if(this.#T&&this.#t(d)){d.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:h}=d;h!==void 0&&!o&&(this.#w&&this.#g?.(h,e,"set"),this.#c&&this.#o?.push([h,e,"set"]))}else o||(this.#w&&this.#g?.(d,e,"set"),this.#c&&this.#o?.push([d,e,"set"]));if(this.#R(c),this.#D(c,u,a),this.#e[c]=t,a){a.set="replace";let h=d&&this.#t(d)?d.__staleWhileFetching:d;h!==void 0&&(a.oldValue=h)}}else a&&(a.set="update")}if(s!==0&&!this.#d&&this.#N(),this.#d&&(f||this.#M(c,s,n),a&&this.#x(a,c)),!o&&this.#c&&this.#o){let d=this.#o,h;for(;h=d?.shift();)this.#b?.(...h)}return this}pop(){try{for(;this.#s;){let e=this.#e[this.#a];if(this.#L(!0),this.#t(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#c&&this.#o){let e=this.#o,t;for(;t=e?.shift();)this.#b?.(...t)}}}#L(e){let t=this.#a,i=this.#r[t],s=this.#e[t];return this.#T&&this.#t(s)?s.__abortController.abort(new Error("evicted")):(this.#w||this.#c)&&(this.#w&&this.#g?.(s,i,"evict"),this.#c&&this.#o?.push([s,i,"evict"])),this.#R(t),e&&(this.#r[t]=void 0,this.#e[t]=void 0,this.#m.push(t)),this.#s===1?(this.#a=this.#n=0,this.#m.length=0):this.#a=this.#h[t],this.#i.delete(i),this.#s--,t}has(e,t={}){let{updateAgeOnHas:i=this.updateAgeOnHas,status:s}=t,n=this.#i.get(e);if(n!==void 0){let o=this.#e[n];if(this.#t(o)&&o.__staleWhileFetching===void 0)return!1;if(this.#p(n))s&&(s.has="stale",this.#x(s,n));else return i&&this.#_(n),s&&(s.has="hit",this.#x(s,n)),!0}else s&&(s.has="miss");return!1}peek(e,t={}){let{allowStale:i=this.allowStale}=t,s=this.#i.get(e);if(s===void 0||!i&&this.#p(s))return;let n=this.#e[s];return this.#t(n)?n.__staleWhileFetching:n}#I(e,t,i,s){let n=t===void 0?void 0:this.#e[t];if(this.#t(n))return n;let o=new Y,{signal:l}=i;l?.addEventListener("abort",()=>o.abort(l.reason),{signal:o.signal});let a={signal:o.signal,options:i,context:s},f=(p,m=!1)=>{let{aborted:g}=o.signal,E=i.ignoreFetchAbort&&p!==void 0;if(i.status&&(g&&!m?(i.status.fetchAborted=!0,i.status.fetchError=o.signal.reason,E&&(i.status.fetchAbortIgnored=!0)):i.status.fetchResolved=!0),g&&!E&&!m)return c(o.signal.reason);let R=h;return this.#e[t]===h&&(p===void 0?R.__staleWhileFetching?this.#e[t]=R.__staleWhileFetching:this.#S(e,"fetch"):(i.status&&(i.status.fetchUpdated=!0),this.set(e,p,a.options))),p},u=p=>(i.status&&(i.status.fetchRejected=!0,i.status.fetchError=p),c(p)),c=p=>{let{aborted:m}=o.signal,g=m&&i.allowStaleOnFetchAbort,E=g||i.allowStaleOnFetchRejection,R=E||i.noDeleteOnFetchRejection,w=h;if(this.#e[t]===h&&(!R||w.__staleWhileFetching===void 0?this.#S(e,"fetch"):g||(this.#e[t]=w.__staleWhileFetching)),E)return i.status&&w.__staleWhileFetching!==void 0&&(i.status.returnedStale=!0),w.__staleWhileFetching;if(w.__returned===w)throw p},d=(p,m)=>{let g=this.#F?.(e,n,a);g&&g instanceof Promise&&g.then(E=>p(E===void 0?void 0:E),m),o.signal.addEventListener("abort",()=>{(!i.ignoreFetchAbort||i.allowStaleOnFetchAbort)&&(p(void 0),i.allowStaleOnFetchAbort&&(p=E=>f(E,!0)))})};i.status&&(i.status.fetchDispatched=!0);let h=new Promise(d).then(f,u),b=Object.assign(h,{__abortController:o,__staleWhileFetching:n,__returned:void 0});return t===void 0?(this.set(e,b,{...a.options,status:void 0}),t=this.#i.get(e)):this.#e[t]=b,b}#t(e){if(!this.#T)return!1;let t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof Y}async fetch(e,t={}){let{allowStale:i=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:l=this.noDisposeOnSet,size:a=0,sizeCalculation:f=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:c=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:d=this.allowStaleOnFetchRejection,ignoreFetchAbort:h=this.ignoreFetchAbort,allowStaleOnFetchAbort:b=this.allowStaleOnFetchAbort,context:p,forceRefresh:m=!1,status:g,signal:E}=t;if(!this.#T)return g&&(g.fetch="get"),this.get(e,{allowStale:i,updateAgeOnGet:s,noDeleteOnStaleGet:n,status:g});let R={allowStale:i,updateAgeOnGet:s,noDeleteOnStaleGet:n,ttl:o,noDisposeOnSet:l,size:a,sizeCalculation:f,noUpdateTTL:u,noDeleteOnFetchRejection:c,allowStaleOnFetchRejection:d,allowStaleOnFetchAbort:b,ignoreFetchAbort:h,status:g,signal:E},w=this.#i.get(e);if(w===void 0){g&&(g.fetch="miss");let x=this.#I(e,w,R,p);return x.__returned=x}else{let x=this.#e[w];if(this.#t(x)){let Ae=i&&x.__staleWhileFetching!==void 0;return g&&(g.fetch="inflight",Ae&&(g.returnedStale=!0)),Ae?x.__staleWhileFetching:x.__returned=x}let F=this.#p(w);if(!m&&!F)return g&&(g.fetch="hit"),this.#v(w),s&&this.#_(w),g&&this.#x(g,w),x;let v=this.#I(e,w,R,p),K=v.__staleWhileFetching!==void 0&&i;return g&&(g.fetch=F?"stale":"refresh",K&&F&&(g.returnedStale=!0)),K?v.__staleWhileFetching:v.__returned=v}}async forceFetch(e,t={}){let i=await this.fetch(e,t);if(i===void 0)throw new Error("fetch() returned undefined");return i}memo(e,t={}){let i=this.#P;if(!i)throw new Error("no memoMethod provided to constructor");let{context:s,forceRefresh:n,...o}=t,l=this.get(e,o);if(!n&&l!==void 0)return l;let a=i(e,l,{options:o,context:s});return this.set(e,a,o),a}get(e,t={}){let{allowStale:i=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:o}=t,l=this.#i.get(e);if(l!==void 0){let a=this.#e[l],f=this.#t(a);return o&&this.#x(o,l),this.#p(l)?(o&&(o.get="stale"),f?(o&&i&&a.__staleWhileFetching!==void 0&&(o.returnedStale=!0),i?a.__staleWhileFetching:void 0):(n||this.#S(e,"expire"),o&&i&&(o.returnedStale=!0),i?a:void 0)):(o&&(o.get="hit"),f?a.__staleWhileFetching:(this.#v(l),s&&this.#_(l),a))}else o&&(o.get="miss")}#j(e,t){this.#f[t]=e,this.#h[e]=t}#v(e){e!==this.#n&&(e===this.#a?this.#a=this.#h[e]:this.#j(this.#f[e],this.#h[e]),this.#j(this.#n,e),this.#n=e)}delete(e){return this.#S(e,"delete")}#S(e,t){let i=!1;if(this.#s!==0){let s=this.#i.get(e);if(s!==void 0)if(i=!0,this.#s===1)this.#U(t);else{this.#R(s);let n=this.#e[s];if(this.#t(n)?n.__abortController.abort(new Error("deleted")):(this.#w||this.#c)&&(this.#w&&this.#g?.(n,e,t),this.#c&&this.#o?.push([n,e,t])),this.#i.delete(e),this.#r[s]=void 0,this.#e[s]=void 0,s===this.#n)this.#n=this.#f[s];else if(s===this.#a)this.#a=this.#h[s];else{let o=this.#f[s];this.#h[o]=this.#h[s];let l=this.#h[s];this.#f[l]=this.#f[s]}this.#s--,this.#m.push(s)}}if(this.#c&&this.#o?.length){let s=this.#o,n;for(;n=s?.shift();)this.#b?.(...n)}return i}clear(){return this.#U("delete")}#U(e){for(let t of this.#A({allowStale:!0})){let i=this.#e[t];if(this.#t(i))i.__abortController.abort(new Error("deleted"));else{let s=this.#r[t];this.#w&&this.#g?.(i,s,e),this.#c&&this.#o?.push([i,s,e])}}if(this.#i.clear(),this.#e.fill(void 0),this.#r.fill(void 0),this.#d&&this.#C&&(this.#d.fill(0),this.#C.fill(0)),this.#E&&this.#E.fill(0),this.#a=0,this.#n=0,this.#m.length=0,this.#y=0,this.#s=0,this.#c&&this.#o){let t=this.#o,i;for(;i=t?.shift();)this.#b?.(...i)}}};var Be=require("@duckdb/node-api"),Oe=ne(fe(),1);var Ee=ne(fe(),1);var ze=ne(require("vm"),1),pe=class{add(e,t,i){if(typeof arguments[0]!="string")for(let s in arguments[0])this.add(s,arguments[0][s],arguments[1]);else(Array.isArray(e)?e:[e]).forEach(function(s){this[s]=this[s]||[],t&&this[s][i?"unshift":"push"](t)},this)}run(e,t){this[e]=this[e]||[],this[e].forEach(function(i){i.call(t&&t.context?t.context:t,t)})}},ge=class{constructor(e){this.jsep=e,this.registered={}}register(...e){e.forEach(t=>{if(typeof t!="object"||!t.name||!t.init)throw new Error("Invalid JSEP plugin format");this.registered[t.name]||(t.init(this.jsep),this.registered[t.name]=t)})}},S=class r{static get version(){return"1.4.0"}static toString(){return"JavaScript Expression Parser (JSEP) v"+r.version}static addUnaryOp(e){return r.max_unop_len=Math.max(e.length,r.max_unop_len),r.unary_ops[e]=1,r}static addBinaryOp(e,t,i){return r.max_binop_len=Math.max(e.length,r.max_binop_len),r.binary_ops[e]=t,i?r.right_associative.add(e):r.right_associative.delete(e),r}static addIdentifierChar(e){return r.additional_identifier_chars.add(e),r}static addLiteral(e,t){return r.literals[e]=t,r}static removeUnaryOp(e){return delete r.unary_ops[e],e.length===r.max_unop_len&&(r.max_unop_len=r.getMaxKeyLen(r.unary_ops)),r}static removeAllUnaryOps(){return r.unary_ops={},r.max_unop_len=0,r}static removeIdentifierChar(e){return r.additional_identifier_chars.delete(e),r}static removeBinaryOp(e){return delete r.binary_ops[e],e.length===r.max_binop_len&&(r.max_binop_len=r.getMaxKeyLen(r.binary_ops)),r.right_associative.delete(e),r}static removeAllBinaryOps(){return r.binary_ops={},r.max_binop_len=0,r}static removeLiteral(e){return delete r.literals[e],r}static removeAllLiterals(){return r.literals={},r}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(e){this.expr=e,this.index=0}static parse(e){return new r(e).parse()}static getMaxKeyLen(e){return Math.max(0,...Object.keys(e).map(t=>t.length))}static isDecimalDigit(e){return e>=48&&e<=57}static binaryPrecedence(e){return r.binary_ops[e]||0}static isIdentifierStart(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!r.binary_ops[String.fromCharCode(e)]||r.additional_identifier_chars.has(String.fromCharCode(e))}static isIdentifierPart(e){return r.isIdentifierStart(e)||r.isDecimalDigit(e)}throwError(e){let t=new Error(e+" at character "+this.index);throw t.index=this.index,t.description=e,t}runHook(e,t){if(r.hooks[e]){let i={context:this,node:t};return r.hooks.run(e,i),i.node}return t}searchHook(e){if(r.hooks[e]){let t={context:this};return r.hooks[e].find(function(i){return i.call(t.context,t),t.node}),t.node}}gobbleSpaces(){let e=this.code;for(;e===r.SPACE_CODE||e===r.TAB_CODE||e===r.LF_CODE||e===r.CR_CODE;)e=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");let e=this.gobbleExpressions(),t=e.length===1?e[0]:{type:r.COMPOUND,body:e};return this.runHook("after-all",t)}gobbleExpressions(e){let t=[],i,s;for(;this.index<this.expr.length;)if(i=this.code,i===r.SEMCOL_CODE||i===r.COMMA_CODE)this.index++;else if(s=this.gobbleExpression())t.push(s);else if(this.index<this.expr.length){if(i===e)break;this.throwError('Unexpected "'+this.char+'"')}return t}gobbleExpression(){let e=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",e)}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,r.max_binop_len),t=e.length;for(;t>0;){if(r.binary_ops.hasOwnProperty(e)&&(!r.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!r.isIdentifierPart(this.expr.charCodeAt(this.index+e.length))))return this.index+=t,e;e=e.substr(0,--t)}return!1}gobbleBinaryExpression(){let e,t,i,s,n,o,l,a,f;if(o=this.gobbleToken(),!o||(t=this.gobbleBinaryOp(),!t))return o;for(n={value:t,prec:r.binaryPrecedence(t),right_a:r.right_associative.has(t)},l=this.gobbleToken(),l||this.throwError("Expected expression after "+t),s=[o,n,l];t=this.gobbleBinaryOp();){if(i=r.binaryPrecedence(t),i===0){this.index-=t.length;break}n={value:t,prec:i,right_a:r.right_associative.has(t)},f=t;let u=c=>n.right_a&&c.right_a?i>c.prec:i<=c.prec;for(;s.length>2&&u(s[s.length-2]);)l=s.pop(),t=s.pop().value,o=s.pop(),e={type:r.BINARY_EXP,operator:t,left:o,right:l},s.push(e);e=this.gobbleToken(),e||this.throwError("Expected expression after "+f),s.push(n,e)}for(a=s.length-1,e=s[a];a>1;)e={type:r.BINARY_EXP,operator:s[a-1].value,left:s[a-2],right:e},a-=2;return e}gobbleToken(){let e,t,i,s;if(this.gobbleSpaces(),s=this.searchHook("gobble-token"),s)return this.runHook("after-token",s);if(e=this.code,r.isDecimalDigit(e)||e===r.PERIOD_CODE)return this.gobbleNumericLiteral();if(e===r.SQUOTE_CODE||e===r.DQUOTE_CODE)s=this.gobbleStringLiteral();else if(e===r.OBRACK_CODE)s=this.gobbleArray();else{for(t=this.expr.substr(this.index,r.max_unop_len),i=t.length;i>0;){if(r.unary_ops.hasOwnProperty(t)&&(!r.isIdentifierStart(this.code)||this.index+t.length<this.expr.length&&!r.isIdentifierPart(this.expr.charCodeAt(this.index+t.length)))){this.index+=i;let n=this.gobbleToken();return n||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:r.UNARY_EXP,operator:t,argument:n,prefix:!0})}t=t.substr(0,--i)}r.isIdentifierStart(e)?(s=this.gobbleIdentifier(),r.literals.hasOwnProperty(s.name)?s={type:r.LITERAL,value:r.literals[s.name],raw:s.name}:s.name===r.this_str&&(s={type:r.THIS_EXP})):e===r.OPAREN_CODE&&(s=this.gobbleGroup())}return s?(s=this.gobbleTokenProperty(s),this.runHook("after-token",s)):this.runHook("after-token",!1)}gobbleTokenProperty(e){this.gobbleSpaces();let t=this.code;for(;t===r.PERIOD_CODE||t===r.OBRACK_CODE||t===r.OPAREN_CODE||t===r.QUMARK_CODE;){let i;if(t===r.QUMARK_CODE){if(this.expr.charCodeAt(this.index+1)!==r.PERIOD_CODE)break;i=!0,this.index+=2,this.gobbleSpaces(),t=this.code}this.index++,t===r.OBRACK_CODE?(e={type:r.MEMBER_EXP,computed:!0,object:e,property:this.gobbleExpression()},e.property||this.throwError('Unexpected "'+this.char+'"'),this.gobbleSpaces(),t=this.code,t!==r.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):t===r.OPAREN_CODE?e={type:r.CALL_EXP,arguments:this.gobbleArguments(r.CPAREN_CODE),callee:e}:(t===r.PERIOD_CODE||i)&&(i&&this.index--,this.gobbleSpaces(),e={type:r.MEMBER_EXP,computed:!1,object:e,property:this.gobbleIdentifier()}),i&&(e.optional=!0),this.gobbleSpaces(),t=this.code}return e}gobbleNumericLiteral(){let e="",t,i;for(;r.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(this.code===r.PERIOD_CODE)for(e+=this.expr.charAt(this.index++);r.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(t=this.char,t==="e"||t==="E"){for(e+=this.expr.charAt(this.index++),t=this.char,(t==="+"||t==="-")&&(e+=this.expr.charAt(this.index++));r.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);r.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+e+this.char+")")}return i=this.code,r.isIdentifierStart(i)?this.throwError("Variable names cannot start with a number ("+e+this.char+")"):(i===r.PERIOD_CODE||e.length===1&&e.charCodeAt(0)===r.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:r.LITERAL,value:parseFloat(e),raw:e}}gobbleStringLiteral(){let e="",t=this.index,i=this.expr.charAt(this.index++),s=!1;for(;this.index<this.expr.length;){let n=this.expr.charAt(this.index++);if(n===i){s=!0;break}else if(n==="\\")switch(n=this.expr.charAt(this.index++),n){case"n":e+=`
`;break;case"r":e+="\r";break;case"t":e+="	";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=n}else e+=n}return s||this.throwError('Unclosed quote after "'+e+'"'),{type:r.LITERAL,value:e,raw:this.expr.substring(t,this.index)}}gobbleIdentifier(){let e=this.code,t=this.index;for(r.isIdentifierStart(e)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(e=this.code,r.isIdentifierPart(e));)this.index++;return{type:r.IDENTIFIER,name:this.expr.slice(t,this.index)}}gobbleArguments(e){let t=[],i=!1,s=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let n=this.code;if(n===e){i=!0,this.index++,e===r.CPAREN_CODE&&s&&s>=t.length&&this.throwError("Unexpected token "+String.fromCharCode(e));break}else if(n===r.COMMA_CODE){if(this.index++,s++,s!==t.length){if(e===r.CPAREN_CODE)this.throwError("Unexpected token ,");else if(e===r.CBRACK_CODE)for(let o=t.length;o<s;o++)t.push(null)}}else if(t.length!==s&&s!==0)this.throwError("Expected comma");else{let o=this.gobbleExpression();(!o||o.type===r.COMPOUND)&&this.throwError("Expected comma"),t.push(o)}}return i||this.throwError("Expected "+String.fromCharCode(e)),t}gobbleGroup(){this.index++;let e=this.gobbleExpressions(r.CPAREN_CODE);if(this.code===r.CPAREN_CODE)return this.index++,e.length===1?e[0]:e.length?{type:r.SEQUENCE_EXP,expressions:e}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:r.ARRAY_EXP,elements:this.gobbleArguments(r.CBRACK_CODE)}}},Et=new pe;Object.assign(S,{hooks:Et,plugins:new ge(S),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"??":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10,"**":11},right_associative:new Set(["**"]),additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});S.max_unop_len=S.getMaxKeyLen(S.unary_ops);S.max_binop_len=S.getMaxKeyLen(S.binary_ops);var P=r=>new S(r).parse(),Ct=Object.getOwnPropertyNames(class{});Object.getOwnPropertyNames(S).filter(r=>!Ct.includes(r)&&P[r]===void 0).forEach(r=>{P[r]=S[r]});P.Jsep=S;var wt="ConditionalExpression",Ot={name:"ternary",init(r){r.hooks.add("after-expression",function(t){if(t.node&&this.code===r.QUMARK_CODE){this.index++;let i=t.node,s=this.gobbleExpression();if(s||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===r.COLON_CODE){this.index++;let n=this.gobbleExpression();if(n||this.throwError("Expected expression"),t.node={type:wt,test:i,consequent:s,alternate:n},i.operator&&r.binary_ops[i.operator]<=.9){let o=i;for(;o.right.operator&&r.binary_ops[o.right.operator]<=.9;)o=o.right;t.node.test=o.right,o.right=t.node,t.node=i}}else this.throwError("Expected :")}})}};P.plugins.register(Ot);var Ue=47,At=92,St={name:"regex",init(r){r.hooks.add("gobble-token",function(t){if(this.code===Ue){let i=++this.index,s=!1;for(;this.index<this.expr.length;){if(this.code===Ue&&!s){let n=this.expr.slice(i,this.index),o="";for(;++this.index<this.expr.length;){let a=this.code;if(a>=97&&a<=122||a>=65&&a<=90||a>=48&&a<=57)o+=this.char;else break}let l;try{l=new RegExp(n,o)}catch(a){this.throwError(a.message)}return t.node={type:r.LITERAL,value:l,raw:this.expr.slice(i-1,this.index)},t.node=this.gobbleTokenProperty(t.node),t.node}this.code===r.OBRACK_CODE?s=!0:s&&this.code===r.CBRACK_CODE&&(s=!1),this.index+=this.code===At?2:1}this.throwError("Unclosed Regex")}})}},de=43,xt=45,W={name:"assignment",assignmentOperators:new Set(["=","*=","**=","/=","%=","+=","-=","<<=",">>=",">>>=","&=","^=","|=","||=","&&=","??="]),updateOperators:[de,xt],assignmentPrecedence:.9,init(r){let e=[r.IDENTIFIER,r.MEMBER_EXP];W.assignmentOperators.forEach(i=>r.addBinaryOp(i,W.assignmentPrecedence,!0)),r.hooks.add("gobble-token",function(s){let n=this.code;W.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(this.index+=2,s.node={type:"UpdateExpression",operator:n===de?"++":"--",argument:this.gobbleTokenProperty(this.gobbleIdentifier()),prefix:!0},(!s.node.argument||!e.includes(s.node.argument.type))&&this.throwError(`Unexpected ${s.node.operator}`))}),r.hooks.add("after-token",function(s){if(s.node){let n=this.code;W.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(e.includes(s.node.type)||this.throwError(`Unexpected ${s.node.operator}`),this.index+=2,s.node={type:"UpdateExpression",operator:n===de?"++":"--",argument:s.node,prefix:!1})}}),r.hooks.add("after-expression",function(s){s.node&&t(s.node)});function t(i){W.assignmentOperators.has(i.operator)?(i.type="AssignmentExpression",t(i.left),t(i.right)):i.operator||Object.values(i).forEach(s=>{s&&typeof s=="object"&&t(s)})}}};P.plugins.register(St,W);P.addUnaryOp("typeof");P.addLiteral("null",null);P.addLiteral("undefined",void 0);var Tt=new Set(["constructor","__proto__","__defineGetter__","__defineSetter__"]),C={evalAst(r,e){switch(r.type){case"BinaryExpression":case"LogicalExpression":return C.evalBinaryExpression(r,e);case"Compound":return C.evalCompound(r,e);case"ConditionalExpression":return C.evalConditionalExpression(r,e);case"Identifier":return C.evalIdentifier(r,e);case"Literal":return C.evalLiteral(r,e);case"MemberExpression":return C.evalMemberExpression(r,e);case"UnaryExpression":return C.evalUnaryExpression(r,e);case"ArrayExpression":return C.evalArrayExpression(r,e);case"CallExpression":return C.evalCallExpression(r,e);case"AssignmentExpression":return C.evalAssignmentExpression(r,e);default:throw SyntaxError("Unexpected expression",r)}},evalBinaryExpression(r,e){return{"||":(i,s)=>i||s(),"&&":(i,s)=>i&&s(),"|":(i,s)=>i|s(),"^":(i,s)=>i^s(),"&":(i,s)=>i&s(),"==":(i,s)=>i==s(),"!=":(i,s)=>i!=s(),"===":(i,s)=>i===s(),"!==":(i,s)=>i!==s(),"<":(i,s)=>i<s(),">":(i,s)=>i>s(),"<=":(i,s)=>i<=s(),">=":(i,s)=>i>=s(),"<<":(i,s)=>i<<s(),">>":(i,s)=>i>>s(),">>>":(i,s)=>i>>>s(),"+":(i,s)=>i+s(),"-":(i,s)=>i-s(),"*":(i,s)=>i*s(),"/":(i,s)=>i/s(),"%":(i,s)=>i%s()}[r.operator](C.evalAst(r.left,e),()=>C.evalAst(r.right,e))},evalCompound(r,e){let t;for(let i=0;i<r.body.length;i++){r.body[i].type==="Identifier"&&["var","let","const"].includes(r.body[i].name)&&r.body[i+1]&&r.body[i+1].type==="AssignmentExpression"&&(i+=1);let s=r.body[i];t=C.evalAst(s,e)}return t},evalConditionalExpression(r,e){return C.evalAst(r.test,e)?C.evalAst(r.consequent,e):C.evalAst(r.alternate,e)},evalIdentifier(r,e){if(Object.hasOwn(e,r.name))return e[r.name];throw ReferenceError(`${r.name} is not defined`)},evalLiteral(r){return r.value},evalMemberExpression(r,e){let t=r.computed?C.evalAst(r.property):r.property.name,i=C.evalAst(r.object,e);if(i==null)throw TypeError(`Cannot read properties of ${i} (reading '${t}')`);if(!Object.hasOwn(i,t)&&Tt.has(t))throw TypeError(`Cannot read properties of ${i} (reading '${t}')`);let s=i[t];return typeof s=="function"?s.bind(i):s},evalUnaryExpression(r,e){return{"-":i=>-C.evalAst(i,e),"!":i=>!C.evalAst(i,e),"~":i=>~C.evalAst(i,e),"+":i=>+C.evalAst(i,e),typeof:i=>typeof C.evalAst(i,e)}[r.operator](r.argument)},evalArrayExpression(r,e){return r.elements.map(t=>C.evalAst(t,e))},evalCallExpression(r,e){let t=r.arguments.map(s=>C.evalAst(s,e));return C.evalAst(r.callee,e)(...t)},evalAssignmentExpression(r,e){if(r.left.type!=="Identifier")throw SyntaxError("Invalid left-hand side in assignment");let t=r.left.name,i=C.evalAst(r.right,e);return e[t]=i,e[t]}},be=class{constructor(e){this.code=e,this.ast=P(this.code)}runInNewContext(e){let t=Object.assign(Object.create(null),e);return C.evalAst(this.ast,t)}};function I(r,e){return r=r.slice(),r.push(e),r}function ye(r,e){return e=e.slice(),e.unshift(r),e}var me=class extends Error{constructor(e){super('JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),this.avoidNew=!0,this.value=e,this.name="NewError"}};function y(r,e,t,i,s){if(!(this instanceof y))try{return new y(r,e,t,i,s)}catch(o){if(!o.avoidNew)throw o;return o.value}typeof r=="string"&&(s=i,i=t,t=e,e=r,r=null);let n=r&&typeof r=="object";if(r=r||{},this.json=r.json||t,this.path=r.path||e,this.resultType=r.resultType||"value",this.flatten=r.flatten||!1,this.wrap=Object.hasOwn(r,"wrap")?r.wrap:!0,this.sandbox=r.sandbox||{},this.eval=r.eval===void 0?"safe":r.eval,this.ignoreEvalErrors=typeof r.ignoreEvalErrors>"u"?!1:r.ignoreEvalErrors,this.parent=r.parent||null,this.parentProperty=r.parentProperty||null,this.callback=r.callback||i||null,this.otherTypeCallback=r.otherTypeCallback||s||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},r.autostart!==!1){let o={path:n?r.path:e};n?"json"in r&&(o.json=r.json):o.json=t;let l=this.evaluate(o);if(!l||typeof l!="object")throw new me(l);return l}}y.prototype.evaluate=function(r,e,t,i){let s=this.parent,n=this.parentProperty,{flatten:o,wrap:l}=this;if(this.currResultType=this.resultType,this.currEval=this.eval,this.currSandbox=this.sandbox,t=t||this.callback,this.currOtherTypeCallback=i||this.otherTypeCallback,e=e||this.json,r=r||this.path,r&&typeof r=="object"&&!Array.isArray(r)){if(!r.path&&r.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!Object.hasOwn(r,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');({json:e}=r),o=Object.hasOwn(r,"flatten")?r.flatten:o,this.currResultType=Object.hasOwn(r,"resultType")?r.resultType:this.currResultType,this.currSandbox=Object.hasOwn(r,"sandbox")?r.sandbox:this.currSandbox,l=Object.hasOwn(r,"wrap")?r.wrap:l,this.currEval=Object.hasOwn(r,"eval")?r.eval:this.currEval,t=Object.hasOwn(r,"callback")?r.callback:t,this.currOtherTypeCallback=Object.hasOwn(r,"otherTypeCallback")?r.otherTypeCallback:this.currOtherTypeCallback,s=Object.hasOwn(r,"parent")?r.parent:s,n=Object.hasOwn(r,"parentProperty")?r.parentProperty:n,r=r.path}if(s=s||null,n=n||null,Array.isArray(r)&&(r=y.toPathString(r)),!r&&r!==""||!e)return;let a=y.toPathArray(r);a[0]==="$"&&a.length>1&&a.shift(),this._hasParentSelector=null;let f=this._trace(a,e,["$"],s,n,t).filter(function(u){return u&&!u.isParentSelector});return f.length?!l&&f.length===1&&!f[0].hasArrExpr?this._getPreferredOutput(f[0]):f.reduce((u,c)=>{let d=this._getPreferredOutput(c);return o&&Array.isArray(d)?u=u.concat(d):u.push(d),u},[]):l?[]:void 0};y.prototype._getPreferredOutput=function(r){let e=this.currResultType;switch(e){case"all":{let t=Array.isArray(r.path)?r.path:y.toPathArray(r.path);return r.pointer=y.toPointer(t),r.path=typeof r.path=="string"?r.path:y.toPathString(r.path),r}case"value":case"parent":case"parentProperty":return r[e];case"path":return y.toPathString(r[e]);case"pointer":return y.toPointer(r.path);default:throw new TypeError("Unknown result type")}};y.prototype._handleCallback=function(r,e,t){if(e){let i=this._getPreferredOutput(r);r.path=typeof r.path=="string"?r.path:y.toPathString(r.path),e(i,t,r)}};y.prototype._trace=function(r,e,t,i,s,n,o,l){let a;if(!r.length)return a={path:t,value:e,parent:i,parentProperty:s,hasArrExpr:o},this._handleCallback(a,n,"value"),a;let f=r[0],u=r.slice(1),c=[];function d(h){Array.isArray(h)?h.forEach(b=>{c.push(b)}):c.push(h)}if((typeof f!="string"||l)&&e&&Object.hasOwn(e,f))d(this._trace(u,e[f],I(t,f),e,f,n,o));else if(f==="*")this._walk(e,h=>{d(this._trace(u,e[h],I(t,h),e,h,n,!0,!0))});else if(f==="..")d(this._trace(u,e,t,i,s,n,o)),this._walk(e,h=>{typeof e[h]=="object"&&d(this._trace(r.slice(),e[h],I(t,h),e,h,n,!0))});else{if(f==="^")return this._hasParentSelector=!0,{path:t.slice(0,-1),expr:u,isParentSelector:!0};if(f==="~")return a={path:I(t,f),value:s,parent:i,parentProperty:null},this._handleCallback(a,n,"property"),a;if(f==="$")d(this._trace(u,e,t,null,null,n,o));else if(/^(-?\d*):(-?\d*):?(\d*)$/u.test(f))d(this._slice(f,u,e,t,i,s,n));else if(f.indexOf("?(")===0){if(this.currEval===!1)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");let h=f.replace(/^\?\((.*?)\)$/u,"$1"),b=/@.?([^?]*)[['](\??\(.*?\))(?!.\)\])[\]']/gu.exec(h);b?this._walk(e,p=>{let m=[b[2]],g=b[1]?e[p][b[1]]:e[p];this._trace(m,g,t,i,s,n,!0).length>0&&d(this._trace(u,e[p],I(t,p),e,p,n,!0))}):this._walk(e,p=>{this._eval(h,e[p],p,t,i,s)&&d(this._trace(u,e[p],I(t,p),e,p,n,!0))})}else if(f[0]==="("){if(this.currEval===!1)throw new Error("Eval [(expr)] prevented in JSONPath expression.");d(this._trace(ye(this._eval(f,e,t.at(-1),t.slice(0,-1),i,s),u),e,t,i,s,n,o))}else if(f[0]==="@"){let h=!1,b=f.slice(1,-2);switch(b){case"scalar":(!e||!["object","function"].includes(typeof e))&&(h=!0);break;case"boolean":case"string":case"undefined":case"function":typeof e===b&&(h=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(h=!0);break;case"number":Number.isFinite(e)&&(h=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(h=!0);break;case"object":e&&typeof e===b&&(h=!0);break;case"array":Array.isArray(e)&&(h=!0);break;case"other":h=this.currOtherTypeCallback(e,t,i,s);break;case"null":e===null&&(h=!0);break;default:throw new TypeError("Unknown value type "+b)}if(h)return a={path:t,value:e,parent:i,parentProperty:s},this._handleCallback(a,n,"value"),a}else if(f[0]==="`"&&e&&Object.hasOwn(e,f.slice(1))){let h=f.slice(1);d(this._trace(u,e[h],I(t,h),e,h,n,o,!0))}else if(f.includes(",")){let h=f.split(",");for(let b of h)d(this._trace(ye(b,u),e,t,i,s,n,!0))}else!l&&e&&Object.hasOwn(e,f)&&d(this._trace(u,e[f],I(t,f),e,f,n,o,!0))}if(this._hasParentSelector)for(let h=0;h<c.length;h++){let b=c[h];if(b&&b.isParentSelector){let p=this._trace(b.expr,e,b.path,i,s,n,o);if(Array.isArray(p)){c[h]=p[0];let m=p.length;for(let g=1;g<m;g++)h++,c.splice(h,0,p[g])}else c[h]=p}}return c};y.prototype._walk=function(r,e){if(Array.isArray(r)){let t=r.length;for(let i=0;i<t;i++)e(i)}else r&&typeof r=="object"&&Object.keys(r).forEach(t=>{e(t)})};y.prototype._slice=function(r,e,t,i,s,n,o){if(!Array.isArray(t))return;let l=t.length,a=r.split(":"),f=a[2]&&Number.parseInt(a[2])||1,u=a[0]&&Number.parseInt(a[0])||0,c=a[1]&&Number.parseInt(a[1])||l;u=u<0?Math.max(0,u+l):Math.min(l,u),c=c<0?Math.max(0,c+l):Math.min(l,c);let d=[];for(let h=u;h<c;h+=f)this._trace(ye(h,e),t,i,s,n,o,!0).forEach(p=>{d.push(p)});return d};y.prototype._eval=function(r,e,t,i,s,n){this.currSandbox._$_parentProperty=n,this.currSandbox._$_parent=s,this.currSandbox._$_property=t,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;let o=r.includes("@path");o&&(this.currSandbox._$_path=y.toPathString(i.concat([t])));let l=this.currEval+"Script:"+r;if(!y.cache[l]){let a=r.replaceAll("@parentProperty","_$_parentProperty").replaceAll("@parent","_$_parent").replaceAll("@property","_$_property").replaceAll("@root","_$_root").replaceAll(/@([.\s)[])/gu,"_$_v$1");if(o&&(a=a.replaceAll("@path","_$_path")),this.currEval==="safe"||this.currEval===!0||this.currEval===void 0)y.cache[l]=new this.safeVm.Script(a);else if(this.currEval==="native")y.cache[l]=new this.vm.Script(a);else if(typeof this.currEval=="function"&&this.currEval.prototype&&Object.hasOwn(this.currEval.prototype,"runInNewContext")){let f=this.currEval;y.cache[l]=new f(a)}else if(typeof this.currEval=="function")y.cache[l]={runInNewContext:f=>this.currEval(a,f)};else throw new TypeError(`Unknown "eval" property "${this.currEval}"`)}try{return y.cache[l].runInNewContext(this.currSandbox)}catch(a){if(this.ignoreEvalErrors)return!1;throw new Error("jsonPath: "+a.message+": "+r)}};y.cache={};y.toPathString=function(r){let e=r,t=e.length,i="$";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(i+=/^[0-9*]+$/u.test(e[s])?"["+e[s]+"]":"['"+e[s]+"']");return i};y.toPointer=function(r){let e=r,t=e.length,i="";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(i+="/"+e[s].toString().replaceAll("~","~0").replaceAll("/","~1"));return i};y.toPathArray=function(r){let{cache:e}=y;if(e[r])return e[r].concat();let t=[],s=r.replaceAll(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/gu,";$&;").replaceAll(/[['](\??\(.*?\))[\]'](?!.\])/gu,function(n,o){return"[#"+(t.push(o)-1)+"]"}).replaceAll(/\[['"]([^'\]]*)['"]\]/gu,function(n,o){return"['"+o.replaceAll(".","%@%").replaceAll("~","%%@@%%")+"']"}).replaceAll("~",";~;").replaceAll(/['"]?\.['"]?(?![^[]*\])|\[['"]?/gu,";").replaceAll("%@%",".").replaceAll("%%@@%%","~").replaceAll(/(?:;)?(\^+)(?:;)?/gu,function(n,o){return";"+o.split("").join(";")+";"}).replaceAll(/;;;|;;/gu,";..;").replaceAll(/;$|'?\]|'$/gu,"").split(";").map(function(n){let o=n.match(/#(\d+)/u);return!o||!o[1]?n:t[o[1]]});return e[r]=s,e[r].concat()};y.prototype.safeVm={Script:be};y.prototype.vm=ze.default;var N=(0,Ee.default)("glue-table-cache:sql"),Q=(0,Ee.default)("glue-table-cache:sql:ast"),j=class{constructor(e){this.db=e}async getQueryAST(e){let t=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;N("Serializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to serialize SQL query");let n=JSON.parse(s[0][0]);if(n.error)throw new Error(JSON.stringify(n));return n}async getSqlFromAst(e){let t=`SELECT json_deserialize_sql('${JSON.stringify(e).replace(/'/g,"''")}')`;N("Deserializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to deserialize SQL query");return s[0][0]+";"}async transformGlueTableQuery(e){N("Transforming query: %s",e);let t=await this.getQueryAST(e);Q("Original AST: %O",t),this.transformNode(t),Q("Transformed AST: %O",t);let i=await this.getSqlFromAst(t);return N("Transformed query: %s",i),i}async getQueryGlueTableRefs(e){let t=await this.getQueryAST(e);return Q("Original AST: %O",t),this.getAstGlueTableRefs(t)}getAstGlueTableRefs(e){return this.getAstTableRefs(e).map(t=>t.tableRef).filter(Boolean)}getAstTableRefs(e){return y({path:"$..*[?(@ && @.type=='BASE_TABLE' && (@.catalog_name=='glue' || @.catalog_name=='GLUE'))]",json:e}).map(n=>({node:n,tableRef:this.getGlueTableRef(n)}))}transformNode(e){N("Finding Glue table references in AST"),Q("AST structure:",e);let t=this.getAstTableRefs(e);N("Found %d Glue table references",t.length),Q("Table references:",t),y({path:"$..query_location",json:e,resultType:"pointer"}).forEach(s=>{let n=s.split("/").filter(Boolean);n.pop();let o=e;for(let l of n)o=o[l];o&&(o.query_location=void 0)});for(let s of t){let n=s.tableRef;n&&(N("Transforming table reference %s.%s",n.database,n.table),Object.assign(s.node,{type:"TABLE_FUNCTION",function:{class:"FUNCTION",type:"FUNCTION",function_name:"parquet_scan",schema:"",catalog:"",children:[{class:"FUNCTION",type:"FUNCTION",function_name:"getvariable",schema:"",catalog:"",children:[{class:"CONSTANT",type:"VALUE_CONSTANT",value:{type:{id:"VARCHAR",type_info:null},is_null:!1,value:this.getQueryFilesVarName(n.database,n.table)}}]}],filter:null,order_bys:{type:"ORDER_MODIFIER",orders:[]},distinct:!1,is_operator:!1,export_state:!1}}))}}getGlueTableRef(e){return e.type==="BASE_TABLE"&&(e.catalog_name==="glue"||e.catalog_name==="GLUE")?{database:e.schema_name||"default",table:e.table_name}:null}async extractPartitionFilters(e,t,i){let s=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;N("Serializing SQL: %s",s);let o=(await this.db.runAndReadAll(s)).getRows();if(!o.length||o[0].length===0||o[0][0]===null)throw new Error("Failed to serialize SQL query");let l=JSON.parse(o[0][0]);if(l.error)throw new Error(JSON.stringify(l));Q("Original AST: %O",l);let a=new Set;return l?.statements?.[0]?.node?.where_clause&&this.extractFiltersFromCondition(l.statements[0].node.where_clause,i,a),Array.from(a)}findPartitionFilters(e,t,i,s){if(!(!e||typeof e!="object")){e.type==="SELECT"&&e.where&&this.extractFiltersFromCondition(e.where,i,s);for(let n in e)Array.isArray(e[n])?e[n].forEach(o=>this.findPartitionFilters(o,t,i,s)):typeof e[n]=="object"&&this.findPartitionFilters(e[n],t,i,s)}}extractFiltersFromCondition(e,t,i){if(!(!e||typeof e!="object")){if(e.class==="COMPARISON"){let s=e.left,n=e.right;if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])&&n?.class==="CONSTANT"&&n?.type==="VALUE_CONSTANT"){let o=n.value?.value;if(o!==void 0){let l=this.getComparisonOperator(e.type),a=typeof o=="string"?`'${o}'`:o;i.add(`${s.column_names[0]} ${l} ${a}`)}}}else if(e.class==="CONJUNCTION")e.children?.forEach(s=>this.extractFiltersFromCondition(s,t,i));else if(e.class==="OPERATOR"&&e.type==="COMPARE_IN"){let s=e.children?.[0];if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])){let n=e.children.slice(1).filter(o=>o.class==="CONSTANT"&&o.type==="VALUE_CONSTANT").map(o=>`'${o.value.value}'`);n.length>0&&i.add(`${s.column_names[0]} IN (${n.join(", ")})`)}}}}getComparisonOperator(e){switch(e){case"COMPARE_EQUAL":return"=";case"COMPARE_GREATERTHAN":return">";case"COMPARE_LESSTHAN":return"<";case"COMPARE_GREATERTHANOREQUALTO":return">=";case"COMPARE_LESSTHANOREQUALTO":return"<=";case"COMPARE_NOTEQUAL":return"!=";default:throw new Error(`Unsupported comparison type: ${e}`)}}getQueryFilesVarName(e,t){return`${e}_${t}_files`.replaceAll("-","")}getGlueTableFilesVarName(e,t){return`${e}_${t}_gview_files`.replaceAll("-","")}async getGlueTableViewSql(e){let t=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`,s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to serialize SQL query");let n=JSON.parse(s[0][0]);if(n.error)throw new Error(JSON.stringify(n));let o=this.getAstGlueTableRefs(n);if(!o.length)throw new Error("No Glue table references found in query");let l=[],a=new Set;for(let f of o){let u=this.getGlueTableFilesVarName(f.database,f.table),c=`${f.database}_${f.table}`;if(!a.has(c)){a.add(c);let d=`${c}_gview`.replaceAll("-",""),h=`SELECT * FROM parquet_scan(getvariable('${u}'))`;l.push(`CREATE OR REPLACE VIEW ${d} AS ${h};`)}}return l}};var U=(0,Oe.default)("glue-table-cache"),Ce=(0,Oe.default)("glue-table-cache:aws"),we={region:"eu-west-1",maxEntries:100,forceRefreshOnError:!0,glueTableMetadataTtlMs:36e5,s3ListingRefreshMs:36e5},ie=class{tableCache;s3ListingCache;glueClient;s3Client;db;sqlTransformer;config;constructor(e=we){U("Initializing GlueTableCache for region %s with config %O",e),this.config={...we,...e,region:e?.region||process.env.AWS_REGION||we.region},this.glueClient=new H.GlueClient({region:e.region}),this.s3Client=new se.S3Client({region:e.region}),this.tableCache=new J({max:this.config.maxEntries,ttl:this.config.glueTableMetadataTtlMs}),this.s3ListingCache=new J({max:this.config.maxEntries,ttl:this.config.s3ListingRefreshMs})}async runAndReadAll(e){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");return this.db.runAndReadAll(e)}async connect(){return this.db||(this.db=await(await Be.DuckDBInstance.create(":memory:")).connect()),this.sqlTransformer||(this.sqlTransformer=new j(this.db)),this.db}close(){this.db?.close(),this.db=void 0}async getTableMetadata(e,t){let i=`${e}.${t}`;U("Getting table metadata for %s",i);let s=this.tableCache.get(i);if(!s){U("Cache miss for %s, refreshing...",i);let n=await this.refreshTableMetadata(e,t),l={timestamp:Date.now(),data:n};return this.tableCache.set(i,l),n}return U("Cache hit for %s",i),s.data}async refreshTableMetadata(e,t){try{Ce("Fetching table metadata from AWS for %s.%s",e,t);let i={DatabaseName:e,Name:t},n=(await this.glueClient.send(new H.GetTableCommand(i))).Table;if(!n)throw new Error(`Table ${e}.${t} not found`);let o={timestamp:Date.now(),table:n};return n.Parameters?.["projection.enabled"]==="true"?o.projectionPatterns=this.parseProjectionPatterns(n.Parameters):n.PartitionKeys&&n.PartitionKeys.length>0&&(o.partitionMetadata=await this.loadPartitionMetadata(e,t)),o}catch(i){throw this.config.forceRefreshOnError&&this.tableCache.delete(`${e}.${t}`),i}}parseProjectionValue(e,t){switch(e){case"type":return t;case"format":return t;case"range":try{return JSON.parse(t)}catch{return t.split(",").map(i=>i.trim())}case"values":return JSON.parse(t);default:return t}}parseProjectionPatterns(e){let t={};return Object.entries(e).filter(([i])=>i.startsWith("projection.")).forEach(([i,s])=>{let n=i.match(/projection\.(\w+)\.(type|range|format|values)/);if(n){let[o,l,a]=n;t[l]||(t[l]={type:"enum"}),(a==="type"||a==="format"||a==="range"||a==="values")&&(t[l][a]=this.parseProjectionValue(a,s))}}),{enabled:!0,patterns:t}}async loadPartitionMetadata(e,t){let i=new H.GetPartitionsCommand({DatabaseName:e,TableName:t});try{let s=await this.glueClient.send(i);return!s.Partitions||s.Partitions.length===0?{keys:[],values:[]}:{keys:s.Partitions[0].Values||[],values:s.Partitions.map(n=>({values:n.Values||[],location:n.StorageDescriptor?.Location}))||[]}}catch(s){return console.warn(`Failed to load partitions for ${e}.${t}:`,s),{keys:[],values:[]}}}clearCache(){this.tableCache.clear(),this.s3ListingCache.clear()}invalidateTable(e,t){let i=`${e}.${t}`;this.tableCache.delete(i);for(let s of this.s3ListingCache.keys())s.includes(i)&&this.s3ListingCache.delete(s)}parseS3Path(e){let t=new URL(e);return{bucket:t.hostname,prefix:t.pathname.substring(1)}}extractPartitionValues(e,t){let i={};for(let s of t){let n=e.match(new RegExp(`${s}=([^/]+)`));n&&(i[s]=n[1])}return i}async listS3Files(e,t){let i=`${e}:${t.join(",")}`,s=this.s3ListingCache.get(i);if(s)return Ce("Using cached S3 listing for %s",e),s.data;Ce("Listing S3 files for %s",e);let{bucket:n,prefix:o}=this.parseS3Path(e),l=[],a=o.endsWith("/")?o:`${o}/`,f;do{let c=new se.ListObjectsV2Command({Bucket:n,Prefix:a,ContinuationToken:f,MaxKeys:1e3}),d=await this.s3Client.send(c);if(d.Contents){for(let h of d.Contents)if(h.Key&&!h.Key.includes("_$folder$")){let b=`s3://${n}/${h.Key}`,p=this.extractPartitionValues(b,t);l.push({path:b,partitionValues:p})}}f=d.NextContinuationToken}while(f);let u=Date.now();return this.s3ListingCache.set(i,{timestamp:u,data:l}),l}async getPartitionExtractor(e,t){if(t.projectionPatterns?.enabled){let i=t.projectionPatterns.patterns[e];if(!i)throw new Error(`No projection pattern found for partition key ${e}`);switch(i.type){case"date":let s=i.format||"yyyy-MM-dd";return`regexp_extract(path, '(${this.convertDateFormatToRegex(s)})', 1)`;case"integer":return"CAST(regexp_extract(path, '/([0-9]+)/', 1) AS INTEGER)";case"enum":return"regexp_extract(path, '/([^/]+)/[^/]*$', 1)";case"injected":throw this.sqlTransformer||await this.connect(),this.sqlTransformer?new Error("Injected partition values not supported yet"):new Error("SQL transformer not initialized");default:throw new Error(`Unsupported projection type: ${i.type}`)}}return`regexp_extract(path, '${e}=([^/]+)', 1)`}convertDateFormatToRegex(e){let t={yyyy:"\\d{4}",MM:"\\d{2}",dd:"\\d{2}",HH:"\\d{2}",mm:"\\d{2}",ss:"\\d{2}"},i=e;for(let[s,n]of Object.entries(t))i=i.replace(s,n);return i}async createGlueTableFilesVarSql(e,t,i){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new j(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let n=`SELECT path FROM "${`${e}.${t}`}_s3_listing"`;return i&&i.length>0&&(n+=` WHERE ${i.join(" AND ")}`),`SET VARIABLE ${this.sqlTransformer?.getGlueTableFilesVarName(e,t)} = ( SELECT list(path) FROM (${n}));`}async convertGlueTableQuery(e){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new j(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=await this.getGlueTableViewSetupSql(e),i=await this.sqlTransformer.transformGlueTableQuery(e);return t.join("")+i}async getGlueTableViewSetupSql(e){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new j(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=[],i=await this.sqlTransformer.getQueryGlueTableRefs(e);U("Found Glue Table references: %O",i),await Promise.all(i.map(async({database:n,table:o})=>{U("Found Glue Table reference: %s",{database:n,table:o});let l=await this.getTableMetadata(n,o),a=`${n}.${o}`,f=l.table.StorageDescriptor?.Location;if(!f)throw new Error(`No storage location found for ${a}`);let u=(l.table.PartitionKeys||[]).map(E=>E.Name),c=await this.listS3Files(f,u);t.push(`CREATE OR REPLACE TABLE "${a}_s3_files" AS SELECT path FROM (VALUES ${c.map(E=>`('${E.path}')`).join(",")}) t(path);`);let d=await Promise.all(u.map(async E=>`${await this.getPartitionExtractor(E,l)} as ${E}`));t.push(`CREATE OR REPLACE TABLE "${a}_s3_listing" AS SELECT path, ${d.join(", ")} FROM "${a}_s3_files";`);for(let E of u)t.push(`CREATE INDEX IF NOT EXISTS idx_${E} ON "${a}_s3_listing" (${E});`);if(!this.sqlTransformer)throw new Error("SQL transformer not initialized");u=(l.table.PartitionKeys||[]).map(E=>E.Name);let h=await this.sqlTransformer.extractPartitionFilters(e,a,u),b=`SELECT list(path) FROM "${a}_s3_listing"`;h.length>0&&(b+=` WHERE ${h.join(" AND ")}`);let p=this.sqlTransformer.getQueryFilesVarName(n,o);t.push(`SET VARIABLE ${p} = (${b});`);let m=await this.createGlueTableFilesVarSql(n,o);m&&t.push(m);let g=await this.sqlTransformer.getGlueTableViewSql(e);t.push(...g)}));let s=t.map(n=>n.trim());return U(s),s}};0&&(module.exports={GlueTableCache});
