var je=Object.create;var we=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var Be=Object.getPrototypeOf,qe=Object.prototype.hasOwnProperty;var J=(i=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(i,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):i)(function(i){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+i+'" is not supported')});var k=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var Ge=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ze(e))!qe.call(i,s)&&s!==t&&we(i,s,{get:()=>e[s],enumerable:!(r=Ue(e,s))||r.enumerable});return i};var Oe=(i,e,t)=>(t=i!=null?je(Be(i)):{},Ge(e||!i||!i.__esModule?we(t,"default",{value:i,enumerable:!0}):t,i));var Re=k((It,_e)=>{var q=1e3,G=q*60,V=G*60,j=V*24,We=j*7,Qe=j*365.25;_e.exports=function(i,e){e=e||{};var t=typeof i;if(t==="string"&&i.length>0)return He(i);if(t==="number"&&isFinite(i))return e.long?Je(i):Ke(i);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(i))};function He(i){if(i=String(i),!(i.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(i);if(e){var t=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return t*Qe;case"weeks":case"week":case"w":return t*We;case"days":case"day":case"d":return t*j;case"hours":case"hour":case"hrs":case"hr":case"h":return t*V;case"minutes":case"minute":case"mins":case"min":case"m":return t*G;case"seconds":case"second":case"secs":case"sec":case"s":return t*q;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Ke(i){var e=Math.abs(i);return e>=j?Math.round(i/j)+"d":e>=V?Math.round(i/V)+"h":e>=G?Math.round(i/G)+"m":e>=q?Math.round(i/q)+"s":i+"ms"}function Je(i){var e=Math.abs(i);return e>=j?Y(i,e,j,"day"):e>=V?Y(i,e,V,"hour"):e>=G?Y(i,e,G,"minute"):e>=q?Y(i,e,q,"second"):i+" ms"}function Y(i,e,t,r){var s=e>=t*1.5;return Math.round(i/t)+" "+r+(s?"s":"")}});var se=k((Nt,ve)=>{function Xe(i){t.debug=t,t.default=t,t.coerce=a,t.disable=o,t.enable=s,t.enabled=l,t.humanize=Re(),t.destroy=f,Object.keys(i).forEach(u=>{t[u]=i[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let h=0;for(let d=0;d<u.length;d++)h=(h<<5)-h+u.charCodeAt(d),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(u){let h,d=null,c,b;function p(...E){if(!p.enabled)return;let g=p,m=Number(new Date),R=m-(h||m);g.diff=R,g.prev=h,g.curr=m,h=m,E[0]=t.coerce(E[0]),typeof E[0]!="string"&&E.unshift("%O");let w=0;E[0]=E[0].replace(/%([a-zA-Z%])/g,(P,v)=>{if(P==="%%")return"%";w++;let M=t.formatters[v];if(typeof M=="function"){let H=E[w];P=M.call(g,H),E.splice(w,1),w--}return P}),t.formatArgs.call(g,E),(g.log||t.log).apply(g,E)}return p.namespace=u,p.useColors=t.useColors(),p.color=t.selectColor(u),p.extend=r,p.destroy=t.destroy,Object.defineProperty(p,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(c!==t.namespaces&&(c=t.namespaces,b=t.enabled(u)),b),set:E=>{d=E}}),typeof t.init=="function"&&t.init(p),p}function r(u,h){let d=t(this.namespace+(typeof h>"u"?":":h)+u);return d.log=this.log,d}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let h=(typeof u=="string"?u:"").trim().replace(" ",",").split(",").filter(Boolean);for(let d of h)d[0]==="-"?t.skips.push(d.slice(1)):t.names.push(d)}function n(u,h){let d=0,c=0,b=-1,p=0;for(;d<u.length;)if(c<h.length&&(h[c]===u[d]||h[c]==="*"))h[c]==="*"?(b=c,p=d,c++):(d++,c++);else if(b!==-1)c=b+1,p++,d=p;else return!1;for(;c<h.length&&h[c]==="*";)c++;return c===h.length}function o(){let u=[...t.names,...t.skips.map(h=>"-"+h)].join(",");return t.enable(""),u}function l(u){for(let h of t.skips)if(n(u,h))return!1;for(let h of t.names)if(n(u,h))return!0;return!1}function a(u){return u instanceof Error?u.stack||u.message:u}function f(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}ve.exports=Xe});var Fe=k((x,Z)=>{x.formatArgs=Ze;x.save=et;x.load=tt;x.useColors=Ye;x.storage=it();x.destroy=(()=>{let i=!1;return()=>{i||(i=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();x.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Ye(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let i;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(i=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(i[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Ze(i){if(i[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+i[0]+(this.useColors?"%c ":" ")+"+"+Z.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;i.splice(1,0,e,"color: inherit");let t=0,r=0;i[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(r=t))}),i.splice(r,0,e)}x.log=console.debug||console.log||(()=>{});function et(i){try{i?x.storage.setItem("debug",i):x.storage.removeItem("debug")}catch{}}function tt(){let i;try{i=x.storage.getItem("debug")}catch{}return!i&&typeof process<"u"&&"env"in process&&(i=process.env.DEBUG),i}function it(){try{return localStorage}catch{}}Z.exports=se()(x);var{formatters:rt}=Z.exports;rt.j=function(i){try{return JSON.stringify(i)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Le=k(($t,Pe)=>{"use strict";Pe.exports=(i,e=process.argv)=>{let t=i.startsWith("-")?"":i.length===1?"-":"--",r=e.indexOf(t+i),s=e.indexOf("--");return r!==-1&&(s===-1||r<s)}});var Ne=k((Mt,Ie)=>{"use strict";var st=J("os"),De=J("tty"),_=Le(),{env:O}=process,I;_("no-color")||_("no-colors")||_("color=false")||_("color=never")?I=0:(_("color")||_("colors")||_("color=true")||_("color=always"))&&(I=1);"FORCE_COLOR"in O&&(O.FORCE_COLOR==="true"?I=1:O.FORCE_COLOR==="false"?I=0:I=O.FORCE_COLOR.length===0?1:Math.min(parseInt(O.FORCE_COLOR,10),3));function ne(i){return i===0?!1:{level:i,hasBasic:!0,has256:i>=2,has16m:i>=3}}function oe(i,e){if(I===0)return 0;if(_("color=16m")||_("color=full")||_("color=truecolor"))return 3;if(_("color=256"))return 2;if(i&&!e&&I===void 0)return 0;let t=I||0;if(O.TERM==="dumb")return t;if(process.platform==="win32"){let r=st.release().split(".");return Number(r[0])>=10&&Number(r[2])>=10586?Number(r[2])>=14931?3:2:1}if("CI"in O)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some(r=>r in O)||O.CI_NAME==="codeship"?1:t;if("TEAMCITY_VERSION"in O)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(O.TEAMCITY_VERSION)?1:0;if(O.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in O){let r=parseInt((O.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(O.TERM_PROGRAM){case"iTerm.app":return r>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(O.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(O.TERM)||"COLORTERM"in O?1:t}function nt(i){let e=oe(i,i&&i.isTTY);return ne(e)}Ie.exports={supportsColor:nt,stdout:ne(oe(!0,De.isatty(1))),stderr:ne(oe(!0,De.isatty(2)))}});var Me=k((A,te)=>{var ot=J("tty"),ee=J("util");A.init=dt;A.log=ct;A.formatArgs=lt;A.save=ut;A.load=ft;A.useColors=at;A.destroy=ee.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");A.colors=[6,2,3,4,5,1];try{let i=Ne();i&&(i.stderr||i).level>=2&&(A.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch{}A.inspectOpts=Object.keys(process.env).filter(i=>/^debug_/i.test(i)).reduce((i,e)=>{let t=e.substring(6).toLowerCase().replace(/_([a-z])/g,(s,n)=>n.toUpperCase()),r=process.env[e];return/^(yes|on|true|enabled)$/i.test(r)?r=!0:/^(no|off|false|disabled)$/i.test(r)?r=!1:r==="null"?r=null:r=Number(r),i[t]=r,i},{});function at(){return"colors"in A.inspectOpts?!!A.inspectOpts.colors:ot.isatty(process.stderr.fd)}function lt(i){let{namespace:e,useColors:t}=this;if(t){let r=this.color,s="\x1B[3"+(r<8?r:"8;5;"+r),n=`  ${s};1m${e} \x1B[0m`;i[0]=n+i[0].split(`
`).join(`
`+n),i.push(s+"m+"+te.exports.humanize(this.diff)+"\x1B[0m")}else i[0]=ht()+e+" "+i[0]}function ht(){return A.inspectOpts.hideDate?"":new Date().toISOString()+" "}function ct(...i){return process.stderr.write(ee.formatWithOptions(A.inspectOpts,...i)+`
`)}function ut(i){i?process.env.DEBUG=i:delete process.env.DEBUG}function ft(){return process.env.DEBUG}function dt(i){i.inspectOpts={};let e=Object.keys(A.inspectOpts);for(let t=0;t<e.length;t++)i.inspectOpts[e[t]]=A.inspectOpts[e[t]]}te.exports=se()(A);var{formatters:$e}=te.exports;$e.o=function(i){return this.inspectOpts.colors=this.useColors,ee.inspect(i,this.inspectOpts).split(`
`).map(e=>e.trim()).join(" ")};$e.O=function(i){return this.inspectOpts.colors=this.useColors,ee.inspect(i,this.inspectOpts)}});var le=k((kt,ae)=>{typeof process>"u"||process.type==="renderer"||process.browser===!0||process.__nwjs?ae.exports=Fe():ae.exports=Me()});import{GetPartitionsCommand as At,GetTableCommand as St,GlueClient as Tt}from"@aws-sdk/client-glue";import{S3Client as xt,ListObjectsV2Command as _t}from"@aws-sdk/client-s3";var z=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,Se=new Set,ie=typeof process=="object"&&process?process:{},Te=(i,e,t,r)=>{typeof ie.emitWarning=="function"?ie.emitWarning(i,e,t,r):console.error(`[${t}] ${e}: ${i}`)},X=globalThis.AbortController,Ae=globalThis.AbortSignal;if(typeof X>"u"){Ae=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(r,s){this._onabort.push(s)}},X=class{constructor(){e()}signal=new Ae;abort(r){if(!this.signal.aborted){this.signal.reason=r,this.signal.aborted=!0;for(let s of this.signal._onabort)s(r);this.signal.onabort?.(r)}}};let i=ie.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1",e=()=>{i&&(i=!1,Te("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}var Ve=i=>!Se.has(i),Lt=Symbol("type"),D=i=>i&&i===Math.floor(i)&&i>0&&isFinite(i),xe=i=>D(i)?i<=Math.pow(2,8)?Uint8Array:i<=Math.pow(2,16)?Uint16Array:i<=Math.pow(2,32)?Uint32Array:i<=Number.MAX_SAFE_INTEGER?B:null:null,B=class extends Array{constructor(e){super(e),this.fill(0)}},re=class i{heap;length;static#l=!1;static create(e){let t=xe(e);if(!t)return[];i.#l=!0;let r=new i(e,t);return i.#l=!1,r}constructor(e,t){if(!i.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}},K=class i{#l;#u;#g;#b;#F;#P;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#s;#y;#r;#i;#e;#h;#f;#a;#n;#E;#o;#m;#C;#d;#w;#x;#c;static unsafeExposeInternals(e){return{starts:e.#C,ttls:e.#d,sizes:e.#m,keyMap:e.#r,keyList:e.#i,valList:e.#e,next:e.#h,prev:e.#f,get head(){return e.#a},get tail(){return e.#n},free:e.#E,isBackgroundFetch:t=>e.#t(t),backgroundFetch:(t,r,s,n)=>e.#I(t,r,s,n),moveToTail:t=>e.#v(t),indexes:t=>e.#O(t),rindexes:t=>e.#A(t),isStale:t=>e.#p(t)}}get max(){return this.#l}get maxSize(){return this.#u}get calculatedSize(){return this.#y}get size(){return this.#s}get fetchMethod(){return this.#F}get memoMethod(){return this.#P}get dispose(){return this.#g}get disposeAfter(){return this.#b}constructor(e){let{max:t=0,ttl:r,ttlResolution:s=1,ttlAutopurge:n,updateAgeOnGet:o,updateAgeOnHas:l,allowStale:a,dispose:f,disposeAfter:u,noDisposeOnSet:h,noUpdateTTL:d,maxSize:c=0,maxEntrySize:b=0,sizeCalculation:p,fetchMethod:E,memoMethod:g,noDeleteOnFetchRejection:m,noDeleteOnStaleGet:R,allowStaleOnFetchRejection:w,allowStaleOnFetchAbort:T,ignoreFetchAbort:P}=e;if(t!==0&&!D(t))throw new TypeError("max option must be a nonnegative integer");let v=t?xe(t):Array;if(!v)throw new Error("invalid max value: "+t);if(this.#l=t,this.#u=c,this.maxEntrySize=b||this.#u,this.sizeCalculation=p,this.sizeCalculation){if(!this.#u&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(g!==void 0&&typeof g!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#P=g,E!==void 0&&typeof E!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#F=E,this.#x=!!E,this.#r=new Map,this.#i=new Array(t).fill(void 0),this.#e=new Array(t).fill(void 0),this.#h=new v(t),this.#f=new v(t),this.#a=0,this.#n=0,this.#E=re.create(t),this.#s=0,this.#y=0,typeof f=="function"&&(this.#g=f),typeof u=="function"?(this.#b=u,this.#o=[]):(this.#b=void 0,this.#o=void 0),this.#w=!!this.#g,this.#c=!!this.#b,this.noDisposeOnSet=!!h,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!m,this.allowStaleOnFetchRejection=!!w,this.allowStaleOnFetchAbort=!!T,this.ignoreFetchAbort=!!P,this.maxEntrySize!==0){if(this.#u!==0&&!D(this.#u))throw new TypeError("maxSize must be a positive integer if specified");if(!D(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#z()}if(this.allowStale=!!a,this.noDeleteOnStaleGet=!!R,this.updateAgeOnGet=!!o,this.updateAgeOnHas=!!l,this.ttlResolution=D(s)||s===0?s:1,this.ttlAutopurge=!!n,this.ttl=r||0,this.ttl){if(!D(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#N()}if(this.#l===0&&this.ttl===0&&this.#u===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#u){let M="LRU_CACHE_UNBOUNDED";Ve(M)&&(Se.add(M),Te("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",M,i))}}getRemainingTTL(e){return this.#r.has(e)?1/0:0}#N(){let e=new B(this.#l),t=new B(this.#l);this.#d=e,this.#C=t,this.#$=(n,o,l=z.now())=>{if(t[n]=o!==0?l:0,e[n]=o,o!==0&&this.ttlAutopurge){let a=setTimeout(()=>{this.#p(n)&&this.#S(this.#i[n],"expire")},o+1);a.unref&&a.unref()}},this.#_=n=>{t[n]=e[n]!==0?z.now():0},this.#T=(n,o)=>{if(e[o]){let l=e[o],a=t[o];if(!l||!a)return;n.ttl=l,n.start=a,n.now=r||s();let f=n.now-a;n.remainingTTL=l-f}};let r=0,s=()=>{let n=z.now();if(this.ttlResolution>0){r=n;let o=setTimeout(()=>r=0,this.ttlResolution);o.unref&&o.unref()}return n};this.getRemainingTTL=n=>{let o=this.#r.get(n);if(o===void 0)return 0;let l=e[o],a=t[o];if(!l||!a)return 1/0;let f=(r||s())-a;return l-f},this.#p=n=>{let o=t[n],l=e[n];return!!l&&!!o&&(r||s())-o>l}}#_=()=>{};#T=()=>{};#$=()=>{};#p=()=>!1;#z(){let e=new B(this.#l);this.#y=0,this.#m=e,this.#R=t=>{this.#y-=e[t],e[t]=0},this.#M=(t,r,s,n)=>{if(this.#t(r))return 0;if(!D(s))if(n){if(typeof n!="function")throw new TypeError("sizeCalculation must be a function");if(s=n(r,t),!D(s))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return s},this.#L=(t,r,s)=>{if(e[t]=r,this.#u){let n=this.#u-e[t];for(;this.#y>n;)this.#D(!0)}this.#y+=e[t],s&&(s.entrySize=r,s.totalCalculatedSize=this.#y)}}#R=e=>{};#L=(e,t,r)=>{};#M=(e,t,r,s)=>{if(r||s)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#O({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#n;!(!this.#k(t)||((e||!this.#p(t))&&(yield t),t===this.#a));)t=this.#f[t]}*#A({allowStale:e=this.allowStale}={}){if(this.#s)for(let t=this.#a;!(!this.#k(t)||((e||!this.#p(t))&&(yield t),t===this.#n));)t=this.#h[t]}#k(e){return e!==void 0&&this.#r.get(this.#i[e])===e}*entries(){for(let e of this.#O())this.#e[e]!==void 0&&this.#i[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#i[e],this.#e[e]])}*rentries(){for(let e of this.#A())this.#e[e]!==void 0&&this.#i[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#i[e],this.#e[e]])}*keys(){for(let e of this.#O()){let t=this.#i[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*rkeys(){for(let e of this.#A()){let t=this.#i[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*values(){for(let e of this.#O())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}*rvalues(){for(let e of this.#A())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(let r of this.#O()){let s=this.#e[r],n=this.#t(s)?s.__staleWhileFetching:s;if(n!==void 0&&e(n,this.#i[r],this))return this.get(this.#i[r],t)}}forEach(e,t=this){for(let r of this.#O()){let s=this.#e[r],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#i[r],this)}}rforEach(e,t=this){for(let r of this.#A()){let s=this.#e[r],n=this.#t(s)?s.__staleWhileFetching:s;n!==void 0&&e.call(t,n,this.#i[r],this)}}purgeStale(){let e=!1;for(let t of this.#A({allowStale:!0}))this.#p(t)&&(this.#S(this.#i[t],"expire"),e=!0);return e}info(e){let t=this.#r.get(e);if(t===void 0)return;let r=this.#e[t],s=this.#t(r)?r.__staleWhileFetching:r;if(s===void 0)return;let n={value:s};if(this.#d&&this.#C){let o=this.#d[t],l=this.#C[t];if(o&&l){let a=o-(z.now()-l);n.ttl=a,n.start=Date.now()}}return this.#m&&(n.size=this.#m[t]),n}dump(){let e=[];for(let t of this.#O({allowStale:!0})){let r=this.#i[t],s=this.#e[t],n=this.#t(s)?s.__staleWhileFetching:s;if(n===void 0||r===void 0)continue;let o={value:n};if(this.#d&&this.#C){o.ttl=this.#d[t];let l=z.now()-this.#C[t];o.start=Math.floor(Date.now()-l)}this.#m&&(o.size=this.#m[t]),e.unshift([r,o])}return e}load(e){this.clear();for(let[t,r]of e){if(r.start){let s=Date.now()-r.start;r.start=z.now()-s}this.set(t,r.value,r)}}set(e,t,r={}){if(t===void 0)return this.delete(e),this;let{ttl:s=this.ttl,start:n,noDisposeOnSet:o=this.noDisposeOnSet,sizeCalculation:l=this.sizeCalculation,status:a}=r,{noUpdateTTL:f=this.noUpdateTTL}=r,u=this.#M(e,t,r.size||0,l);if(this.maxEntrySize&&u>this.maxEntrySize)return a&&(a.set="miss",a.maxEntrySizeExceeded=!0),this.#S(e,"set"),this;let h=this.#s===0?void 0:this.#r.get(e);if(h===void 0)h=this.#s===0?this.#n:this.#E.length!==0?this.#E.pop():this.#s===this.#l?this.#D(!1):this.#s,this.#i[h]=e,this.#e[h]=t,this.#r.set(e,h),this.#h[this.#n]=h,this.#f[h]=this.#n,this.#n=h,this.#s++,this.#L(h,u,a),a&&(a.set="add"),f=!1;else{this.#v(h);let d=this.#e[h];if(t!==d){if(this.#x&&this.#t(d)){d.__abortController.abort(new Error("replaced"));let{__staleWhileFetching:c}=d;c!==void 0&&!o&&(this.#w&&this.#g?.(c,e,"set"),this.#c&&this.#o?.push([c,e,"set"]))}else o||(this.#w&&this.#g?.(d,e,"set"),this.#c&&this.#o?.push([d,e,"set"]));if(this.#R(h),this.#L(h,u,a),this.#e[h]=t,a){a.set="replace";let c=d&&this.#t(d)?d.__staleWhileFetching:d;c!==void 0&&(a.oldValue=c)}}else a&&(a.set="update")}if(s!==0&&!this.#d&&this.#N(),this.#d&&(f||this.#$(h,s,n),a&&this.#T(a,h)),!o&&this.#c&&this.#o){let d=this.#o,c;for(;c=d?.shift();)this.#b?.(...c)}return this}pop(){try{for(;this.#s;){let e=this.#e[this.#a];if(this.#D(!0),this.#t(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#c&&this.#o){let e=this.#o,t;for(;t=e?.shift();)this.#b?.(...t)}}}#D(e){let t=this.#a,r=this.#i[t],s=this.#e[t];return this.#x&&this.#t(s)?s.__abortController.abort(new Error("evicted")):(this.#w||this.#c)&&(this.#w&&this.#g?.(s,r,"evict"),this.#c&&this.#o?.push([s,r,"evict"])),this.#R(t),e&&(this.#i[t]=void 0,this.#e[t]=void 0,this.#E.push(t)),this.#s===1?(this.#a=this.#n=0,this.#E.length=0):this.#a=this.#h[t],this.#r.delete(r),this.#s--,t}has(e,t={}){let{updateAgeOnHas:r=this.updateAgeOnHas,status:s}=t,n=this.#r.get(e);if(n!==void 0){let o=this.#e[n];if(this.#t(o)&&o.__staleWhileFetching===void 0)return!1;if(this.#p(n))s&&(s.has="stale",this.#T(s,n));else return r&&this.#_(n),s&&(s.has="hit",this.#T(s,n)),!0}else s&&(s.has="miss");return!1}peek(e,t={}){let{allowStale:r=this.allowStale}=t,s=this.#r.get(e);if(s===void 0||!r&&this.#p(s))return;let n=this.#e[s];return this.#t(n)?n.__staleWhileFetching:n}#I(e,t,r,s){let n=t===void 0?void 0:this.#e[t];if(this.#t(n))return n;let o=new X,{signal:l}=r;l?.addEventListener("abort",()=>o.abort(l.reason),{signal:o.signal});let a={signal:o.signal,options:r,context:s},f=(p,E=!1)=>{let{aborted:g}=o.signal,m=r.ignoreFetchAbort&&p!==void 0;if(r.status&&(g&&!E?(r.status.fetchAborted=!0,r.status.fetchError=o.signal.reason,m&&(r.status.fetchAbortIgnored=!0)):r.status.fetchResolved=!0),g&&!m&&!E)return h(o.signal.reason);let R=c;return this.#e[t]===c&&(p===void 0?R.__staleWhileFetching?this.#e[t]=R.__staleWhileFetching:this.#S(e,"fetch"):(r.status&&(r.status.fetchUpdated=!0),this.set(e,p,a.options))),p},u=p=>(r.status&&(r.status.fetchRejected=!0,r.status.fetchError=p),h(p)),h=p=>{let{aborted:E}=o.signal,g=E&&r.allowStaleOnFetchAbort,m=g||r.allowStaleOnFetchRejection,R=m||r.noDeleteOnFetchRejection,w=c;if(this.#e[t]===c&&(!R||w.__staleWhileFetching===void 0?this.#S(e,"fetch"):g||(this.#e[t]=w.__staleWhileFetching)),m)return r.status&&w.__staleWhileFetching!==void 0&&(r.status.returnedStale=!0),w.__staleWhileFetching;if(w.__returned===w)throw p},d=(p,E)=>{let g=this.#F?.(e,n,a);g&&g instanceof Promise&&g.then(m=>p(m===void 0?void 0:m),E),o.signal.addEventListener("abort",()=>{(!r.ignoreFetchAbort||r.allowStaleOnFetchAbort)&&(p(void 0),r.allowStaleOnFetchAbort&&(p=m=>f(m,!0)))})};r.status&&(r.status.fetchDispatched=!0);let c=new Promise(d).then(f,u),b=Object.assign(c,{__abortController:o,__staleWhileFetching:n,__returned:void 0});return t===void 0?(this.set(e,b,{...a.options,status:void 0}),t=this.#r.get(e)):this.#e[t]=b,b}#t(e){if(!this.#x)return!1;let t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof X}async fetch(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,ttl:o=this.ttl,noDisposeOnSet:l=this.noDisposeOnSet,size:a=0,sizeCalculation:f=this.sizeCalculation,noUpdateTTL:u=this.noUpdateTTL,noDeleteOnFetchRejection:h=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:d=this.allowStaleOnFetchRejection,ignoreFetchAbort:c=this.ignoreFetchAbort,allowStaleOnFetchAbort:b=this.allowStaleOnFetchAbort,context:p,forceRefresh:E=!1,status:g,signal:m}=t;if(!this.#x)return g&&(g.fetch="get"),this.get(e,{allowStale:r,updateAgeOnGet:s,noDeleteOnStaleGet:n,status:g});let R={allowStale:r,updateAgeOnGet:s,noDeleteOnStaleGet:n,ttl:o,noDisposeOnSet:l,size:a,sizeCalculation:f,noUpdateTTL:u,noDeleteOnFetchRejection:h,allowStaleOnFetchRejection:d,allowStaleOnFetchAbort:b,ignoreFetchAbort:c,status:g,signal:m},w=this.#r.get(e);if(w===void 0){g&&(g.fetch="miss");let T=this.#I(e,w,R,p);return T.__returned=T}else{let T=this.#e[w];if(this.#t(T)){let Ce=r&&T.__staleWhileFetching!==void 0;return g&&(g.fetch="inflight",Ce&&(g.returnedStale=!0)),Ce?T.__staleWhileFetching:T.__returned=T}let P=this.#p(w);if(!E&&!P)return g&&(g.fetch="hit"),this.#v(w),s&&this.#_(w),g&&this.#T(g,w),T;let v=this.#I(e,w,R,p),H=v.__staleWhileFetching!==void 0&&r;return g&&(g.fetch=P?"stale":"refresh",H&&P&&(g.returnedStale=!0)),H?v.__staleWhileFetching:v.__returned=v}}async forceFetch(e,t={}){let r=await this.fetch(e,t);if(r===void 0)throw new Error("fetch() returned undefined");return r}memo(e,t={}){let r=this.#P;if(!r)throw new Error("no memoMethod provided to constructor");let{context:s,forceRefresh:n,...o}=t,l=this.get(e,o);if(!n&&l!==void 0)return l;let a=r(e,l,{options:o,context:s});return this.set(e,a,o),a}get(e,t={}){let{allowStale:r=this.allowStale,updateAgeOnGet:s=this.updateAgeOnGet,noDeleteOnStaleGet:n=this.noDeleteOnStaleGet,status:o}=t,l=this.#r.get(e);if(l!==void 0){let a=this.#e[l],f=this.#t(a);return o&&this.#T(o,l),this.#p(l)?(o&&(o.get="stale"),f?(o&&r&&a.__staleWhileFetching!==void 0&&(o.returnedStale=!0),r?a.__staleWhileFetching:void 0):(n||this.#S(e,"expire"),o&&r&&(o.returnedStale=!0),r?a:void 0)):(o&&(o.get="hit"),f?a.__staleWhileFetching:(this.#v(l),s&&this.#_(l),a))}else o&&(o.get="miss")}#j(e,t){this.#f[t]=e,this.#h[e]=t}#v(e){e!==this.#n&&(e===this.#a?this.#a=this.#h[e]:this.#j(this.#f[e],this.#h[e]),this.#j(this.#n,e),this.#n=e)}delete(e){return this.#S(e,"delete")}#S(e,t){let r=!1;if(this.#s!==0){let s=this.#r.get(e);if(s!==void 0)if(r=!0,this.#s===1)this.#U(t);else{this.#R(s);let n=this.#e[s];if(this.#t(n)?n.__abortController.abort(new Error("deleted")):(this.#w||this.#c)&&(this.#w&&this.#g?.(n,e,t),this.#c&&this.#o?.push([n,e,t])),this.#r.delete(e),this.#i[s]=void 0,this.#e[s]=void 0,s===this.#n)this.#n=this.#f[s];else if(s===this.#a)this.#a=this.#h[s];else{let o=this.#f[s];this.#h[o]=this.#h[s];let l=this.#h[s];this.#f[l]=this.#f[s]}this.#s--,this.#E.push(s)}}if(this.#c&&this.#o?.length){let s=this.#o,n;for(;n=s?.shift();)this.#b?.(...n)}return r}clear(){return this.#U("delete")}#U(e){for(let t of this.#A({allowStale:!0})){let r=this.#e[t];if(this.#t(r))r.__abortController.abort(new Error("deleted"));else{let s=this.#i[t];this.#w&&this.#g?.(r,s,e),this.#c&&this.#o?.push([r,s,e])}}if(this.#r.clear(),this.#e.fill(void 0),this.#i.fill(void 0),this.#d&&this.#C&&(this.#d.fill(0),this.#C.fill(0)),this.#m&&this.#m.fill(0),this.#a=0,this.#n=0,this.#E.length=0,this.#y=0,this.#s=0,this.#c&&this.#o){let t=this.#o,r;for(;r=t?.shift();)this.#b?.(...r)}}};var me=Oe(le(),1);import{DuckDBInstance as Rt}from"@duckdb/node-api";var ge=Oe(le(),1);import pt from"vm";var ce=class{add(e,t,r){if(typeof arguments[0]!="string")for(let s in arguments[0])this.add(s,arguments[0][s],arguments[1]);else(Array.isArray(e)?e:[e]).forEach(function(s){this[s]=this[s]||[],t&&this[s][r?"unshift":"push"](t)},this)}run(e,t){this[e]=this[e]||[],this[e].forEach(function(r){r.call(t&&t.context?t.context:t,t)})}},ue=class{constructor(e){this.jsep=e,this.registered={}}register(...e){e.forEach(t=>{if(typeof t!="object"||!t.name||!t.init)throw new Error("Invalid JSEP plugin format");this.registered[t.name]||(t.init(this.jsep),this.registered[t.name]=t)})}},S=class i{static get version(){return"1.4.0"}static toString(){return"JavaScript Expression Parser (JSEP) v"+i.version}static addUnaryOp(e){return i.max_unop_len=Math.max(e.length,i.max_unop_len),i.unary_ops[e]=1,i}static addBinaryOp(e,t,r){return i.max_binop_len=Math.max(e.length,i.max_binop_len),i.binary_ops[e]=t,r?i.right_associative.add(e):i.right_associative.delete(e),i}static addIdentifierChar(e){return i.additional_identifier_chars.add(e),i}static addLiteral(e,t){return i.literals[e]=t,i}static removeUnaryOp(e){return delete i.unary_ops[e],e.length===i.max_unop_len&&(i.max_unop_len=i.getMaxKeyLen(i.unary_ops)),i}static removeAllUnaryOps(){return i.unary_ops={},i.max_unop_len=0,i}static removeIdentifierChar(e){return i.additional_identifier_chars.delete(e),i}static removeBinaryOp(e){return delete i.binary_ops[e],e.length===i.max_binop_len&&(i.max_binop_len=i.getMaxKeyLen(i.binary_ops)),i.right_associative.delete(e),i}static removeAllBinaryOps(){return i.binary_ops={},i.max_binop_len=0,i}static removeLiteral(e){return delete i.literals[e],i}static removeAllLiterals(){return i.literals={},i}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(e){this.expr=e,this.index=0}static parse(e){return new i(e).parse()}static getMaxKeyLen(e){return Math.max(0,...Object.keys(e).map(t=>t.length))}static isDecimalDigit(e){return e>=48&&e<=57}static binaryPrecedence(e){return i.binary_ops[e]||0}static isIdentifierStart(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!i.binary_ops[String.fromCharCode(e)]||i.additional_identifier_chars.has(String.fromCharCode(e))}static isIdentifierPart(e){return i.isIdentifierStart(e)||i.isDecimalDigit(e)}throwError(e){let t=new Error(e+" at character "+this.index);throw t.index=this.index,t.description=e,t}runHook(e,t){if(i.hooks[e]){let r={context:this,node:t};return i.hooks.run(e,r),r.node}return t}searchHook(e){if(i.hooks[e]){let t={context:this};return i.hooks[e].find(function(r){return r.call(t.context,t),t.node}),t.node}}gobbleSpaces(){let e=this.code;for(;e===i.SPACE_CODE||e===i.TAB_CODE||e===i.LF_CODE||e===i.CR_CODE;)e=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");let e=this.gobbleExpressions(),t=e.length===1?e[0]:{type:i.COMPOUND,body:e};return this.runHook("after-all",t)}gobbleExpressions(e){let t=[],r,s;for(;this.index<this.expr.length;)if(r=this.code,r===i.SEMCOL_CODE||r===i.COMMA_CODE)this.index++;else if(s=this.gobbleExpression())t.push(s);else if(this.index<this.expr.length){if(r===e)break;this.throwError('Unexpected "'+this.char+'"')}return t}gobbleExpression(){let e=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",e)}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,i.max_binop_len),t=e.length;for(;t>0;){if(i.binary_ops.hasOwnProperty(e)&&(!i.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!i.isIdentifierPart(this.expr.charCodeAt(this.index+e.length))))return this.index+=t,e;e=e.substr(0,--t)}return!1}gobbleBinaryExpression(){let e,t,r,s,n,o,l,a,f;if(o=this.gobbleToken(),!o||(t=this.gobbleBinaryOp(),!t))return o;for(n={value:t,prec:i.binaryPrecedence(t),right_a:i.right_associative.has(t)},l=this.gobbleToken(),l||this.throwError("Expected expression after "+t),s=[o,n,l];t=this.gobbleBinaryOp();){if(r=i.binaryPrecedence(t),r===0){this.index-=t.length;break}n={value:t,prec:r,right_a:i.right_associative.has(t)},f=t;let u=h=>n.right_a&&h.right_a?r>h.prec:r<=h.prec;for(;s.length>2&&u(s[s.length-2]);)l=s.pop(),t=s.pop().value,o=s.pop(),e={type:i.BINARY_EXP,operator:t,left:o,right:l},s.push(e);e=this.gobbleToken(),e||this.throwError("Expected expression after "+f),s.push(n,e)}for(a=s.length-1,e=s[a];a>1;)e={type:i.BINARY_EXP,operator:s[a-1].value,left:s[a-2],right:e},a-=2;return e}gobbleToken(){let e,t,r,s;if(this.gobbleSpaces(),s=this.searchHook("gobble-token"),s)return this.runHook("after-token",s);if(e=this.code,i.isDecimalDigit(e)||e===i.PERIOD_CODE)return this.gobbleNumericLiteral();if(e===i.SQUOTE_CODE||e===i.DQUOTE_CODE)s=this.gobbleStringLiteral();else if(e===i.OBRACK_CODE)s=this.gobbleArray();else{for(t=this.expr.substr(this.index,i.max_unop_len),r=t.length;r>0;){if(i.unary_ops.hasOwnProperty(t)&&(!i.isIdentifierStart(this.code)||this.index+t.length<this.expr.length&&!i.isIdentifierPart(this.expr.charCodeAt(this.index+t.length)))){this.index+=r;let n=this.gobbleToken();return n||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:i.UNARY_EXP,operator:t,argument:n,prefix:!0})}t=t.substr(0,--r)}i.isIdentifierStart(e)?(s=this.gobbleIdentifier(),i.literals.hasOwnProperty(s.name)?s={type:i.LITERAL,value:i.literals[s.name],raw:s.name}:s.name===i.this_str&&(s={type:i.THIS_EXP})):e===i.OPAREN_CODE&&(s=this.gobbleGroup())}return s?(s=this.gobbleTokenProperty(s),this.runHook("after-token",s)):this.runHook("after-token",!1)}gobbleTokenProperty(e){this.gobbleSpaces();let t=this.code;for(;t===i.PERIOD_CODE||t===i.OBRACK_CODE||t===i.OPAREN_CODE||t===i.QUMARK_CODE;){let r;if(t===i.QUMARK_CODE){if(this.expr.charCodeAt(this.index+1)!==i.PERIOD_CODE)break;r=!0,this.index+=2,this.gobbleSpaces(),t=this.code}this.index++,t===i.OBRACK_CODE?(e={type:i.MEMBER_EXP,computed:!0,object:e,property:this.gobbleExpression()},e.property||this.throwError('Unexpected "'+this.char+'"'),this.gobbleSpaces(),t=this.code,t!==i.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):t===i.OPAREN_CODE?e={type:i.CALL_EXP,arguments:this.gobbleArguments(i.CPAREN_CODE),callee:e}:(t===i.PERIOD_CODE||r)&&(r&&this.index--,this.gobbleSpaces(),e={type:i.MEMBER_EXP,computed:!1,object:e,property:this.gobbleIdentifier()}),r&&(e.optional=!0),this.gobbleSpaces(),t=this.code}return e}gobbleNumericLiteral(){let e="",t,r;for(;i.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(this.code===i.PERIOD_CODE)for(e+=this.expr.charAt(this.index++);i.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(t=this.char,t==="e"||t==="E"){for(e+=this.expr.charAt(this.index++),t=this.char,(t==="+"||t==="-")&&(e+=this.expr.charAt(this.index++));i.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);i.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+e+this.char+")")}return r=this.code,i.isIdentifierStart(r)?this.throwError("Variable names cannot start with a number ("+e+this.char+")"):(r===i.PERIOD_CODE||e.length===1&&e.charCodeAt(0)===i.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:i.LITERAL,value:parseFloat(e),raw:e}}gobbleStringLiteral(){let e="",t=this.index,r=this.expr.charAt(this.index++),s=!1;for(;this.index<this.expr.length;){let n=this.expr.charAt(this.index++);if(n===r){s=!0;break}else if(n==="\\")switch(n=this.expr.charAt(this.index++),n){case"n":e+=`
`;break;case"r":e+="\r";break;case"t":e+="	";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=n}else e+=n}return s||this.throwError('Unclosed quote after "'+e+'"'),{type:i.LITERAL,value:e,raw:this.expr.substring(t,this.index)}}gobbleIdentifier(){let e=this.code,t=this.index;for(i.isIdentifierStart(e)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(e=this.code,i.isIdentifierPart(e));)this.index++;return{type:i.IDENTIFIER,name:this.expr.slice(t,this.index)}}gobbleArguments(e){let t=[],r=!1,s=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let n=this.code;if(n===e){r=!0,this.index++,e===i.CPAREN_CODE&&s&&s>=t.length&&this.throwError("Unexpected token "+String.fromCharCode(e));break}else if(n===i.COMMA_CODE){if(this.index++,s++,s!==t.length){if(e===i.CPAREN_CODE)this.throwError("Unexpected token ,");else if(e===i.CBRACK_CODE)for(let o=t.length;o<s;o++)t.push(null)}}else if(t.length!==s&&s!==0)this.throwError("Expected comma");else{let o=this.gobbleExpression();(!o||o.type===i.COMPOUND)&&this.throwError("Expected comma"),t.push(o)}}return r||this.throwError("Expected "+String.fromCharCode(e)),t}gobbleGroup(){this.index++;let e=this.gobbleExpressions(i.CPAREN_CODE);if(this.code===i.CPAREN_CODE)return this.index++,e.length===1?e[0]:e.length?{type:i.SEQUENCE_EXP,expressions:e}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:i.ARRAY_EXP,elements:this.gobbleArguments(i.CBRACK_CODE)}}},gt=new ce;Object.assign(S,{hooks:gt,plugins:new ue(S),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"??":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10,"**":11},right_associative:new Set(["**"]),additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});S.max_unop_len=S.getMaxKeyLen(S.unary_ops);S.max_binop_len=S.getMaxKeyLen(S.binary_ops);var L=i=>new S(i).parse(),bt=Object.getOwnPropertyNames(class{});Object.getOwnPropertyNames(S).filter(i=>!bt.includes(i)&&L[i]===void 0).forEach(i=>{L[i]=S[i]});L.Jsep=S;var yt="ConditionalExpression",Et={name:"ternary",init(i){i.hooks.add("after-expression",function(t){if(t.node&&this.code===i.QUMARK_CODE){this.index++;let r=t.node,s=this.gobbleExpression();if(s||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===i.COLON_CODE){this.index++;let n=this.gobbleExpression();if(n||this.throwError("Expected expression"),t.node={type:yt,test:r,consequent:s,alternate:n},r.operator&&i.binary_ops[r.operator]<=.9){let o=r;for(;o.right.operator&&i.binary_ops[o.right.operator]<=.9;)o=o.right;t.node.test=o.right,o.right=t.node,t.node=r}}else this.throwError("Expected :")}})}};L.plugins.register(Et);var ke=47,mt=92,Ct={name:"regex",init(i){i.hooks.add("gobble-token",function(t){if(this.code===ke){let r=++this.index,s=!1;for(;this.index<this.expr.length;){if(this.code===ke&&!s){let n=this.expr.slice(r,this.index),o="";for(;++this.index<this.expr.length;){let a=this.code;if(a>=97&&a<=122||a>=65&&a<=90||a>=48&&a<=57)o+=this.char;else break}let l;try{l=new RegExp(n,o)}catch(a){this.throwError(a.message)}return t.node={type:i.LITERAL,value:l,raw:this.expr.slice(r-1,this.index)},t.node=this.gobbleTokenProperty(t.node),t.node}this.code===i.OBRACK_CODE?s=!0:s&&this.code===i.CBRACK_CODE&&(s=!1),this.index+=this.code===mt?2:1}this.throwError("Unclosed Regex")}})}},he=43,wt=45,W={name:"assignment",assignmentOperators:new Set(["=","*=","**=","/=","%=","+=","-=","<<=",">>=",">>>=","&=","^=","|=","||=","&&=","??="]),updateOperators:[he,wt],assignmentPrecedence:.9,init(i){let e=[i.IDENTIFIER,i.MEMBER_EXP];W.assignmentOperators.forEach(r=>i.addBinaryOp(r,W.assignmentPrecedence,!0)),i.hooks.add("gobble-token",function(s){let n=this.code;W.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(this.index+=2,s.node={type:"UpdateExpression",operator:n===he?"++":"--",argument:this.gobbleTokenProperty(this.gobbleIdentifier()),prefix:!0},(!s.node.argument||!e.includes(s.node.argument.type))&&this.throwError(`Unexpected ${s.node.operator}`))}),i.hooks.add("after-token",function(s){if(s.node){let n=this.code;W.updateOperators.some(o=>o===n&&o===this.expr.charCodeAt(this.index+1))&&(e.includes(s.node.type)||this.throwError(`Unexpected ${s.node.operator}`),this.index+=2,s.node={type:"UpdateExpression",operator:n===he?"++":"--",argument:s.node,prefix:!1})}}),i.hooks.add("after-expression",function(s){s.node&&t(s.node)});function t(r){W.assignmentOperators.has(r.operator)?(r.type="AssignmentExpression",t(r.left),t(r.right)):r.operator||Object.values(r).forEach(s=>{s&&typeof s=="object"&&t(s)})}}};L.plugins.register(Ct,W);L.addUnaryOp("typeof");L.addLiteral("null",null);L.addLiteral("undefined",void 0);var Ot=new Set(["constructor","__proto__","__defineGetter__","__defineSetter__"]),C={evalAst(i,e){switch(i.type){case"BinaryExpression":case"LogicalExpression":return C.evalBinaryExpression(i,e);case"Compound":return C.evalCompound(i,e);case"ConditionalExpression":return C.evalConditionalExpression(i,e);case"Identifier":return C.evalIdentifier(i,e);case"Literal":return C.evalLiteral(i,e);case"MemberExpression":return C.evalMemberExpression(i,e);case"UnaryExpression":return C.evalUnaryExpression(i,e);case"ArrayExpression":return C.evalArrayExpression(i,e);case"CallExpression":return C.evalCallExpression(i,e);case"AssignmentExpression":return C.evalAssignmentExpression(i,e);default:throw SyntaxError("Unexpected expression",i)}},evalBinaryExpression(i,e){return{"||":(r,s)=>r||s(),"&&":(r,s)=>r&&s(),"|":(r,s)=>r|s(),"^":(r,s)=>r^s(),"&":(r,s)=>r&s(),"==":(r,s)=>r==s(),"!=":(r,s)=>r!=s(),"===":(r,s)=>r===s(),"!==":(r,s)=>r!==s(),"<":(r,s)=>r<s(),">":(r,s)=>r>s(),"<=":(r,s)=>r<=s(),">=":(r,s)=>r>=s(),"<<":(r,s)=>r<<s(),">>":(r,s)=>r>>s(),">>>":(r,s)=>r>>>s(),"+":(r,s)=>r+s(),"-":(r,s)=>r-s(),"*":(r,s)=>r*s(),"/":(r,s)=>r/s(),"%":(r,s)=>r%s()}[i.operator](C.evalAst(i.left,e),()=>C.evalAst(i.right,e))},evalCompound(i,e){let t;for(let r=0;r<i.body.length;r++){i.body[r].type==="Identifier"&&["var","let","const"].includes(i.body[r].name)&&i.body[r+1]&&i.body[r+1].type==="AssignmentExpression"&&(r+=1);let s=i.body[r];t=C.evalAst(s,e)}return t},evalConditionalExpression(i,e){return C.evalAst(i.test,e)?C.evalAst(i.consequent,e):C.evalAst(i.alternate,e)},evalIdentifier(i,e){if(Object.hasOwn(e,i.name))return e[i.name];throw ReferenceError(`${i.name} is not defined`)},evalLiteral(i){return i.value},evalMemberExpression(i,e){let t=i.computed?C.evalAst(i.property):i.property.name,r=C.evalAst(i.object,e);if(r==null)throw TypeError(`Cannot read properties of ${r} (reading '${t}')`);if(!Object.hasOwn(r,t)&&Ot.has(t))throw TypeError(`Cannot read properties of ${r} (reading '${t}')`);let s=r[t];return typeof s=="function"?s.bind(r):s},evalUnaryExpression(i,e){return{"-":r=>-C.evalAst(r,e),"!":r=>!C.evalAst(r,e),"~":r=>~C.evalAst(r,e),"+":r=>+C.evalAst(r,e),typeof:r=>typeof C.evalAst(r,e)}[i.operator](i.argument)},evalArrayExpression(i,e){return i.elements.map(t=>C.evalAst(t,e))},evalCallExpression(i,e){let t=i.arguments.map(s=>C.evalAst(s,e));return C.evalAst(i.callee,e)(...t)},evalAssignmentExpression(i,e){if(i.left.type!=="Identifier")throw SyntaxError("Invalid left-hand side in assignment");let t=i.left.name,r=C.evalAst(i.right,e);return e[t]=r,e[t]}},fe=class{constructor(e){this.code=e,this.ast=L(this.code)}runInNewContext(e){let t=Object.assign(Object.create(null),e);return C.evalAst(this.ast,t)}};function N(i,e){return i=i.slice(),i.push(e),i}function de(i,e){return e=e.slice(),e.unshift(i),e}var pe=class extends Error{constructor(e){super('JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),this.avoidNew=!0,this.value=e,this.name="NewError"}};function y(i,e,t,r,s){if(!(this instanceof y))try{return new y(i,e,t,r,s)}catch(o){if(!o.avoidNew)throw o;return o.value}typeof i=="string"&&(s=r,r=t,t=e,e=i,i=null);let n=i&&typeof i=="object";if(i=i||{},this.json=i.json||t,this.path=i.path||e,this.resultType=i.resultType||"value",this.flatten=i.flatten||!1,this.wrap=Object.hasOwn(i,"wrap")?i.wrap:!0,this.sandbox=i.sandbox||{},this.eval=i.eval===void 0?"safe":i.eval,this.ignoreEvalErrors=typeof i.ignoreEvalErrors>"u"?!1:i.ignoreEvalErrors,this.parent=i.parent||null,this.parentProperty=i.parentProperty||null,this.callback=i.callback||r||null,this.otherTypeCallback=i.otherTypeCallback||s||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},i.autostart!==!1){let o={path:n?i.path:e};n?"json"in i&&(o.json=i.json):o.json=t;let l=this.evaluate(o);if(!l||typeof l!="object")throw new pe(l);return l}}y.prototype.evaluate=function(i,e,t,r){let s=this.parent,n=this.parentProperty,{flatten:o,wrap:l}=this;if(this.currResultType=this.resultType,this.currEval=this.eval,this.currSandbox=this.sandbox,t=t||this.callback,this.currOtherTypeCallback=r||this.otherTypeCallback,e=e||this.json,i=i||this.path,i&&typeof i=="object"&&!Array.isArray(i)){if(!i.path&&i.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!Object.hasOwn(i,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');({json:e}=i),o=Object.hasOwn(i,"flatten")?i.flatten:o,this.currResultType=Object.hasOwn(i,"resultType")?i.resultType:this.currResultType,this.currSandbox=Object.hasOwn(i,"sandbox")?i.sandbox:this.currSandbox,l=Object.hasOwn(i,"wrap")?i.wrap:l,this.currEval=Object.hasOwn(i,"eval")?i.eval:this.currEval,t=Object.hasOwn(i,"callback")?i.callback:t,this.currOtherTypeCallback=Object.hasOwn(i,"otherTypeCallback")?i.otherTypeCallback:this.currOtherTypeCallback,s=Object.hasOwn(i,"parent")?i.parent:s,n=Object.hasOwn(i,"parentProperty")?i.parentProperty:n,i=i.path}if(s=s||null,n=n||null,Array.isArray(i)&&(i=y.toPathString(i)),!i&&i!==""||!e)return;let a=y.toPathArray(i);a[0]==="$"&&a.length>1&&a.shift(),this._hasParentSelector=null;let f=this._trace(a,e,["$"],s,n,t).filter(function(u){return u&&!u.isParentSelector});return f.length?!l&&f.length===1&&!f[0].hasArrExpr?this._getPreferredOutput(f[0]):f.reduce((u,h)=>{let d=this._getPreferredOutput(h);return o&&Array.isArray(d)?u=u.concat(d):u.push(d),u},[]):l?[]:void 0};y.prototype._getPreferredOutput=function(i){let e=this.currResultType;switch(e){case"all":{let t=Array.isArray(i.path)?i.path:y.toPathArray(i.path);return i.pointer=y.toPointer(t),i.path=typeof i.path=="string"?i.path:y.toPathString(i.path),i}case"value":case"parent":case"parentProperty":return i[e];case"path":return y.toPathString(i[e]);case"pointer":return y.toPointer(i.path);default:throw new TypeError("Unknown result type")}};y.prototype._handleCallback=function(i,e,t){if(e){let r=this._getPreferredOutput(i);i.path=typeof i.path=="string"?i.path:y.toPathString(i.path),e(r,t,i)}};y.prototype._trace=function(i,e,t,r,s,n,o,l){let a;if(!i.length)return a={path:t,value:e,parent:r,parentProperty:s,hasArrExpr:o},this._handleCallback(a,n,"value"),a;let f=i[0],u=i.slice(1),h=[];function d(c){Array.isArray(c)?c.forEach(b=>{h.push(b)}):h.push(c)}if((typeof f!="string"||l)&&e&&Object.hasOwn(e,f))d(this._trace(u,e[f],N(t,f),e,f,n,o));else if(f==="*")this._walk(e,c=>{d(this._trace(u,e[c],N(t,c),e,c,n,!0,!0))});else if(f==="..")d(this._trace(u,e,t,r,s,n,o)),this._walk(e,c=>{typeof e[c]=="object"&&d(this._trace(i.slice(),e[c],N(t,c),e,c,n,!0))});else{if(f==="^")return this._hasParentSelector=!0,{path:t.slice(0,-1),expr:u,isParentSelector:!0};if(f==="~")return a={path:N(t,f),value:s,parent:r,parentProperty:null},this._handleCallback(a,n,"property"),a;if(f==="$")d(this._trace(u,e,t,null,null,n,o));else if(/^(-?\d*):(-?\d*):?(\d*)$/u.test(f))d(this._slice(f,u,e,t,r,s,n));else if(f.indexOf("?(")===0){if(this.currEval===!1)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");let c=f.replace(/^\?\((.*?)\)$/u,"$1"),b=/@.?([^?]*)[['](\??\(.*?\))(?!.\)\])[\]']/gu.exec(c);b?this._walk(e,p=>{let E=[b[2]],g=b[1]?e[p][b[1]]:e[p];this._trace(E,g,t,r,s,n,!0).length>0&&d(this._trace(u,e[p],N(t,p),e,p,n,!0))}):this._walk(e,p=>{this._eval(c,e[p],p,t,r,s)&&d(this._trace(u,e[p],N(t,p),e,p,n,!0))})}else if(f[0]==="("){if(this.currEval===!1)throw new Error("Eval [(expr)] prevented in JSONPath expression.");d(this._trace(de(this._eval(f,e,t.at(-1),t.slice(0,-1),r,s),u),e,t,r,s,n,o))}else if(f[0]==="@"){let c=!1,b=f.slice(1,-2);switch(b){case"scalar":(!e||!["object","function"].includes(typeof e))&&(c=!0);break;case"boolean":case"string":case"undefined":case"function":typeof e===b&&(c=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(c=!0);break;case"number":Number.isFinite(e)&&(c=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(c=!0);break;case"object":e&&typeof e===b&&(c=!0);break;case"array":Array.isArray(e)&&(c=!0);break;case"other":c=this.currOtherTypeCallback(e,t,r,s);break;case"null":e===null&&(c=!0);break;default:throw new TypeError("Unknown value type "+b)}if(c)return a={path:t,value:e,parent:r,parentProperty:s},this._handleCallback(a,n,"value"),a}else if(f[0]==="`"&&e&&Object.hasOwn(e,f.slice(1))){let c=f.slice(1);d(this._trace(u,e[c],N(t,c),e,c,n,o,!0))}else if(f.includes(",")){let c=f.split(",");for(let b of c)d(this._trace(de(b,u),e,t,r,s,n,!0))}else!l&&e&&Object.hasOwn(e,f)&&d(this._trace(u,e[f],N(t,f),e,f,n,o,!0))}if(this._hasParentSelector)for(let c=0;c<h.length;c++){let b=h[c];if(b&&b.isParentSelector){let p=this._trace(b.expr,e,b.path,r,s,n,o);if(Array.isArray(p)){h[c]=p[0];let E=p.length;for(let g=1;g<E;g++)c++,h.splice(c,0,p[g])}else h[c]=p}}return h};y.prototype._walk=function(i,e){if(Array.isArray(i)){let t=i.length;for(let r=0;r<t;r++)e(r)}else i&&typeof i=="object"&&Object.keys(i).forEach(t=>{e(t)})};y.prototype._slice=function(i,e,t,r,s,n,o){if(!Array.isArray(t))return;let l=t.length,a=i.split(":"),f=a[2]&&Number.parseInt(a[2])||1,u=a[0]&&Number.parseInt(a[0])||0,h=a[1]&&Number.parseInt(a[1])||l;u=u<0?Math.max(0,u+l):Math.min(l,u),h=h<0?Math.max(0,h+l):Math.min(l,h);let d=[];for(let c=u;c<h;c+=f)this._trace(de(c,e),t,r,s,n,o,!0).forEach(p=>{d.push(p)});return d};y.prototype._eval=function(i,e,t,r,s,n){this.currSandbox._$_parentProperty=n,this.currSandbox._$_parent=s,this.currSandbox._$_property=t,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;let o=i.includes("@path");o&&(this.currSandbox._$_path=y.toPathString(r.concat([t])));let l=this.currEval+"Script:"+i;if(!y.cache[l]){let a=i.replaceAll("@parentProperty","_$_parentProperty").replaceAll("@parent","_$_parent").replaceAll("@property","_$_property").replaceAll("@root","_$_root").replaceAll(/@([.\s)[])/gu,"_$_v$1");if(o&&(a=a.replaceAll("@path","_$_path")),this.currEval==="safe"||this.currEval===!0||this.currEval===void 0)y.cache[l]=new this.safeVm.Script(a);else if(this.currEval==="native")y.cache[l]=new this.vm.Script(a);else if(typeof this.currEval=="function"&&this.currEval.prototype&&Object.hasOwn(this.currEval.prototype,"runInNewContext")){let f=this.currEval;y.cache[l]=new f(a)}else if(typeof this.currEval=="function")y.cache[l]={runInNewContext:f=>this.currEval(a,f)};else throw new TypeError(`Unknown "eval" property "${this.currEval}"`)}try{return y.cache[l].runInNewContext(this.currSandbox)}catch(a){if(this.ignoreEvalErrors)return!1;throw new Error("jsonPath: "+a.message+": "+i)}};y.cache={};y.toPathString=function(i){let e=i,t=e.length,r="$";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(r+=/^[0-9*]+$/u.test(e[s])?"["+e[s]+"]":"['"+e[s]+"']");return r};y.toPointer=function(i){let e=i,t=e.length,r="";for(let s=1;s<t;s++)/^(~|\^|@.*?\(\))$/u.test(e[s])||(r+="/"+e[s].toString().replaceAll("~","~0").replaceAll("/","~1"));return r};y.toPathArray=function(i){let{cache:e}=y;if(e[i])return e[i].concat();let t=[],s=i.replaceAll(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/gu,";$&;").replaceAll(/[['](\??\(.*?\))[\]'](?!.\])/gu,function(n,o){return"[#"+(t.push(o)-1)+"]"}).replaceAll(/\[['"]([^'\]]*)['"]\]/gu,function(n,o){return"['"+o.replaceAll(".","%@%").replaceAll("~","%%@@%%")+"']"}).replaceAll("~",";~;").replaceAll(/['"]?\.['"]?(?![^[]*\])|\[['"]?/gu,";").replaceAll("%@%",".").replaceAll("%%@@%%","~").replaceAll(/(?:;)?(\^+)(?:;)?/gu,function(n,o){return";"+o.split("").join(";")+";"}).replaceAll(/;;;|;;/gu,";..;").replaceAll(/;$|'?\]|'$/gu,"").split(";").map(function(n){let o=n.match(/#(\d+)/u);return!o||!o[1]?n:t[o[1]]});return e[i]=s,e[i].concat()};y.prototype.safeVm={Script:fe};y.prototype.vm=pt;var $=(0,ge.default)("glue-table-cache:sql"),Q=(0,ge.default)("glue-table-cache:sql:ast"),U=class{constructor(e){this.db=e}async getQueryAST(e){let t=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;$("Serializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to serialize SQL query");let n=JSON.parse(s[0][0]);if(n.error)throw new Error(JSON.stringify(n));return n}async getSqlFromAst(e){let t=`SELECT json_deserialize_sql('${JSON.stringify(e).replace(/'/g,"''")}')`;$("Deserializing SQL: %s",t);let s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to deserialize SQL query");return s[0][0]+";"}async transformGlueTableQuery(e){$("Transforming query: %s",e);let t=await this.getQueryAST(e);Q("Original AST: %O",t),this.transformNode(t),Q("Transformed AST: %O",t);let r=await this.getSqlFromAst(t);return $("Transformed query: %s",r),r}async getQueryGlueTableRefs(e){let t=await this.getQueryAST(e);return Q("Original AST: %O",t),this.getAstGlueTableRefs(t)}getAstGlueTableRefs(e){return this.getAstTableRefs(e).map(t=>t.tableRef).filter(Boolean)}getAstTableRefs(e){return y({path:"$..*[?(@.type=='BASE_TABLE' && (@.catalog_name=='glue' || @.catalog_name=='GLUE'))]",json:e}).map(n=>({node:n,tableRef:this.getGlueTableRef(n)}))}transformNode(e){$("Finding Glue table references in AST"),Q("AST structure:",e);let t=this.getAstTableRefs(e);$("Found %d Glue table references",t.length),Q("Table references:",t),y({json:e,path:"$..query_location",callback:()=>{}});for(let r of t){let s=r.tableRef;s&&($("Transforming table reference %s.%s",s.database,s.table),Object.assign(r.node,{type:"TABLE_FUNCTION",function:{class:"FUNCTION",type:"FUNCTION",function_name:"parquet_scan",schema:"",catalog:"",children:[{class:"FUNCTION",type:"FUNCTION",function_name:"getvariable",schema:"",catalog:"",children:[{class:"CONSTANT",type:"VALUE_CONSTANT",value:{type:{id:"VARCHAR",type_info:null},is_null:!1,value:`${s.database}_${s.table}_files`}}]}],filter:null,order_bys:{type:"ORDER_MODIFIER",orders:[]},distinct:!1,is_operator:!1,export_state:!1}}))}}getGlueTableRef(e){return e.type==="BASE_TABLE"&&(e.catalog_name==="glue"||e.catalog_name==="GLUE")?{database:e.schema_name||"default",table:e.table_name}:null}async extractPartitionFilters(e,t,r){let s=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`;$("Serializing SQL: %s",s);let o=(await this.db.runAndReadAll(s)).getRows();if(!o.length||o[0].length===0||o[0][0]===null)throw new Error("Failed to serialize SQL query");let l=JSON.parse(o[0][0]);if(l.error)throw new Error(JSON.stringify(l));Q("Original AST: %O",l);let a=new Set;return l?.statements?.[0]?.node?.where_clause&&this.extractFiltersFromCondition(l.statements[0].node.where_clause,r,a),Array.from(a)}findPartitionFilters(e,t,r,s){if(!(!e||typeof e!="object")){e.type==="SELECT"&&e.where&&this.extractFiltersFromCondition(e.where,r,s);for(let n in e)Array.isArray(e[n])?e[n].forEach(o=>this.findPartitionFilters(o,t,r,s)):typeof e[n]=="object"&&this.findPartitionFilters(e[n],t,r,s)}}extractFiltersFromCondition(e,t,r){if(!(!e||typeof e!="object")){if(e.class==="COMPARISON"){let s=e.left,n=e.right;if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])&&n?.class==="CONSTANT"&&n?.type==="VALUE_CONSTANT"){let o=n.value?.value;if(o!==void 0){let l=this.getComparisonOperator(e.type),a=typeof o=="string"?`'${o}'`:o;r.add(`${s.column_names[0]} ${l} ${a}`)}}}else if(e.class==="CONJUNCTION")e.children?.forEach(s=>this.extractFiltersFromCondition(s,t,r));else if(e.class==="OPERATOR"&&e.type==="COMPARE_IN"){let s=e.children?.[0];if(s?.class==="COLUMN_REF"&&t.includes(s.column_names?.[0])){let n=e.children.slice(1).filter(o=>o.class==="CONSTANT"&&o.type==="VALUE_CONSTANT").map(o=>`'${o.value.value}'`);n.length>0&&r.add(`${s.column_names[0]} IN (${n.join(", ")})`)}}}}getComparisonOperator(e){switch(e){case"COMPARE_EQUAL":return"=";case"COMPARE_GREATERTHAN":return">";case"COMPARE_LESSTHAN":return"<";case"COMPARE_GREATERTHANOREQUALTO":return">=";case"COMPARE_LESSTHANOREQUALTO":return"<=";case"COMPARE_NOTEQUAL":return"!=";default:throw new Error(`Unsupported comparison type: ${e}`)}}getQueryFilesVarName(e,t){return`${e}_${t}_files`}getGlueTableFilesVarName(e,t){return`${e}_${t}_gview_files`}async getGlueTableViewSql(e){let t=`SELECT json_serialize_sql('${e.replace(/'/g,"''")}')`,s=(await this.db.runAndReadAll(t)).getRows();if(!s.length||s[0].length===0||s[0][0]===null)throw new Error("Failed to serialize SQL query");let n=JSON.parse(s[0][0]);if(n.error)throw new Error(JSON.stringify(n));let o=this.getAstGlueTableRefs(n);if(!o.length)throw new Error("No Glue table references found in query");let l=[],a=new Set;for(let f of o){let u=this.getGlueTableFilesVarName(f.database,f.table),h=`${f.database}_${f.table}`;if(!a.has(h)){a.add(h);let d=`${h}_gview`,c=`SELECT * FROM parquet_scan(getvariable('${u}'))`;l.push(`CREATE OR REPLACE VIEW ${d} AS ${c};`)}}return l}};var F=(0,me.default)("glue-table-cache"),be=(0,me.default)("glue-table-cache:aws"),ye={region:"eu-west-1",maxEntries:100,forceRefreshOnError:!0,glueTableMetadataTtlMs:36e5,s3ListingRefreshMs:36e5},Ee=class{tableCache;s3ListingCache;glueClient;s3Client;db;sqlTransformer;config;constructor(e=ye){F("Initializing GlueTableCache for region %s with config %O",e),this.config={...ye,...e,region:e?.region||process.env.AWS_REGION||ye.region},this.glueClient=new Tt({region:e.region}),this.s3Client=new xt({region:e.region}),this.tableCache=new K({max:this.config.maxEntries,ttl:this.config.glueTableMetadataTtlMs}),this.s3ListingCache=new K({max:this.config.maxEntries,ttl:this.config.s3ListingRefreshMs})}async runAndReadAll(e){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");return this.db.runAndReadAll(e)}async connect(){return this.db||(this.db=await(await Rt.create(":memory:")).connect()),this.sqlTransformer||(this.sqlTransformer=new U(this.db)),this.db}close(){this.db?.close(),this.db=void 0}async getTableMetadata(e,t){let r=`${e}.${t}`;F("Getting table metadata for %s",r);let s=this.tableCache.get(r);if(!s){F("Cache miss for %s, refreshing...",r);let n=await this.refreshTableMetadata(e,t),l={timestamp:Date.now(),data:n};return this.tableCache.set(r,l),n}return F("Cache hit for %s",r),s.data}async refreshTableMetadata(e,t){try{be("Fetching table metadata from AWS for %s.%s",e,t);let r={DatabaseName:e,Name:t},n=(await this.glueClient.send(new St(r))).Table;if(!n)throw new Error(`Table ${e}.${t} not found`);let o={timestamp:Date.now(),table:n};return n.Parameters?.["projection.enabled"]==="true"?o.projectionPatterns=this.parseProjectionPatterns(n.Parameters):n.PartitionKeys&&n.PartitionKeys.length>0&&(o.partitionMetadata=await this.loadPartitionMetadata(e,t)),o}catch(r){throw this.config.forceRefreshOnError&&this.tableCache.delete(`${e}.${t}`),r}}parseProjectionValue(e,t){switch(e){case"type":return t;case"format":return t;case"range":try{return JSON.parse(t)}catch{return t.split(",").map(r=>r.trim())}case"values":return JSON.parse(t);default:return t}}parseProjectionPatterns(e){let t={};return Object.entries(e).filter(([r])=>r.startsWith("projection.")).forEach(([r,s])=>{let n=r.match(/projection\.(\w+)\.(type|range|format|values)/);if(n){let[o,l,a]=n;t[l]||(t[l]={type:"enum"}),(a==="type"||a==="format"||a==="range"||a==="values")&&(t[l][a]=this.parseProjectionValue(a,s))}}),{enabled:!0,patterns:t}}async loadPartitionMetadata(e,t){let r=new At({DatabaseName:e,TableName:t});try{let s=await this.glueClient.send(r);return!s.Partitions||s.Partitions.length===0?{keys:[],values:[]}:{keys:s.Partitions[0].Values||[],values:s.Partitions.map(n=>({values:n.Values||[],location:n.StorageDescriptor?.Location}))||[]}}catch(s){return console.warn(`Failed to load partitions for ${e}.${t}:`,s),{keys:[],values:[]}}}clearCache(){this.tableCache.clear(),this.s3ListingCache.clear()}invalidateTable(e,t){let r=`${e}.${t}`;this.tableCache.delete(r);for(let s of this.s3ListingCache.keys())s.includes(r)&&this.s3ListingCache.delete(s)}parseS3Path(e){let t=new URL(e);return{bucket:t.hostname,prefix:t.pathname.substring(1)}}extractPartitionValues(e,t){let r={};for(let s of t){let n=e.match(new RegExp(`${s}=([^/]+)`));n&&(r[s]=n[1])}return r}async listS3Files(e,t){let r=`${e}:${t.join(",")}`,s=this.s3ListingCache.get(r);if(s)return be("Using cached S3 listing for %s",e),s.data;be("Listing S3 files for %s",e);let{bucket:n,prefix:o}=this.parseS3Path(e),l=[],a=o.endsWith("/")?o:`${o}/`,f;do{let h=new _t({Bucket:n,Prefix:a,ContinuationToken:f,MaxKeys:1e3}),d=await this.s3Client.send(h);if(d.Contents){for(let c of d.Contents)if(c.Key&&!c.Key.includes("_$folder$")){let b=`s3://${n}/${c.Key}`,p=this.extractPartitionValues(b,t);l.push({path:b,partitionValues:p})}}f=d.NextContinuationToken}while(f);let u=Date.now();return this.s3ListingCache.set(r,{timestamp:u,data:l}),l}async getPartitionExtractor(e,t){if(t.projectionPatterns?.enabled){let r=t.projectionPatterns.patterns[e];if(!r)throw new Error(`No projection pattern found for partition key ${e}`);switch(r.type){case"date":let s=r.format||"yyyy-MM-dd";return`regexp_extract(path, '(${this.convertDateFormatToRegex(s)})', 1)`;case"integer":return"CAST(regexp_extract(path, '/([0-9]+)/', 1) AS INTEGER)";case"enum":return"regexp_extract(path, '/([^/]+)/[^/]*$', 1)";case"injected":throw this.sqlTransformer||await this.connect(),this.sqlTransformer?new Error("Injected partition values not supported yet"):new Error("SQL transformer not initialized");default:throw new Error(`Unsupported projection type: ${r.type}`)}}return`regexp_extract(path, '${e}=([^/]+)', 1)`}convertDateFormatToRegex(e){let t={yyyy:"\\d{4}",MM:"\\d{2}",dd:"\\d{2}",HH:"\\d{2}",mm:"\\d{2}",ss:"\\d{2}"},r=e;for(let[s,n]of Object.entries(t))r=r.replace(s,n);return r}async ensureS3ListingTable(e,t,r){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");let s=`${e}.${t}`,n=this.s3ListingCache.get(s),o=Date.now();if(n&&o-n.timestamp<this.config.s3ListingRefreshMs){F("Using cached S3 listing for %s",s);return}F("Refreshing S3 listing for %s",s);let l=r.table.StorageDescriptor?.Location;if(!l)throw new Error(`No storage location found for ${e}.${t}`);let a=(r.table.PartitionKeys||[]).map(h=>h.Name),f=await this.listS3Files(l,a);this.s3ListingCache.set(s,{timestamp:o,data:f}),await this.db.run(`CREATE OR REPLACE TABLE "${s}_s3_files" AS SELECT path FROM (VALUES ${f.map(h=>`('${h.path}')`).join(",")}) t(path);`);let u=await Promise.all(a.map(async h=>`${await this.getPartitionExtractor(h,r)} as ${h}`));await this.db.run(`CREATE OR REPLACE TABLE "${s}_s3_listing" AS SELECT path,  ${u.join(", ")} FROM "${s}_s3_files";`);for(let h of a)await this.db.run(`CREATE INDEX IF NOT EXISTS idx_${h} ON "${s}_s3_listing" (${h});`)}async getS3Locations(e,t,r){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");let s=await this.getTableMetadata(e,t);await this.ensureS3ListingTable(e,t,s);let o=`SELECT DISTINCT path FROM "${`${e}.${t}`}_s3_listing"`;return F(o),r?.sql&&(o+=` WHERE ${r.sql}`),(await this.db.runAndReadAll(o)).getRows().map(a=>String(a[0]))}async getFilteredS3Locations(e,t,r){return this.getS3Locations(e,t,{sql:r.join(" AND ")})}async createGlueTableFilesVarSql(e,t,r){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new U(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let n=`SELECT path FROM "${`${e}.${t}`}_s3_listing"`;return r&&r.length>0&&(n+=` WHERE ${r.join(" AND ")}`),`SET VARIABLE ${this.sqlTransformer?.getGlueTableFilesVarName(e,t)} = ( SELECT list(path) FROM (${n}));`}async convertGlueTableQuery(e){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new U(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=await this.getGlueTableViewSetupSql(e),r=await this.sqlTransformer.transformGlueTableQuery(e);return t.join("")+r}async getGlueTableViewSetupSql(e){if(this.db||await this.connect(),!this.db)throw new Error("DB not connected");if(this.sqlTransformer||(this.sqlTransformer=new U(this.db)),!this.sqlTransformer)throw new Error("SQL transformer not initialized");let t=[],r=await this.sqlTransformer.getQueryGlueTableRefs(e);F("Found Glue Table references: %O",r),await Promise.all(r.map(async({database:n,table:o})=>{F("Found Glue Table reference: %s",{database:n,table:o});let l=await this.getTableMetadata(n,o),a=`${n}.${o}`,f=l.table.StorageDescriptor?.Location;if(!f)throw new Error(`No storage location found for ${a}`);let u=(l.table.PartitionKeys||[]).map(m=>m.Name),h=await this.listS3Files(f,u);t.push(`CREATE OR REPLACE TABLE "${a}_s3_files" AS SELECT path FROM (VALUES ${h.map(m=>`('${m.path}')`).join(",")}) t(path);`);let d=await Promise.all(u.map(async m=>`${await this.getPartitionExtractor(m,l)} as ${m}`));t.push(`CREATE OR REPLACE TABLE "${a}_s3_listing" AS SELECT path, ${d.join(", ")} FROM "${a}_s3_files";`);for(let m of u)t.push(`CREATE INDEX IF NOT EXISTS idx_${m} ON "${a}_s3_listing" (${m});`);if(!this.sqlTransformer)throw new Error("SQL transformer not initialized");u=(l.table.PartitionKeys||[]).map(m=>m.Name);let c=await this.sqlTransformer.extractPartitionFilters(e,a,u),b=`SELECT list(path) FROM "${a}_s3_listing"`;c.length>0&&(b+=` WHERE ${c.join(" AND ")}`);let p=this.sqlTransformer.getQueryFilesVarName(n,o);t.push(`SET VARIABLE ${p} = (${b});`);let E=await this.createGlueTableFilesVarSql(n,o);E&&t.push(E);let g=await this.sqlTransformer.getGlueTableViewSql(e);t.push(...g)}));let s=t.map(n=>n.trim());return F(s),s}};export{Ee as GlueTableCache};
